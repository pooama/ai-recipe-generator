import { existsSync as _existsSync } from 'fs';
import _fsp from 'fs/promises';
import { execa as _execa } from 'execa';
import * as _path from 'path';
import { LogLevel } from '../printer/printer.js';
import { printer } from '../printer.js';
import { executeWithDebugLogger as _executeWithDebugLogger } from './execute_with_debugger_logger.js';
import { getPackageManagerRunnerName } from './get_package_manager_name.js';
/**
 * PackageManagerController is an abstraction around package manager commands that are needed to initialize a project and install dependencies
 */
export class PackageManagerControllerBase {
    cwd;
    executable;
    initDefault;
    installCommand;
    fsp;
    path;
    execa;
    executeWithDebugLogger;
    existsSync;
    binaryRunner;
    /**
     * constructor - sets the project root
     */
    constructor(cwd, executable, initDefault, installCommand, fsp = _fsp, path = _path, execa = _execa, executeWithDebugLogger = _executeWithDebugLogger, existsSync = _existsSync) {
        this.cwd = cwd;
        this.executable = executable;
        this.initDefault = initDefault;
        this.installCommand = installCommand;
        this.fsp = fsp;
        this.path = path;
        this.execa = execa;
        this.executeWithDebugLogger = executeWithDebugLogger;
        this.existsSync = existsSync;
        this.binaryRunner = getPackageManagerRunnerName();
    }
    /**
     * installDependencies - installs dependencies in the project root
     */
    async installDependencies(packageNames, type) {
        const args = [`${this.installCommand}`].concat(...packageNames);
        if (type === 'dev') {
            args.push('-D');
        }
        await this.executeWithDebugLogger(this.cwd, this.executable, args, this.execa);
    }
    /**
     * initializeProject - initializes a project in the project root by checking the package.json file
     */
    initializeProject = async () => {
        if (this.packageJsonExists(this.cwd)) {
            // if package.json already exists, no need to do anything
            return;
        }
        printer.log(`No package.json file found in the current directory. Running \`${this.executable} init\`...`, LogLevel.DEBUG);
        try {
            await this.executeWithDebugLogger(this.cwd, this.executable, this.initDefault, this.execa);
        }
        catch {
            throw new Error(`\`${this.executable} init\` did not exit successfully. Initialize a valid JavaScript package before continuing.`);
        }
        if (!this.packageJsonExists(this.cwd)) {
            // this should only happen if the customer exits out of npm init before finishing
            throw new Error(`package.json does not exist after running \`${this.executable} init\`. Initialize a valid JavaScript package before continuing.'`);
        }
    };
    /**
     * initializeTsConfig - initializes a tsconfig.json file in the project root
     *
     * When changing this method, double check if a corresponding change is needed in the integration test setup in `setup_dir_as_esm_module.ts`.
     */
    async initializeTsConfig(targetDir) {
        const tsConfigTemplate = {
            compilerOptions: {
                target: 'es2022',
                module: 'es2022',
                moduleResolution: 'bundler',
                resolveJsonModule: true,
                esModuleInterop: true,
                forceConsistentCasingInFileNames: true,
                strict: true,
                skipLibCheck: true,
                // The path here is coupled with backend-function's generated typedef file path
                paths: { '$amplify/*': ['../.amplify/generated/*'] },
            },
        };
        const tsConfigPath = this.path.resolve(targetDir, 'tsconfig.json');
        await this.fsp.writeFile(tsConfigPath, JSON.stringify(tsConfigTemplate, null, 2), 'utf-8');
    }
    /**
     * runWithPackageManager - Factory function that runs a command with the specified package manager's binary runner
     */
    runWithPackageManager(args = [], dir, options) {
        return this.executeWithDebugLogger(dir, this.binaryRunner, args, this.execa, options);
    }
    getCommand = (args) => `${this.binaryRunner} ${args.join(' ')}`;
    /**
     * allowsSignalPropagation - Determines if the package manager allows the process
     * signals such as SIGINT to be propagated to the underlying node process.
     * @deprecated
     */
    allowsSignalPropagation = () => true;
    /**
     * Check if a package.json file exists in projectRoot
     */
    packageJsonExists = (projectRoot) => {
        return this.existsSync(this.path.resolve(projectRoot, 'package.json'));
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZV9tYW5hZ2VyX2NvbnRyb2xsZXJfYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYWNrYWdlLW1hbmFnZXItY29udHJvbGxlci9wYWNrYWdlX21hbmFnZXJfY29udHJvbGxlcl9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLElBQUksV0FBVyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQy9DLE9BQU8sSUFBSSxNQUFNLGFBQWEsQ0FBQztBQUMvQixPQUFPLEVBQUUsS0FBSyxJQUFJLE1BQU0sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUN4QyxPQUFPLEtBQUssS0FBSyxNQUFNLE1BQU0sQ0FBQztBQU05QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsc0JBQXNCLElBQUksdUJBQXVCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUU1RTs7R0FFRztBQUNILE1BQU0sT0FBZ0IsNEJBQTRCO0lBUTNCO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQWJGLFlBQVksQ0FBUztJQUN4Qzs7T0FFRztJQUNILFlBQ3FCLEdBQVcsRUFDWCxVQUFrQixFQUNsQixXQUFxQixFQUNyQixjQUFzQixFQUN0QixNQUFNLElBQUksRUFDVixPQUFPLEtBQUssRUFDWixRQUFRLE1BQU0sRUFDZCx5QkFBeUIsdUJBQXVCLEVBQ2hELGFBQWEsV0FBVztRQVJ4QixRQUFHLEdBQUgsR0FBRyxDQUFRO1FBQ1gsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUNsQixnQkFBVyxHQUFYLFdBQVcsQ0FBVTtRQUNyQixtQkFBYyxHQUFkLGNBQWMsQ0FBUTtRQUN0QixRQUFHLEdBQUgsR0FB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QUFDLEtBQUssRUFDVixPQUFPLENBQ1IsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVLEdBQUcsQ0FBQyxJQUFjLEVBQUUsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7SUFFMUU7Ozs7T0FJRztJQUNILHVCQUF1QixHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztJQUVyQzs7T0FFRztJQUNLLGlCQUFpQixHQUFHLENBQUMsV0FBbUIsRUFBVyxFQUFFO1FBQzNELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4aXN0c1N5bmMgYXMgX2V4aXN0c1N5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgX2ZzcCBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBleGVjYSBhcyBfZXhlY2EgfSBmcm9tICdleGVjYSc7XG5pbXBvcnQgKiBhcyBfcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7XG4gIEV4ZWNhQ2hpbGRQcm9jZXNzLFxuICBFeGVjYU9wdGlvbnMsXG4gIHR5cGUgUGFja2FnZU1hbmFnZXJDb250cm9sbGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IExvZ0xldmVsIH0gZnJvbSAnLi4vcHJpbnRlci9wcmludGVyLmpzJztcbmltcG9ydCB7IHByaW50ZXIgfSBmcm9tICcuLi9wcmludGVyLmpzJztcbmltcG9ydCB7IGV4ZWN1dGVXaXRoRGVidWdMb2dnZXIgYXMgX2V4ZWN1dGVXaXRoRGVidWdMb2dnZXIgfSBmcm9tICcuL2V4ZWN1dGVfd2l0aF9kZWJ1Z2dlcl9sb2dnZXIuanMnO1xuaW1wb3J0IHsgZ2V0UGFja2FnZU1hbmFnZXJSdW5uZXJOYW1lIH0gZnJvbSAnLi9nZXRfcGFja2FnZV9tYW5hZ2VyX25hbWUuanMnO1xuXG4vKipcbiAqIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlciBpcyBhbiBhYnN0cmFjdGlvbiBhcm91bmQgcGFja2FnZSBtYW5hZ2VyIGNvbW1hbmRzIHRoYXQgYXJlIG5lZWRlZCB0byBpbml0aWFsaXplIGEgcHJvamVjdCBhbmQgaW5zdGFsbCBkZXBlbmRlbmNpZXNcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlckJhc2VcbiAgaW1wbGVtZW50cyBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXJcbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGJpbmFyeVJ1bm5lcjogc3RyaW5nO1xuICAvKipcbiAgICogY29uc3RydWN0b3IgLSBzZXRzIHRoZSBwcm9qZWN0IHJvb3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCByZWFkb25seSBjd2Q6IHN0cmluZyxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhlY3V0YWJsZTogc3RyaW5nLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBpbml0RGVmYXVsdDogc3RyaW5nW10sXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGluc3RhbGxDb21tYW5kOiBzdHJpbmcsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGZzcCA9IF9mc3AsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IHBhdGggPSBfcGF0aCxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhlY2EgPSBfZXhlY2EsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGV4ZWN1dGVXaXRoRGVidWdMb2dnZXIgPSBfZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcixcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZXhpc3RzU3luYyA9IF9leGlzdHNTeW5jXG4gICkge1xuICAgIHRoaXMuYmluYXJ5UnVubmVyID0gZ2V0UGFja2FnZU1hbmFnZXJSdW5uZXJOYW1lKCk7XG4gIH1cblxuICAvKipcbiAgICogaW5zdGFsbERlcGVuZGVuY2llcyAtIGluc3RhbGxzIGRlcGVuZGVuY2llcyBpbiB0aGUgcHJvamVjdCByb290XG4gICAqL1xuICBhc3luYyBpbnN0YWxsRGVwZW5kZW5jaWVzKFxuICAgIHBhY2thZ2VOYW1lczogc3RyaW5nW10sXG4gICAgdHlwZTogJ2RldicgfCAncHJvZCdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYXJncyA9IFtgJHt0aGlzLmluc3RhbGxDb21tYW5kfWBdLmNvbmNhdCguLi5wYWNrYWdlTmFtZXMpO1xuICAgIGlmICh0eXBlID09PSAnZGV2Jykge1xuICAgICAgYXJncy5wdXNoKCctRCcpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcihcbiAgICAgIHRoaXMuY3dkLFxuICAgICAgdGhpcy5leGVjdXRhYmxlLFxuICAgICAgYXJncyxcbiAgICAgIHRoaXMuZXhlY2FcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIGluaXRpYWxpemVQcm9qZWN0IC0gaW5pdGlhbGl6ZXMgYSBwcm9qZWN0IGluIHRoZSBwcm9qZWN0IHJvb3QgYnkgY2hlY2tpbmcgdGhlIHBhY2thZ2UuanNvbiBmaWxlXG4gICAqL1xuICBpbml0aWFsaXplUHJvamVjdCA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAodGhpcy5wYWNrYWdlSnNvbkV4aXN0cyh0aGlzLmN3ZCkpIHtcbiAgICAgIC8vIGlmIHBhY2thZ2UuanNvbiBhbHJlYWR5IGV4aXN0cywgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHByaW50ZXIubG9nKFxuICAgICAgYE5vIHBhY2thZ2UuanNvbiBmaWxlIGZvdW5kIGluIHRoZSBjdXJyZW50IGRpcmVjdG9yeS4gUnVubmluZyBcXGAke3RoaXMuZXhlY3V0YWJsZX0gaW5pdFxcYC4uLmAsXG4gICAgICBMb2dMZXZlbC5ERUJVR1xuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlV2l0aERlYnVnTG9nZ2VyKFxuICAgICAgICB0aGlzLmN3ZCxcbiAgICAgICAgdGhpcy5leGVjdXRhYmxlLFxuICAgICAgICB0aGlzLmluaXREZWZhdWx0LFxuICAgICAgICB0aGlzLmV4ZWNhXG4gICAgICApO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgXFxgJHt0aGlzLmV4ZWN1dGFibGV9IGluaXRcXGAgZGlkIG5vdCBleGl0IHN1Y2Nlc3NmdWxseS4gSW5pdGlhbGl6ZSBhIHZhbGlkIEphdmFTY3JpcHQgcGFja2FnZSBiZWZvcmUgY29udGludWluZy5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wYWNrYWdlSnNvbkV4aXN0cyh0aGlzLmN3ZCkpIHtcbiAgICAgIC8vIHRoaXMgc2hvdWxkIG9ubHkgaGFwcGVuIGlmIHRoZSBjdXN0b21lciBleGl0cyBvdXQgb2YgbnBtIGluaXQgYmVmb3JlIGZpbmlzaGluZ1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcGFja2FnZS5qc29uIGRvZXMgbm90IGV4aXN0IGFmdGVyIHJ1bm5pbmcgXFxgJHt0aGlzLmV4ZWN1dGFibGV9IGluaXRcXGAuIEluaXRpYWxpemUgYSB2YWxpZCBKYXZhU2NyaXB0IHBhY2thZ2UgYmVmb3JlIGNvbnRpbnVpbmcuJ2BcbiAgICAgICk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBpbml0aWFsaXplVHNDb25maWcgLSBpbml0aWFsaXplcyBhIHRzY29uZmlnLmpzb24gZmlsZSBpbiB0aGUgcHJvamVjdCByb290XG4gICAqXG4gICAqIFdoZW4gY2hhbmdpbmcgdGhpcyBtZXRob2QsIGRvdWJsZSBjaGVjayBpZiBhIGNvcnJlc3BvbmRpbmcgY2hhbmdlIGlzIG5lZWRlZCBpbiB0aGUgaW50ZWdyYXRpb24gdGVzdCBzZXR1cCBpbiBgc2V0dXBfZGlyX2FzX2VzbV9tb2R1bGUudHNgLlxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZVRzQ29uZmlnKHRhcmdldERpcjogc3RyaW5nKSB7XG4gICAgY29uc3QgdHNDb25maWdUZW1wbGF0ZSA9IHtcbiAgICAgIGNvbXBpbGVyT3B0aW9uczoge1xuICAgICAgICB0YXJnZXQ6ICdlczIwMjInLFxuICAgICAgICBtb2R1bGU6ICdlczIwMjInLFxuICAgICAgICBtb2R1bGVSZXNvbHV0aW9uOiAnYnVuZGxlcicsXG4gICAgICAgIHJlc29sdmVKc29uTW9kdWxlOiB0cnVlLFxuICAgICAgICBlc01vZHVsZUludGVyb3A6IHRydWUsXG4gICAgICAgIGZvcmNlQ29uc2lzdGVudENhc2luZ0luRmlsZU5hbWVzOiB0cnVlLFxuICAgICAgICBzdHJpY3Q6IHRydWUsXG4gICAgICAgIHNraXBMaWJDaGVjazogdHJ1ZSxcbiAgICAgICAgLy8gVGhlIHBhdGggaGVyZSBpcyBjb3VwbGVkIHdpdGggYmFja2VuZC1mdW5jdGlvbidzIGdlbmVyYXRlZCB0eXBlZGVmIGZpbGUgcGF0aFxuICAgICAgICBwYXRoczogeyAnJGFtcGxpZnkvKic6IFsnLi4vLmFtcGxpZnkvZ2VuZXJhdGVkLyonXSB9LFxuICAgICAgfSxcbiAgICB9O1xuICAgIGNvbnN0IHRzQ29uZmlnUGF0aCA9IHRoaXMucGF0aC5yZXNvbHZlKHRhcmdldERpciwgJ3RzY29uZmlnLmpzb24nKTtcbiAgICBhd2FpdCB0aGlzLmZzcC53cml0ZUZpbGUoXG4gICAgICB0c0NvbmZpZ1BhdGgsXG4gICAgICBKU09OLnN0cmluZ2lmeSh0c0NvbmZpZ1RlbXBsYXRlLCBudWxsLCAyKSxcbiAgICAgICd1dGYtOCdcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIHJ1bldpdGhQYWNrYWdlTWFuYWdlciAtIEZhY3RvcnkgZnVuY3Rpb24gdGhhdCBydW5zIGEgY29tbWFuZCB3aXRoIHRoZSBzcGVjaWZpZWQgcGFja2FnZSBtYW5hZ2VyJ3MgYmluYXJ5IHJ1bm5lclxuICAgKi9cbiAgcnVuV2l0aFBhY2thZ2VNYW5hZ2VyKFxuICAgIGFyZ3M6IHN0cmluZ1tdID0gW10sXG4gICAgZGlyOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEV4ZWNhT3B0aW9uc1xuICApOiBFeGVjYUNoaWxkUHJvY2VzcyB7XG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZVdpdGhEZWJ1Z0xvZ2dlcihcbiAgICAgIGRpcixcbiAgICAgIHRoaXMuYmluYXJ5UnVubmVyLFxuICAgICAgYXJncyxcbiAgICAgIHRoaXMuZXhlY2EsXG4gICAgICBvcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIGdldENvbW1hbmQgPSAoYXJnczogc3RyaW5nW10pID0+IGAke3RoaXMuYmluYXJ5UnVubmVyfSAke2FyZ3Muam9pbignICcpfWA7XG5cbiAgLyoqXG4gICAqIGFsbG93c1NpZ25hbFByb3BhZ2F0aW9uIC0gRGV0ZXJtaW5lcyBpZiB0aGUgcGFja2FnZSBtYW5hZ2VyIGFsbG93cyB0aGUgcHJvY2Vzc1xuICAgKiBzaWduYWxzIHN1Y2ggYXMgU0lHSU5UIHRvIGJlIHByb3BhZ2F0ZWQgdG8gdGhlIHVuZGVybHlpbmcgbm9kZSBwcm9jZXNzLlxuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgYWxsb3dzU2lnbmFsUHJvcGFnYXRpb24gPSAoKSA9PiB0cnVlO1xuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhIHBhY2thZ2UuanNvbiBmaWxlIGV4aXN0cyBpbiBwcm9qZWN0Um9vdFxuICAgKi9cbiAgcHJpdmF0ZSBwYWNrYWdlSnNvbkV4aXN0cyA9IChwcm9qZWN0Um9vdDogc3RyaW5nKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuZXhpc3RzU3luYyh0aGlzLnBhdGgucmVzb2x2ZShwcm9qZWN0Um9vdCwgJ3BhY2thZ2UuanNvbicpKTtcbiAgfTtcbn1cbiJdfQ==