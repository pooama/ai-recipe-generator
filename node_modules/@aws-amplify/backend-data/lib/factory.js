import { AmplifyData, AmplifyDynamoDbTableWrapper, } from '@aws-amplify/data-construct';
import { generateModelsSync } from '@aws-amplify/graphql-generator';
import * as path from 'path';
import { combineCDKSchemas, convertSchemaToCDK, isCombinedSchema, isDataSchema, } from './convert_schema.js';
import { convertFunctionNameMapToCDK } from './convert_functions.js';
import { buildConstructFactoryProvidedAuthConfig, convertAuthorizationModesToCDK, isUsingDefaultApiKeyAuth, } from './convert_authorization_modes.js';
import { validateAuthorizationModes } from './validate_authorization_modes.js';
import { AmplifyError, AmplifyUserError, CDKContextKey, TagName, } from '@aws-amplify/platform-core';
import { Aspects, RemovalPolicy, Tags } from 'aws-cdk-lib';
import { convertJsResolverDefinition } from './convert_js_resolvers.js';
import { AppSyncPolicyGenerator } from './app_sync_policy_generator.js';
import { Bucket } from 'aws-cdk-lib/aws-s3';
import { BucketDeployment, Source } from 'aws-cdk-lib/aws-s3-deployment';
const modelIntrospectionSchemaKey = 'modelIntrospectionSchema.json';
/**
 * Singleton factory for AmplifyGraphqlApi constructs that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class DataFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    generator;
    /**
     * Create a new AmplifyConstruct
     */
    constructor(props, importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (DataFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineData` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineData` call',
            });
        }
        DataFactory.factoryCount++;
    }
    /**
     * Gets an instance of the Data construct
     */
    getInstance = (props) => {
        const { constructContainer, outputStorageStrategy, importPathVerifier, resourceNameValidator, } = props;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'data', 'resource'), 'Amplify Data must be defined in amplify/data/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new DataGenerator(this.props, buildConstructFactoryProvidedAuthConfig(props.constructContainer
                .getConstructFactory('AuthResources')
                ?.getInstance(props)), props, outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class DataGenerator {
    props;
    providedAuthConfig;
    getInstanceProps;
    outputStorageStrategy;
    resourceGroupName = 'data';
    name;
    constructor(props, providedAuthConfig, getInstanceProps, outputStorageStrategy) {
        this.props = props;
        this.providedAuthConfig = providedAuthConfig;
        this.getInstanceProps = getInstanceProps;
        this.outputStorageStrategy = outputStorageStrategy;
        this.name = props.name ?? 'amplifyData';
    }
    generateContainerEntry = ({ scope, ssmEnvironmentEntriesGenerator, backendSecretResolver, stableBackendIdentifiers, }) => {
        const amplifyGraphqlDefinitions = [];
        const schemasJsFunctions = [];
        const schemasFunctionSchemaAccess = [];
        let schemasLambdaFunctions = {};
        try {
            const schemas = isCombinedSchema(this.props.schema)
                ? this.props.schema.schemas
                : [this.props.schema];
            schemas.forEach((schema) => {
                if (isDataSchema(schema)) {
                    const { jsFunctions, functionSchemaAccess, lambdaFunctions } = schema.transform();
                    schemasJsFunctions.push(...jsFunctions);
                    schemasFunctionSchemaAccess.push(...functionSchemaAccess);
                    schemasLambdaFunctions = {
                        ...schemasLambdaFunctions,
                        ...lambdaFunctions,
                    };
                }
                amplifyGraphqlDefinitions.push(convertSchemaToCDK(schema, backendSecretResolver, stableBackendIdentifiers));
            });
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to parse schema definition.',
                resolution: 'Check your data schema definition for syntax and type errors.',
            }, error instanceof Error ? error : undefined);
        }
        let authorizationModes;
        try {
            authorizationModes = convertAuthorizationModesToCDK(this.getInstanceProps, this.providedAuthConfig, this.props.authorizationModes);
        }
        catch (error) {
            if (AmplifyError.isAmplifyError(error)) {
                throw error;
            }
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to parse authorization modes.',
                resolution: 'Ensure the auth rules on your schema are valid.',
            }, error instanceof Error ? error : undefined);
        }
        try {
            validateAuthorizationModes(this.props.authorizationModes, authorizationModes);
        }
        catch (error) {
            throw new AmplifyUserError('InvalidSchemaAuthError', {
                message: error instanceof Error
                    ? error.message
                    : 'Failed to validate authorization modes',
                resolution: 'Ensure the auth rules on your schema are valid.',
            }, error instanceof Error ? error : undefined);
        }
        const sandboxModeEnabled = isUsingDefaultApiKeyAuth(this.providedAuthConfig, this.props.authorizationModes);
        const propsFunctions = this.props.functions ?? {};
        const functionNameMap = convertFunctionNameMapToCDK(this.getInstanceProps, {
            ...propsFunctions,
            ...schemasLambdaFunctions,
        });
        let amplifyApi = undefined;
        let modelIntrospectionSchema = undefined;
        const isSandboxDeployment = scope.node.tryGetContext(CDKContextKey.DEPLOYMENT_TYPE) === 'sandbox';
        try {
            const combinedSchema = combineCDKSchemas(amplifyGraphqlDefinitions);
            modelIntrospectionSchema = generateModelsSync({
                schema: combinedSchema.schema,
                target: 'introspection',
            })['model-introspection.json'];
            amplifyApi = new AmplifyData(scope, this.name, {
                apiName: this.name,
                definition: combinedSchema,
                authorizationModes,
                outputStorageStrategy: this.outputStorageStrategy,
                functionNameMap,
                translationBehavior: {
                    sandboxModeEnabled,
                    /**
                     * The destructive updates should be always allowed in backend definition and not to be controlled on the IaC
                     * The CI/CD check should take the responsibility to validate if any tables are being replaced and determine whether to execute the changeset
                     */
                    allowDestructiveGraphqlSchemaUpdates: true,
                    _provisionHotswapFriendlyResources: isSandboxDeployment,
                },
            });
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyDataConstructInitializationError', {
                message: 'Failed to instantiate data construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        const modelIntrospectionSchemaBucket = new Bucket(scope, 'modelIntrospectionSchemaBucket', {
            enforceSSL: true,
            autoDeleteObjects: true,
            removalPolicy: RemovalPolicy.DESTROY,
        });
        new BucketDeployment(scope, 'modelIntrospectionSchemaBucketDeployment', {
            // See https://github.com/aws-amplify/amplify-category-api/pull/1939
            memoryLimit: 1536,
            destinationBucket: modelIntrospectionSchemaBucket,
            sources: [
                Source.data(modelIntrospectionSchemaKey, modelIntrospectionSchema),
            ],
        });
        Tags.of(amplifyApi).add(TagName.FRIENDLY_NAME, this.name);
        /**;
         * Enable the table replacement upon GSI update
         * This is allowed in sandbox mode ONLY
         */
        if (isSandboxDeployment) {
            Aspects.of(amplifyApi).add(new ReplaceTableUponGsiUpdateOverrideAspect());
        }
        convertJsResolverDefinition(scope, amplifyApi, schemasJsFunctions);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_GRAPHQL_ENDPOINT`]: amplifyApi.resources.cfnResources.cfnGraphqlApi.attrGraphQlUrl,
            [`${this.name}_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME`]: modelIntrospectionSchemaBucket.bucketName,
            [`${this.name}_MODEL_INTROSPECTION_SCHEMA_KEY`]: modelIntrospectionSchemaKey,
        });
        const policyGenerator = new AppSyncPolicyGenerator(amplifyApi.resources.graphqlApi, `${modelIntrospectionSchemaBucket.bucketArn}/${modelIntrospectionSchemaKey}`);
        schemasFunctionSchemaAccess.forEach((accessDefinition) => {
            const policy = policyGenerator.generateGraphqlAccessPolicy(accessDefinition.actions);
            accessDefinition.resourceProvider
                .getInstance(this.getInstanceProps)
                .getResourceAccessAcceptor()
                .acceptResourceAccess(policy, ssmEnvironmentEntries);
        });
        return amplifyApi;
    };
}
const REPLACE_TABLE_UPON_GSI_UPDATE_ATTRIBUTE_NAME = 'replaceTableUponGsiUpdate';
/**
 * Aspect class to modify the amplify managed DynamoDB table
 * to allow table replacement upon GSI update
 */
class ReplaceTableUponGsiUpdateOverrideAspect {
    visit(scope) {
        if (AmplifyDynamoDbTableWrapper.isAmplifyDynamoDbTableResource(scope)) {
            // These value setters are not exposed in the wrapper
            // Need to use the property override to escape the hatch
            scope.addPropertyOverride(REPLACE_TABLE_UPON_GSI_UPDATE_ATTRIBUTE_NAME, true);
        }
    }
}
/**
 * Creates a factory that implements ConstructFactory<AmplifyGraphqlApi>
 */
export const defineData = (props) => new DataFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWFBLE9BQU8sRUFDTCxXQUFXLEVBQ1gsMkJBQTJCLEdBRzVCLE1BQU0sNkJBQTZCLENBQUM7QUFFckMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDcEUsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFFN0IsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixrQkFBa0IsRUFDbEIsZ0JBQWdCLEVBQ2hCLFlBQVksR0FDYixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3JFLE9BQU8sRUFFTCx1Q0FBdUMsRUFDdkMsOEJBQThCLEVBQzlCLHdCQUF3QixHQUN6QixNQUFNLGtDQUFrQyxDQUFDO0FBQzFDLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9FLE9BQU8sRUFDTCxZQUFZLEVBQ1osZ0JBQWdCLEVBQ2hCLGFBQWEsRUFDYixPQUFPLEdBQ1IsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsT0FBTyxFQUFXLGFBQWEsRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEUsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFLeEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV6RSxNQUFNLDJCQUEyQixHQUFHLCtCQUErQixDQUFDO0FBRXBFOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sV0FBVztJQVVIO0lBQ0E7SUFWbkIsZ0RBQWdE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MkIsQ0FDeEQsZ0JBQWdCLENBQUMsT0FBTyxDQUN6QixDQUFDO1lBQ0YsZ0JBQWdCLENBQUMsZ0JBQWdCO2lCQUM5QixXQUFXLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO2lCQUNsQyx5QkFBeUIsRUFBRTtpQkFDM0Isb0JBQW9CLENBQUMsTUFBTSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDekQsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0sNENBQTRDLEdBQ2hELDJCQUEyQixDQUFDO0FBRTlCOzs7R0FHRztBQUNILE1BQU0sdUNBQXVDO0lBQ3BDLEtBQUssQ0FBQyxLQUFpQjtRQUM1QixJQUFJLDJCQUEyQixDQUFDLDhCQUE4QixDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JFLHFEQUFxRDtZQUNyRCx3REFBd0Q7WUFDeEQsS0FBSyxDQUFDLG1CQUFtQixDQUN2Qiw0Q0FBNEMsRUFDNUMsSUFBSSxDQUNMLENBQUM7U0FDSDtJQUNILENBQUM7Q0FDRjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBZ0IsRUFBaUMsRUFBRSxDQUM1RSxJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlGdW5jdGlvbixcbiAgQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lLFxuICBBdXRoUmVzb3VyY2VzLFxuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcixcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgUmVmZXJlbmNlQXV0aFJlc291cmNlcyxcbiAgUmVzb3VyY2VQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5RGF0YSxcbiAgQW1wbGlmeUR5bmFtb0RiVGFibGVXcmFwcGVyLFxuICBJQW1wbGlmeURhdGFEZWZpbml0aW9uLFxuICBUcmFuc2xhdGlvbkJlaGF2aW9yLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGF0YS1jb25zdHJ1Y3QnO1xuaW1wb3J0IHsgR3JhcGhxbE91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IGdlbmVyYXRlTW9kZWxzU3luYyB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9ncmFwaHFsLWdlbmVyYXRvcic7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQW1wbGlmeURhdGFFcnJvciwgRGF0YVByb3BzIH0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQge1xuICBjb21iaW5lQ0RLU2NoZW1hcyxcbiAgY29udmVydFNjaGVtYVRvQ0RLLFxuICBpc0NvbWJpbmVkU2NoZW1hLFxuICBpc0RhdGFTY2hlbWEsXG59IGZyb20gJy4vY29udmVydF9zY2hlbWEuanMnO1xuaW1wb3J0IHsgY29udmVydEZ1bmN0aW9uTmFtZU1hcFRvQ0RLIH0gZnJvbSAnLi9jb252ZXJ0X2Z1bmN0aW9ucy5qcyc7XG5pbXBvcnQge1xuICBQcm92aWRlZEF1dGhDb25maWcsXG4gIGJ1aWxkQ29uc3RydWN0RmFjdG9yeVByb3ZpZGVkQXV0aENvbmZpZyxcbiAgY29udmVydEF1dGhvcml6YXRpb25Nb2Rlc1RvQ0RLLFxuICBpc1VzaW5nRGVmYXVsdEFwaUtleUF1dGgsXG59IGZyb20gJy4vY29udmVydF9hdXRob3JpemF0aW9uX21vZGVzLmpzJztcbmltcG9ydCB7IHZhbGlkYXRlQXV0aG9yaXphdGlvbk1vZGVzIH0gZnJvbSAnLi92YWxpZGF0ZV9hdXRob3JpemF0aW9uX21vZGVzLmpzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlFcnJvcixcbiAgQW1wbGlmeVVzZXJFcnJvcixcbiAgQ0RLQ29udGV4dEtleSxcbiAgVGFnTmFtZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgQXNwZWN0cywgSUFzcGVjdCwgUmVtb3ZhbFBvbGljeSwgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IGNvbnZlcnRKc1Jlc29sdmVyRGVmaW5pdGlvbiB9IGZyb20gJy4vY29udmVydF9qc19yZXNvbHZlcnMuanMnO1xuaW1wb3J0IHsgQXBwU3luY1BvbGljeUdlbmVyYXRvciB9IGZyb20gJy4vYXBwX3N5bmNfcG9saWN5X2dlbmVyYXRvci5qcyc7XG5pbXBvcnQge1xuICBGdW5jdGlvblNjaGVtYUFjY2VzcyxcbiAgSnNSZXNvbHZlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RhdGEtc2NoZW1hLXR5cGVzJztcbmltcG9ydCB7IEJ1Y2tldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBCdWNrZXREZXBsb3ltZW50LCBTb3VyY2UgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMtZGVwbG95bWVudCc7XG5cbmNvbnN0IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUtleSA9ICdtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEuanNvbic7XG5cbi8qKlxuICogU2luZ2xldG9uIGZhY3RvcnkgZm9yIEFtcGxpZnlHcmFwaHFsQXBpIGNvbnN0cnVjdHMgdGhhdCBjYW4gYmUgdXNlZCBpbiBBbXBsaWZ5IHByb2plY3QgZmlsZXMuXG4gKlxuICogRXhwb3J0ZWQgZm9yIHRlc3RpbmcgcHVycG9zZSBvbmx5ICYgc2hvdWxkIE5PVCBiZSBleHBvcnRlZCBvdXQgb2YgdGhlIHBhY2thZ2UuXG4gKi9cbmV4cG9ydCBjbGFzcyBEYXRhRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeURhdGE+IHtcbiAgLy8gcHVibGljbHkgYWNjZXNzaWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlIG9ubHkuXG4gIHN0YXRpYyBmYWN0b3J5Q291bnQgPSAwO1xuXG4gIHByaXZhdGUgZ2VuZXJhdG9yOiBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcjtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlDb25zdHJ1Y3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IERhdGFQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGltcG9ydFN0YWNrID0gbmV3IEVycm9yKCkuc3RhY2tcbiAgKSB7XG4gICAgaWYgKERhdGFGYWN0b3J5LmZhY3RvcnlDb3VudCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdNdWx0aXBsZVNpbmdsZXRvblJlc291cmNlc0Vycm9yJywge1xuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdNdWx0aXBsZSBgZGVmaW5lRGF0YWAgY2FsbHMgYXJlIG5vdCBhbGxvd2VkIHdpdGhpbiBhbiBBbXBsaWZ5IGJhY2tlbmQnLFxuICAgICAgICByZXNvbHV0aW9uOiAnUmVtb3ZlIGFsbCBidXQgb25lIGBkZWZpbmVEYXRhYCBjYWxsJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICBEYXRhRmFjdG9yeS5mYWN0b3J5Q291bnQrKztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGFuIGluc3RhbmNlIG9mIHRoZSBEYXRhIGNvbnN0cnVjdFxuICAgKi9cbiAgZ2V0SW5zdGFuY2UgPSAocHJvcHM6IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeURhdGEgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgIGNvbnN0cnVjdENvbnRhaW5lcixcbiAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgIGltcG9ydFBhdGhWZXJpZmllcixcbiAgICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgICB9ID0gcHJvcHM7XG4gICAgaW1wb3J0UGF0aFZlcmlmaWVyPy52ZXJpZnkoXG4gICAgICB0aGlzLmltcG9ydFN0YWNrLFxuICAgICAgcGF0aC5qb2luKCdhbXBsaWZ5JywgJ2RhdGEnLCAncmVzb3VyY2UnKSxcbiAgICAgICdBbXBsaWZ5IERhdGEgbXVzdCBiZSBkZWZpbmVkIGluIGFtcGxpZnkvZGF0YS9yZXNvdXJjZS50cydcbiAgICApO1xuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcj8udmFsaWRhdGUodGhpcy5wcm9wcy5uYW1lKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgRGF0YUdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5wcm9wcyxcbiAgICAgICAgYnVpbGRDb25zdHJ1Y3RGYWN0b3J5UHJvdmlkZWRBdXRoQ29uZmlnKFxuICAgICAgICAgIHByb3BzLmNvbnN0cnVjdENvbnRhaW5lclxuICAgICAgICAgICAgLmdldENvbnN0cnVjdEZhY3Rvcnk8XG4gICAgICAgICAgICAgIFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcyB8IFJlZmVyZW5jZUF1dGhSZXNvdXJjZXM+XG4gICAgICAgICAgICA+KCdBdXRoUmVzb3VyY2VzJylcbiAgICAgICAgICAgID8uZ2V0SW5zdGFuY2UocHJvcHMpXG4gICAgICAgICksXG4gICAgICAgIHByb3BzLFxuICAgICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3lcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBBbXBsaWZ5RGF0YTtcbiAgfTtcbn1cblxuY2xhc3MgRGF0YUdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZSA9ICdkYXRhJztcbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogRGF0YVByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvdmlkZWRBdXRoQ29uZmlnOiBQcm92aWRlZEF1dGhDb25maWcgfCB1bmRlZmluZWQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxHcmFwaHFsT3V0cHV0PlxuICApIHtcbiAgICB0aGlzLm5hbWUgPSBwcm9wcy5uYW1lID8/ICdhbXBsaWZ5RGF0YSc7XG4gIH1cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHtcbiAgICBzY29wZSxcbiAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIHN0YWJsZUJhY2tlbmRJZGVudGlmaWVycyxcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgY29uc3QgYW1wbGlmeUdyYXBocWxEZWZpbml0aW9uczogSUFtcGxpZnlEYXRhRGVmaW5pdGlvbltdID0gW107XG4gICAgY29uc3Qgc2NoZW1hc0pzRnVuY3Rpb25zOiBKc1Jlc29sdmVyW10gPSBbXTtcbiAgICBjb25zdCBzY2hlbWFzRnVuY3Rpb25TY2hlbWFBY2Nlc3M6IEZ1bmN0aW9uU2NoZW1hQWNjZXNzW10gPSBbXTtcbiAgICBsZXQgc2NoZW1hc0xhbWJkYUZ1bmN0aW9uczogUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5RnVuY3Rpb24+XG4gICAgPiA9IHt9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlbWFzID0gaXNDb21iaW5lZFNjaGVtYSh0aGlzLnByb3BzLnNjaGVtYSlcbiAgICAgICAgPyB0aGlzLnByb3BzLnNjaGVtYS5zY2hlbWFzXG4gICAgICAgIDogW3RoaXMucHJvcHMuc2NoZW1hXTtcblxuICAgICAgc2NoZW1hcy5mb3JFYWNoKChzY2hlbWEpID0+IHtcbiAgICAgICAgaWYgKGlzRGF0YVNjaGVtYShzY2hlbWEpKSB7XG4gICAgICAgICAgY29uc3QgeyBqc0Z1bmN0aW9ucywgZnVuY3Rpb25TY2hlbWFBY2Nlc3MsIGxhbWJkYUZ1bmN0aW9ucyB9ID1cbiAgICAgICAgICAgIHNjaGVtYS50cmFuc2Zvcm0oKTtcbiAgICAgICAgICBzY2hlbWFzSnNGdW5jdGlvbnMucHVzaCguLi5qc0Z1bmN0aW9ucyk7XG4gICAgICAgICAgc2NoZW1hc0Z1bmN0aW9uU2NoZW1hQWNjZXNzLnB1c2goLi4uZnVuY3Rpb25TY2hlbWFBY2Nlc3MpO1xuICAgICAgICAgIHNjaGVtYXNMYW1iZGFGdW5jdGlvbnMgPSB7XG4gICAgICAgICAgICAuLi5zY2hlbWFzTGFtYmRhRnVuY3Rpb25zLFxuICAgICAgICAgICAgLi4ubGFtYmRhRnVuY3Rpb25zLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBhbXBsaWZ5R3JhcGhxbERlZmluaXRpb25zLnB1c2goXG4gICAgICAgICAgY29udmVydFNjaGVtYVRvQ0RLKFxuICAgICAgICAgICAgc2NoZW1hLFxuICAgICAgICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgICAgICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yPEFtcGxpZnlEYXRhRXJyb3I+KFxuICAgICAgICAnSW52YWxpZFNjaGVtYUVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgICAgID8gZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgICA6ICdGYWlsZWQgdG8gcGFyc2Ugc2NoZW1hIGRlZmluaXRpb24uJyxcbiAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgJ0NoZWNrIHlvdXIgZGF0YSBzY2hlbWEgZGVmaW5pdGlvbiBmb3Igc3ludGF4IGFuZCB0eXBlIGVycm9ycy4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IGF1dGhvcml6YXRpb25Nb2RlcztcbiAgICB0cnkge1xuICAgICAgYXV0aG9yaXphdGlvbk1vZGVzID0gY29udmVydEF1dGhvcml6YXRpb25Nb2Rlc1RvQ0RLKFxuICAgICAgICB0aGlzLmdldEluc3RhbmNlUHJvcHMsXG4gICAgICAgIHRoaXMucHJvdmlkZWRBdXRoQ29uZmlnLFxuICAgICAgICB0aGlzLnByb3BzLmF1dGhvcml6YXRpb25Nb2Rlc1xuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKEFtcGxpZnlFcnJvci5pc0FtcGxpZnlFcnJvcihlcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcjxBbXBsaWZ5RGF0YUVycm9yPihcbiAgICAgICAgJ0ludmFsaWRTY2hlbWFBdXRoRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogJ0ZhaWxlZCB0byBwYXJzZSBhdXRob3JpemF0aW9uIG1vZGVzLicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ0Vuc3VyZSB0aGUgYXV0aCBydWxlcyBvbiB5b3VyIHNjaGVtYSBhcmUgdmFsaWQuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICB2YWxpZGF0ZUF1dGhvcml6YXRpb25Nb2RlcyhcbiAgICAgICAgdGhpcy5wcm9wcy5hdXRob3JpemF0aW9uTW9kZXMsXG4gICAgICAgIGF1dGhvcml6YXRpb25Nb2Rlc1xuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3I8QW1wbGlmeURhdGFFcnJvcj4oXG4gICAgICAgICdJbnZhbGlkU2NoZW1hQXV0aEVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgICAgID8gZXJyb3IubWVzc2FnZVxuICAgICAgICAgICAgICA6ICdGYWlsZWQgdG8gdmFsaWRhdGUgYXV0aG9yaXphdGlvbiBtb2RlcycsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ0Vuc3VyZSB0aGUgYXV0aCBydWxlcyBvbiB5b3VyIHNjaGVtYSBhcmUgdmFsaWQuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHNhbmRib3hNb2RlRW5hYmxlZCA9IGlzVXNpbmdEZWZhdWx0QXBpS2V5QXV0aChcbiAgICAgIHRoaXMucHJvdmlkZWRBdXRoQ29uZmlnLFxuICAgICAgdGhpcy5wcm9wcy5hdXRob3JpemF0aW9uTW9kZXNcbiAgICApO1xuXG4gICAgY29uc3QgcHJvcHNGdW5jdGlvbnMgPSB0aGlzLnByb3BzLmZ1bmN0aW9ucyA/PyB7fTtcblxuICAgIGNvbnN0IGZ1bmN0aW9uTmFtZU1hcCA9IGNvbnZlcnRGdW5jdGlvbk5hbWVNYXBUb0NESyh0aGlzLmdldEluc3RhbmNlUHJvcHMsIHtcbiAgICAgIC4uLnByb3BzRnVuY3Rpb25zLFxuICAgICAgLi4uc2NoZW1hc0xhbWJkYUZ1bmN0aW9ucyxcbiAgICB9KTtcbiAgICBsZXQgYW1wbGlmeUFwaSA9IHVuZGVmaW5lZDtcbiAgICBsZXQgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbiAgICBjb25zdCBpc1NhbmRib3hEZXBsb3ltZW50ID1cbiAgICAgIHNjb3BlLm5vZGUudHJ5R2V0Q29udGV4dChDREtDb250ZXh0S2V5LkRFUExPWU1FTlRfVFlQRSkgPT09ICdzYW5kYm94JztcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb21iaW5lZFNjaGVtYSA9IGNvbWJpbmVDREtTY2hlbWFzKGFtcGxpZnlHcmFwaHFsRGVmaW5pdGlvbnMpO1xuICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hID0gZ2VuZXJhdGVNb2RlbHNTeW5jKHtcbiAgICAgICAgc2NoZW1hOiBjb21iaW5lZFNjaGVtYS5zY2hlbWEsXG4gICAgICAgIHRhcmdldDogJ2ludHJvc3BlY3Rpb24nLFxuICAgICAgfSlbJ21vZGVsLWludHJvc3BlY3Rpb24uanNvbiddO1xuXG4gICAgICBhbXBsaWZ5QXBpID0gbmV3IEFtcGxpZnlEYXRhKHNjb3BlLCB0aGlzLm5hbWUsIHtcbiAgICAgICAgYXBpTmFtZTogdGhpcy5uYW1lLFxuICAgICAgICBkZWZpbml0aW9uOiBjb21iaW5lZFNjaGVtYSxcbiAgICAgICAgYXV0aG9yaXphdGlvbk1vZGVzLFxuICAgICAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgICAgICBmdW5jdGlvbk5hbWVNYXAsXG4gICAgICAgIHRyYW5zbGF0aW9uQmVoYXZpb3I6IHtcbiAgICAgICAgICBzYW5kYm94TW9kZUVuYWJsZWQsXG4gICAgICAgICAgLyoqXG4gICAgICAgICAgICogVGhlIGRlc3RydWN0aXZlIHVwZGF0ZXMgc2hvdWxkIGJlIGFsd2F5cyBhbGxvd2VkIGluIGJhY2tlbmQgZGVmaW5pdGlvbiBhbmQgbm90IHRvIGJlIGNvbnRyb2xsZWQgb24gdGhlIElhQ1xuICAgICAgICAgICAqIFRoZSBDSS9DRCBjaGVjayBzaG91bGQgdGFrZSB0aGUgcmVzcG9uc2liaWxpdHkgdG8gdmFsaWRhdGUgaWYgYW55IHRhYmxlcyBhcmUgYmVpbmcgcmVwbGFjZWQgYW5kIGRldGVybWluZSB3aGV0aGVyIHRvIGV4ZWN1dGUgdGhlIGNoYW5nZXNldFxuICAgICAgICAgICAqL1xuICAgICAgICAgIGFsbG93RGVzdHJ1Y3RpdmVHcmFwaHFsU2NoZW1hVXBkYXRlczogdHJ1ZSxcbiAgICAgICAgICBfcHJvdmlzaW9uSG90c3dhcEZyaWVuZGx5UmVzb3VyY2VzOiBpc1NhbmRib3hEZXBsb3ltZW50LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnQW1wbGlmeURhdGFDb25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgZGF0YSBjb25zdHJ1Y3QnLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUJ1Y2tldCA9IG5ldyBCdWNrZXQoXG4gICAgICBzY29wZSxcbiAgICAgICdtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFCdWNrZXQnLFxuICAgICAge1xuICAgICAgICBlbmZvcmNlU1NMOiB0cnVlLFxuICAgICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgfVxuICAgICk7XG4gICAgbmV3IEJ1Y2tldERlcGxveW1lbnQoc2NvcGUsICdtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFCdWNrZXREZXBsb3ltZW50Jywge1xuICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MtYW1wbGlmeS9hbXBsaWZ5LWNhdGVnb3J5LWFwaS9wdWxsLzE5MzlcbiAgICAgIG1lbW9yeUxpbWl0OiAxNTM2LFxuICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUJ1Y2tldCxcbiAgICAgIHNvdXJjZXM6IFtcbiAgICAgICAgU291cmNlLmRhdGEobW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hS2V5LCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEpLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIFRhZ3Mub2YoYW1wbGlmeUFwaSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgdGhpcy5uYW1lKTtcblxuICAgIC8qKjtcbiAgICAgKiBFbmFibGUgdGhlIHRhYmxlIHJlcGxhY2VtZW50IHVwb24gR1NJIHVwZGF0ZVxuICAgICAqIFRoaXMgaXMgYWxsb3dlZCBpbiBzYW5kYm94IG1vZGUgT05MWVxuICAgICAqL1xuICAgIGlmIChpc1NhbmRib3hEZXBsb3ltZW50KSB7XG4gICAgICBBc3BlY3RzLm9mKGFtcGxpZnlBcGkpLmFkZChuZXcgUmVwbGFjZVRhYmxlVXBvbkdzaVVwZGF0ZU92ZXJyaWRlQXNwZWN0KCkpO1xuICAgIH1cblxuICAgIGNvbnZlcnRKc1Jlc29sdmVyRGVmaW5pdGlvbihzY29wZSwgYW1wbGlmeUFwaSwgc2NoZW1hc0pzRnVuY3Rpb25zKTtcblxuICAgIGNvbnN0IHNzbUVudmlyb25tZW50RW50cmllcyA9XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IuZ2VuZXJhdGVTc21FbnZpcm9ubWVudEVudHJpZXMoe1xuICAgICAgICBbYCR7dGhpcy5uYW1lfV9HUkFQSFFMX0VORFBPSU5UYF06XG4gICAgICAgICAgYW1wbGlmeUFwaS5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmbkdyYXBocWxBcGkuYXR0ckdyYXBoUWxVcmwsXG4gICAgICAgIFtgJHt0aGlzLm5hbWV9X01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0JVQ0tFVF9OQU1FYF06XG4gICAgICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIFtgJHt0aGlzLm5hbWV9X01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0tFWWBdOlxuICAgICAgICAgIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUtleSxcbiAgICAgIH0pO1xuXG4gICAgY29uc3QgcG9saWN5R2VuZXJhdG9yID0gbmV3IEFwcFN5bmNQb2xpY3lHZW5lcmF0b3IoXG4gICAgICBhbXBsaWZ5QXBpLnJlc291cmNlcy5ncmFwaHFsQXBpLFxuICAgICAgYCR7bW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hQnVja2V0LmJ1Y2tldEFybn0vJHttb2RlbEludHJvc3BlY3Rpb25TY2hlbWFLZXl9YFxuICAgICk7XG5cbiAgICBzY2hlbWFzRnVuY3Rpb25TY2hlbWFBY2Nlc3MuZm9yRWFjaCgoYWNjZXNzRGVmaW5pdGlvbikgPT4ge1xuICAgICAgY29uc3QgcG9saWN5ID0gcG9saWN5R2VuZXJhdG9yLmdlbmVyYXRlR3JhcGhxbEFjY2Vzc1BvbGljeShcbiAgICAgICAgYWNjZXNzRGVmaW5pdGlvbi5hY3Rpb25zXG4gICAgICApO1xuICAgICAgYWNjZXNzRGVmaW5pdGlvbi5yZXNvdXJjZVByb3ZpZGVyXG4gICAgICAgIC5nZXRJbnN0YW5jZSh0aGlzLmdldEluc3RhbmNlUHJvcHMpXG4gICAgICAgIC5nZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yKClcbiAgICAgICAgLmFjY2VwdFJlc291cmNlQWNjZXNzKHBvbGljeSwgc3NtRW52aXJvbm1lbnRFbnRyaWVzKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBhbXBsaWZ5QXBpO1xuICB9O1xufVxuXG5jb25zdCBSRVBMQUNFX1RBQkxFX1VQT05fR1NJX1VQREFURV9BVFRSSUJVVEVfTkFNRToga2V5b2YgVHJhbnNsYXRpb25CZWhhdmlvciA9XG4gICdyZXBsYWNlVGFibGVVcG9uR3NpVXBkYXRlJztcblxuLyoqXG4gKiBBc3BlY3QgY2xhc3MgdG8gbW9kaWZ5IHRoZSBhbXBsaWZ5IG1hbmFnZWQgRHluYW1vREIgdGFibGVcbiAqIHRvIGFsbG93IHRhYmxlIHJlcGxhY2VtZW50IHVwb24gR1NJIHVwZGF0ZVxuICovXG5jbGFzcyBSZXBsYWNlVGFibGVVcG9uR3NpVXBkYXRlT3ZlcnJpZGVBc3BlY3QgaW1wbGVtZW50cyBJQXNwZWN0IHtcbiAgcHVibGljIHZpc2l0KHNjb3BlOiBJQ29uc3RydWN0KTogdm9pZCB7XG4gICAgaWYgKEFtcGxpZnlEeW5hbW9EYlRhYmxlV3JhcHBlci5pc0FtcGxpZnlEeW5hbW9EYlRhYmxlUmVzb3VyY2Uoc2NvcGUpKSB7XG4gICAgICAvLyBUaGVzZSB2YWx1ZSBzZXR0ZXJzIGFyZSBub3QgZXhwb3NlZCBpbiB0aGUgd3JhcHBlclxuICAgICAgLy8gTmVlZCB0byB1c2UgdGhlIHByb3BlcnR5IG92ZXJyaWRlIHRvIGVzY2FwZSB0aGUgaGF0Y2hcbiAgICAgIHNjb3BlLmFkZFByb3BlcnR5T3ZlcnJpZGUoXG4gICAgICAgIFJFUExBQ0VfVEFCTEVfVVBPTl9HU0lfVVBEQVRFX0FUVFJJQlVURV9OQU1FLFxuICAgICAgICB0cnVlXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBmYWN0b3J5IHRoYXQgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEFtcGxpZnlHcmFwaHFsQXBpPlxuICovXG5leHBvcnQgY29uc3QgZGVmaW5lRGF0YSA9IChwcm9wczogRGF0YVByb3BzKTogQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5RGF0YT4gPT5cbiAgbmV3IERhdGFGYWN0b3J5KHByb3BzLCBuZXcgRXJyb3IoKS5zdGFjayk7XG4iXX0=