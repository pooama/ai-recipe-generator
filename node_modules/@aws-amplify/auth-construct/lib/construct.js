"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const oauthProviderToProviderDomainMap = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const INVITATION_PLACEHOLDERS = {
    CODE: '{####}',
    USERNAME: '{username}',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b, _c;
        super(scope, id);
        this.groups = {};
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Auto generate the user pool groups and group roles
         */
        this.setupUserPoolGroups = (groups, identityPool) => {
            (groups || []).forEach((groupName, index) => {
                const groupRole = new aws_iam_1.Role(this, `${this.name}${groupName}GroupRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPool.ref,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                });
                const currentGroup = new aws_cognito_1.CfnUserPoolGroup(this, `${this.name}${groupName}Group`, {
                    userPoolId: this.userPool.userPoolId,
                    groupName: groupName,
                    roleArn: groupRole.roleArn,
                    precedence: index,
                });
                this.groups[groupName] = {
                    cfnUserGroup: currentGroup,
                    role: groupRole,
                };
            });
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oAuthMappings;
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Define bindCustomAttribute to meet requirements of the Cognito API to call the bind method
         */
        this.bindCustomAttribute = (key, attribute) => {
            var _a;
            const baseConfig = {
                dataType: attribute.dataType,
                mutable: (_a = attribute.mutable) !== null && _a !== void 0 ? _a : true,
            };
            let constraints = {};
            // Conditionally add constraint properties based on dataType.
            if (attribute.dataType === 'String') {
                constraints = {
                    stringConstraints: {
                        minLen: attribute.minLen,
                        maxLen: attribute.maxLen,
                    },
                };
            }
            else if (attribute.dataType === 'Number') {
                constraints = {
                    numberConstraints: {
                        min: attribute.min,
                        max: attribute.max,
                    },
                };
            }
            //The final config object includes baseConfig and conditionally added constraint properties.
            const config = {
                ...baseConfig,
                ...constraints,
            };
            return {
                ...config,
                bind: () => config,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            var _a, _b, _c;
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(() => VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const mfaType = this.getMFAType(props.multifactor);
            const mfaMode = this.getMFAMode(props.multifactor);
            // If phone login is enabled along with MFA, cognito requires that mfa SMS type to be enabled.
            if (phoneEnabled && mfaMode && mfaMode !== 'OFF' && !(mfaType === null || mfaType === void 0 ? void 0 : mfaType.sms)) {
                throw Error('Invalid MFA settings. SMS must be enabled in multiFactor if loginWith phone is enabled');
            }
            const { standardAttributes, customAttributes } = Object.entries((_a = props.userAttributes) !== null && _a !== void 0 ? _a : {}).reduce((acc, [key, value]) => {
                if (key.startsWith('custom:')) {
                    const attributeKey = key.replace(/^custom:/i, '');
                    acc.customAttributes[attributeKey] = this.bindCustomAttribute(attributeKey, value);
                }
                else {
                    acc.standardAttributes[key] = value;
                }
                return acc;
            }, { standardAttributes: {}, customAttributes: {} });
            /**
             * Handle KMS key for custom email sender
             * If a custom email sender is provided, we either use the provided KMS key ARN
             * or create a new KMS key if one is not provided.
             */
            if (((_b = props.senders) === null || _b === void 0 ? void 0 : _b.email) && 'handler' in props.senders.email) {
                if (props.senders.email.kmsKeyArn) {
                    // Use the provided KMS key ARN
                    this.customEmailSenderKMSkey = aws_kms_1.Key.fromKeyArn(this, `${this.name}CustomSenderKey`, props.senders.email.kmsKeyArn);
                }
                else {
                    // Create a new KMS key if not provided
                    this.customEmailSenderKMSkey = new aws_kms_1.Key(props.senders.email.handler.stack, `${this.name}CustomSenderKey`, {
                        enableKeyRotation: true,
                    });
                }
            }
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...standardAttributes,
                },
                customAttributes: {
                    ...customAttributes,
                },
                email: props.senders && 'fromEmail' in props.senders.email
                    ? aws_cdk_lib_1.aws_cognito.UserPoolEmail.withSES({
                        fromEmail: props.senders.email.fromEmail,
                        fromName: props.senders.email.fromName,
                        replyTo: props.senders.email.replyTo,
                        sesRegion: aws_cdk_lib_1.Stack.of(this).region,
                    })
                    : undefined,
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: mfaMode,
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: mfaType,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                userInvitation: typeof props.loginWith.email !== 'boolean'
                    ? this.getUserInvitationSettings((_c = props.loginWith.email) === null || _c === void 0 ? void 0 : _c.userInvitation)
                    : undefined,
                customSenderKmsKey: this.customEmailSenderKMSkey,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa Mode.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement mode
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa type to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA type (sms or totp)
         */
        this.getMFAType = (mfa) => {
            return typeof mfa === 'object' && mfa.mode !== 'OFF'
                ? {
                    sms: mfa.sms ? true : false,
                    otp: mfa.totp ? true : false,
                }
                : undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(() => MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup External Providers (OAuth/OIDC/SAML) and related settings
         * such as OAuth settings and User Pool Domains
         */
        this.setupExternalProviders = (userPool, loginOptions) => {
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oAuthMappings: {},
                oAuthSettings: {
                    flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
                },
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            // make sure logout/callback urls are not empty
            if (external.logoutUrls && external.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (external.callbackUrls && external.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.GOOGLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(googleProps.attributeMapping),
                    },
                    scopes: googleProps.scopes,
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.google] =
                    external.google.clientId;
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.FACEBOOK_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.facebook.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.facebook] =
                    external.facebook.clientId;
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.AMAZON_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.loginWithAmazon.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.amazon] =
                    external.loginWithAmazon.clientId;
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.APPLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.signInWithApple.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.apple] =
                    external.signInWithApple.clientId;
            }
            if (external.oidc && external.oidc.length > 0) {
                result.oidc = [];
                external.oidc.forEach((provider, index) => {
                    var _a, _b;
                    const requestMethod = provider.attributeRequestMethod === undefined
                        ? 'GET' // default if not defined
                        : provider.attributeRequestMethod;
                    const generatedProvider = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}${(_a = provider.name) !== null && _a !== void 0 ? _a : index}OidcIDP`, {
                        userPool,
                        attributeRequestMethod: requestMethod === 'GET'
                            ? aws_cognito_1.OidcAttributeRequestMethod.GET
                            : aws_cognito_1.OidcAttributeRequestMethod.POST,
                        clientId: provider.clientId,
                        clientSecret: provider.clientSecret,
                        endpoints: provider.endpoints,
                        identifiers: provider.identifiers,
                        issuerUrl: provider.issuerUrl,
                        name: provider.name,
                        scopes: provider.scopes,
                        attributeMapping: {
                            ...(shouldMapEmailAttributes
                                ? {
                                    email: {
                                        attributeName: 'email',
                                    },
                                }
                                : undefined),
                            ...this.convertToCognitoAttributeMapping(provider.attributeMapping),
                        },
                    });
                    (_b = result.oidc) === null || _b === void 0 ? void 0 : _b.push(generatedProvider);
                });
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: this.convertToCognitoAttributeMapping(saml.attributeMapping),
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
            }
            // Always generate a domain prefix if external provider is configured
            if (this.domainPrefix) {
                this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                    cognitoDomain: { domainPrefix: this.domainPrefix },
                });
            }
            else {
                throw new Error('Cognito Domain Prefix is missing when external providers are configured.');
            }
            // oauth settings for the UserPool client
            result.oAuthSettings = {
                callbackUrls: external.callbackUrls,
                logoutUrls: external.logoutUrls,
                scopes: external.scopes
                    ? this.getOAuthScopes(external.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
            };
            return result;
        };
        /**
         * Converts the simplified mapping type to cognito.AttributeMapping.
         * @param mapping the AttributeMapping to convert to a cognito.AttributeMapping
         * @returns cognito.AttributeMapping
         */
        this.convertToCognitoAttributeMapping = (mapping) => {
            if (!mapping) {
                return undefined;
            }
            const result = {};
            for (const [attrName, value] of Object.entries(mapping)) {
                if (typeof value === 'string') {
                    result[attrName] = {
                        attributeName: value,
                    };
                }
                if (typeof value === 'object' && attrName === 'custom') {
                    // dealing with custom attributes
                    const customAttributes = {};
                    for (const [customKey, attrName] of Object.entries(value)) {
                        customAttributes[customKey] = {
                            attributeName: attrName,
                        };
                    }
                    result[attrName] = customAttributes;
                }
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            const cfnUserPool = this.resources.cfnResources.cfnUserPool;
            const cfnUserPoolClient = this.resources.cfnResources.cfnUserPoolClient;
            const cfnIdentityPool = this.resources.cfnResources.cfnIdentityPool;
            // these properties cannot be overwritten
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
            };
            // the properties below this line can be overwritten, so they are exposed via cdk LAZY
            output.allowUnauthenticatedIdentities = aws_cdk_lib_1.Lazy.string({
                produce: () => cfnIdentityPool.allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            });
            // extract signupAttributes from UserPool schema's required attributes
            output.signupAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.schema) {
                        return '[]';
                    }
                    return JSON.stringify(cfnUserPool.schema
                        .filter((attribute) => attribute.required && attribute.name)
                        .map((attribute) => { var _a; return (_a = attribute.name) === null || _a === void 0 ? void 0 : _a.toLowerCase(); }));
                },
            });
            // extract usernameAttributes from UserPool's usernameAttributes
            output.usernameAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify(((_a = cfnUserPool.usernameAttributes) === null || _a === void 0 ? void 0 : _a.map((attr) => attr.toLowerCase())) ||
                        []);
                },
            });
            // extract verificationMechanisms from UserPool's autoVerifiedAttributes
            output.verificationMechanisms = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPool.autoVerifiedAttributes) !== null && _a !== void 0 ? _a : []);
                },
            });
            // extract the passwordPolicy from the UserPool policies
            output.passwordPolicyMinLength = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    return (_a = policy.minimumLength) === null || _a === void 0 ? void 0 : _a.toString();
                },
            });
            output.passwordPolicyRequirements = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    const requirements = [];
                    policy.requireNumbers && requirements.push('REQUIRES_NUMBERS');
                    policy.requireLowercase && requirements.push('REQUIRES_LOWERCASE');
                    policy.requireUppercase && requirements.push('REQUIRES_UPPERCASE');
                    policy.requireSymbols && requirements.push('REQUIRES_SYMBOLS');
                    return JSON.stringify(requirements);
                },
            });
            // extract the MFA configuration setting from the UserPool resource
            output.mfaConfiguration = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return (_a = cfnUserPool.mfaConfiguration) !== null && _a !== void 0 ? _a : 'OFF';
                },
            });
            // extract the MFA types from the UserPool resource
            output.mfaTypes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    const mfaTypes = [];
                    ((_a = cfnUserPool.enabledMfas) !== null && _a !== void 0 ? _a : []).forEach((type) => {
                        if (type === 'SMS_MFA') {
                            mfaTypes.push('SMS');
                        }
                        if (type === 'SOFTWARE_TOKEN_MFA') {
                            mfaTypes.push('TOTP');
                        }
                    });
                    return JSON.stringify(mfaTypes);
                },
            });
            // extract social providers from UserPool resource
            output.socialProviders = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const outputProviders = [];
                    const userPoolProviders = this.resources.userPool.identityProviders;
                    if (!userPoolProviders || userPoolProviders.length === 0) {
                        return '';
                    }
                    for (const provider of userPoolProviders) {
                        const providerResource = provider.node.findChild('Resource');
                        if (!(providerResource instanceof aws_cognito_1.CfnUserPoolIdentityProvider)) {
                            throw Error('Could not find the CfnUserPoolIdentityProvider resource in the stack.');
                        }
                        const providerType = providerResource.providerType;
                        const providerName = providerResource.providerName;
                        if (providerType === 'Google') {
                            outputProviders.push('GOOGLE');
                        }
                        if (providerType === 'Facebook') {
                            outputProviders.push('FACEBOOK');
                        }
                        if (providerType === 'SignInWithApple') {
                            outputProviders.push('SIGN_IN_WITH_APPLE');
                        }
                        if (providerType === 'LoginWithAmazon') {
                            outputProviders.push('LOGIN_WITH_AMAZON');
                        }
                        if (providerType === 'OIDC') {
                            outputProviders.push(providerName);
                        }
                        if (providerType === 'SAML') {
                            outputProviders.push(providerName);
                        }
                    }
                    return JSON.stringify(outputProviders);
                },
            });
            output.oauthCognitoDomain = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const userPoolDomain = this.resources.userPool.node.tryFindChild(`${this.name}UserPoolDomain`);
                    if (!userPoolDomain) {
                        return '';
                    }
                    if (!(userPoolDomain instanceof aws_cognito_1.UserPoolDomain)) {
                        throw Error('Could not find UserPoolDomain resource in the stack.');
                    }
                    return `${userPoolDomain.domainName}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                },
            });
            output.oauthScope = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPoolClient.allowedOAuthScopes) !== null && _a !== void 0 ? _a : []);
                },
            });
            output.oauthRedirectSignIn = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.callbackUrLs
                        ? cfnUserPoolClient.callbackUrLs.join(',')
                        : '';
                },
            });
            output.oauthRedirectSignOut = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.logoutUrLs
                        ? cfnUserPoolClient.logoutUrLs.join(',')
                        : '';
                },
            });
            output.oauthResponseType = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.allowedOAuthFlows
                        ? cfnUserPoolClient.allowedOAuthFlows.join(',')
                        : '';
                },
            });
            output.oauthClientId = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.ref;
                },
            });
            // user group precedence can be overwritten, so they are exposed via cdk LAZY
            output.groups = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const groupsArray = [];
                    Object.keys(this.resources.groups).forEach((groupName) => {
                        const precedence = this.resources.groups[groupName].cfnUserGroup.precedence;
                        groupsArray.push({
                            [groupName]: {
                                precedence,
                            },
                        });
                    }, {});
                    return JSON.stringify(groupsArray);
                },
            });
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        /**
         * Configure custom email sender for Cognito User Pool
         * Grant necessary permissions for Lambda function to decrypt emails
         * and allow Cognito to invoke the Lambda function
         */
        if (((_c = props.senders) === null || _c === void 0 ? void 0 : _c.email) &&
            'handler' in props.senders.email &&
            this.customEmailSenderKMSkey) {
            this.customEmailSenderKMSkey.grantDecrypt(props.senders.email.handler);
            this.customEmailSenderKMSkey.grantEncrypt(props.senders.email.handler);
            this.userPool.addTrigger(aws_cognito_1.UserPoolOperation.of('customEmailSender'), props.senders.email.handler);
        }
        // UserPool - External Providers (Oauth, SAML, OIDC) and User Pool Domain
        this.providerSetupResult = this.setupExternalProviders(this.userPool, props.loginWith);
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.providerSetupResult.oAuthSettings,
        });
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // Setup UserPool groups
        this.setupUserPoolGroups(props.groups, identityPool);
        const cfnUserPool = this.userPool.node.findChild('Resource');
        if (!(cfnUserPool instanceof aws_cognito_1.CfnUserPool)) {
            throw Error('Could not find CfnUserPool resource in stack.');
        }
        const cfnUserPoolClient = userPoolClient.node.findChild('Resource');
        if (!(cfnUserPoolClient instanceof aws_cognito_1.CfnUserPoolClient)) {
            throw Error('Could not find CfnUserPoolClient resource in stack.');
        }
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            identityPoolId: identityPool.ref,
            cfnResources: {
                cfnUserPool,
                cfnUserPoolClient,
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
            groups: this.groups,
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Parses the user invitation settings and inserts codes/usernames where necessary.
     * @param settings the invitation settings
     * @returns cognito.UserInvitationConfig | undefined
     */
    getUserInvitationSettings(settings) {
        if (!settings) {
            return undefined;
        }
        return {
            emailSubject: settings.emailSubject,
            emailBody: settings.emailBody
                ? settings.emailBody(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
            smsMessage: settings.smsMessage
                ? settings.smsMessage(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
        };
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(() => VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            let linkText = '';
            emailBody = emailSettings.verificationEmailBody((text) => {
                linkText = text
                    ? `{##${text}##}`
                    : VERIFICATION_EMAIL_PLACEHOLDERS.LINK;
                return linkText;
            });
            if (linkText === '' || !emailBody.includes(linkText)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyw2Q0FLcUI7QUFNckIseURBMEJpQztBQUNqQyxpREFBK0Q7QUFDL0QsZ0ZBQWdGO0FBUWhGLCtDQUF5QztBQUN6QyxnRkFHNkM7QUFDN0MsMkNBQTZCO0FBQzdCLGlEQUFnRDtBQW1CaEQsTUFBTSxnQ0FBZ0MsR0FBeUI7SUFDN0QsUUFBUSxFQUFFLG9CQUFvQjtJQUM5QixNQUFNLEVBQUUscUJBQXFCO0lBQzdCLE1BQU0sRUFBRSxnQkFBZ0I7SUFDeEIsS0FBSyxFQUFFLG1CQUFtQjtDQUMzQixDQUFDO0FBQ0YsTUFBTSx1QkFBdUIsR0FBRztJQUM5QixJQUFJLEVBQUUsUUFBUTtJQUNkLFFBQVEsRUFBRSxZQUFZO0NBQ3ZCLENBQUM7QUFDRixNQUFNLCtCQUErQixHQUFHO0lBQ3RDLElBQUksRUFBRSxRQUFRO0lBQ2QsSUFBSSxFQUFFLG9CQUFvQjtDQUMzQixDQUFDO0FBQ0YsTUFBTSw2QkFBNkIsR0FBRztJQUNwQyxJQUFJLEVBQUUsUUFBUTtDQUNmLENBQUM7QUFDRixNQUFNLG9CQUFvQixHQUFHO0lBQzNCLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0Isd0JBQVUsQ0FBQyxLQUFLO0lBQ2hCLHdCQUFVLENBQUMsS0FBSztJQUNoQix3QkFBVSxDQUFDLE1BQU07SUFDakIsd0JBQVUsQ0FBQyxPQUFPO0lBQ2xCLHdCQUFVLENBQUMsYUFBYTtDQUN6QixDQUFDO0FBRUYsc0hBQXNIO0FBQ3RILE1BQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQztBQUVyQzs7R0FFRztBQUNILE1BQWEsV0FDWCxTQUFRLHNCQUFTO0lBZ0NqQjs7O09BR0c7SUFDSCxZQUNFLEtBQWdCLEVBQ2hCLEVBQVUs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YSxFQUFFLEVBQUU7Z0JBQ2hFLFFBQVEsR0FBRyxJQUFJO29CQUNiLENBQUMsQ0FBQyxNQUFNLElBQUksS0FBSztvQkFDakIsQ0FBQyxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQztnQkFDekMsT0FBTyxRQUFRLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLFFBQVEsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNwRCxNQUFNLEtBQUssQ0FDVCxzSkFBc0osQ0FDdkosQ0FBQzthQUNIO1NBQ0Y7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0NBNG1CRjtBQTNvQ0Qsa0NBMm9DQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgTGF6eSxcbiAgUmVtb3ZhbFBvbGljeSxcbiAgU3RhY2ssXG4gIGF3c19jb2duaXRvIGFzIGNvZ25pdG8sXG59IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7XG4gIEF1dGhSZXNvdXJjZXMsXG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgQ2ZuSWRlbnRpdHlQb29sLFxuICBDZm5Vc2VyUG9vbCxcbiAgQ2ZuVXNlclBvb2xDbGllbnQsXG4gIENmblVzZXJQb29sR3JvdXAsXG4gIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcixcbiAgQ3VzdG9tQXR0cmlidXRlQ29uZmlnLFxuICBJQ3VzdG9tQXR0cmlidXRlLFxuICBNZmEsXG4gIE1mYVNlY29uZEZhY3RvcixcbiAgT0F1dGhTY29wZSxcbiAgT2lkY0F0dHJpYnV0ZVJlcXVlc3RNZXRob2QsXG4gIFByb3ZpZGVyQXR0cmlidXRlLFxuICBTdGFuZGFyZEF0dHJpYnV0ZSxcbiAgVXNlclBvb2wsXG4gIFVzZXJQb29sQ2xpZW50LFxuICBVc2VyUG9vbERvbWFpbixcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBcHBsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyRmFjZWJvb2ssXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkYyxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbCxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZSxcbiAgVXNlclBvb2xPcGVyYXRpb24sXG4gIFVzZXJQb29sUHJvcHMsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IEZlZGVyYXRlZFByaW5jaXBhbCwgUm9sZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgQXV0aE91dHB1dCwgYXV0aE91dHB1dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7XG4gIEF0dHJpYnV0ZU1hcHBpbmcsXG4gIEF1dGhQcm9wcyxcbiAgQ3VzdG9tQXR0cmlidXRlLFxuICBFbWFpbExvZ2luU2V0dGluZ3MsXG4gIEV4dGVybmFsUHJvdmlkZXJPcHRpb25zLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IERFRkFVTFRTIH0gZnJvbSAnLi9kZWZhdWx0cy5qcyc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBJS2V5LCBLZXkgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mta21zJztcblxudHlwZSBEZWZhdWx0Um9sZXMgPSB7IGF1dGg6IFJvbGU7IHVuQXV0aDogUm9sZSB9O1xudHlwZSBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPSB7XG4gIG9BdXRoTWFwcGluZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIG9BdXRoU2V0dGluZ3M6IGNvZ25pdG8uT0F1dGhTZXR0aW5ncyB8IHVuZGVmaW5lZDtcbiAgZ29vZ2xlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyR29vZ2xlO1xuICBmYWNlYm9vaz86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rO1xuICBhbWF6b24/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b247XG4gIGFwcGxlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGU7XG4gIG9pZGM/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjW107XG4gIHNhbWw/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sO1xufTtcbnR5cGUgT0F1dGhQcm92aWRlck1hcHBpbmcgPSB7XG4gIGZhY2Vib29rOiBzdHJpbmc7XG4gIGdvb2dsZTogc3RyaW5nO1xuICBhbWF6b246IHN0cmluZztcbiAgYXBwbGU6IHN0cmluZztcbn07XG5jb25zdCBvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcDogT0F1dGhQcm92aWRlck1hcHBpbmcgPSB7XG4gIGZhY2Vib29rOiAnZ3JhcGguZmFjZWJvb2suY29tJyxcbiAgZ29vZ2xlOiAnYWNjb3VudHMuZ29vZ2xlLmNvbScsXG4gIGFtYXpvbjogJ3d3dy5hbWF6b24uY29tJyxcbiAgYXBwbGU6ICdhcHBsZWlkLmFwcGxlLmNvbScsXG59O1xuY29uc3QgSU5WSVRBVElPTl9QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxuICBVU0VSTkFNRTogJ3t1c2VybmFtZX0nLFxufTtcbmNvbnN0IFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxuICBMSU5LOiAneyMjVmVyaWZ5IEVtYWlsIyN9Jyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fU01TX1BMQUNFSE9MREVSUyA9IHtcbiAgQ09ERTogJ3sjIyMjfScsXG59O1xuY29uc3QgTUZBX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IERFRkFVTFRfT0FVVEhfU0NPUEVTID0gW1xuICBPQXV0aFNjb3BlLlBIT05FLFxuICBPQXV0aFNjb3BlLkVNQUlMLFxuICBPQXV0aFNjb3BlLk9QRU5JRCxcbiAgT0F1dGhTY29wZS5QUk9GSUxFLFxuICBPQXV0aFNjb3BlLkNPR05JVE9fQURNSU4sXG5dO1xuXG4vLyBCZSB2ZXJ5IGNhcmVmdWwgZWRpdGluZyB0aGlzIHZhbHVlLiBJdCBpcyB0aGUgc3RyaW5nIHRoYXQgaXMgdXNlZCB0byBhdHRyaWJ1dGUgc3RhY2tzIHRvIEFtcGxpZnkgQXV0aCBpbiBCSSBtZXRyaWNzXG5jb25zdCBhdXRoU3RhY2tUeXBlID0gJ2F1dGgtQ29nbml0byc7XG5cbi8qKlxuICogQW1wbGlmeSBBdXRoIENESyBDb25zdHJ1Y3RcbiAqL1xuZXhwb3J0IGNsYXNzIEFtcGxpZnlBdXRoXG4gIGV4dGVuZHMgQ29uc3RydWN0XG4gIGltcGxlbWVudHMgUmVzb3VyY2VQcm92aWRlcjxBdXRoUmVzb3VyY2VzPlxue1xuICAvKipcbiAgICogVGhlIHJlc291cmNlcyBnZW5lcmF0ZWQgYnkgdGhlIGNvbnN0cnVjdC5cbiAgICovXG4gIHJlYWRvbmx5IHJlc291cmNlczogQXV0aFJlc291cmNlcztcbiAgLyoqXG4gICAqIEV4dGVybmFsIHByb3ZpZGVyIHNldHRpbmdzXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHByb3ZpZGVyU2V0dXBSZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdDtcblxuICBwcml2YXRlIHJlYWRvbmx5IHVzZXJQb29sOiBVc2VyUG9vbDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNvbXB1dGVkVXNlclBvb2xQcm9wczogVXNlclBvb2xQcm9wcztcblxuICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBwcml2YXRlIHJlYWRvbmx5IGRvbWFpblByZWZpeDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZ3JvdXBzOiB7XG4gICAgW2tleTogc3RyaW5nXToge1xuICAgICAgY2ZuVXNlckdyb3VwOiBDZm5Vc2VyUG9vbEdyb3VwO1xuICAgICAgcm9sZTogUm9sZTtcbiAgICB9O1xuICB9ID0ge307XG4gIC8qKlxuICAgKiBUaGUgS01TIGtleSB1c2VkIGZvciBlbmNyeXB0aW5nIGN1c3RvbSBlbWFpbCBzZW5kZXIgZGF0YS5cbiAgICogVGhpcyBpcyBvbmx5IHNldCB3aGVuIHVzaW5nIGEgY3VzdG9tIGVtYWlsIHNlbmRlci5cbiAgICovXG4gIHByaXZhdGUgY3VzdG9tRW1haWxTZW5kZXJLTVNrZXk6IElLZXkgfCB1bmRlZmluZWQ7XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBBdXRoIGNvbnN0cnVjdCB3aXRoIEF1dGhQcm9wcy5cbiAgICogSWYgbm8gcHJvcHMgYXJlIHByb3ZpZGVkLCBlbWFpbCBsb2dpbiBhbmQgZGVmYXVsdHMgd2lsbCBiZSB1c2VkLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIHByb3BzOiBBdXRoUHJvcHMgPSBERUZBVUxUUy5JRl9OT19QUk9QU19QUk9WSURFRFxuICApIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJyc7XG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcbiAgICAvLyBVc2VyUG9vbFxuICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzID0gdGhpcy5nZXRVc2VyUG9vbFByb3BzKHByb3BzKTtcblxuICAgIHRoaXMudXNlclBvb2wgPSBuZXcgY29nbml0by5Vc2VyUG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xgLFxuICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHNcbiAgICApO1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBjdXN0b20gZW1haWwgc2VuZGVyIGZvciBDb2duaXRvIFVzZXIgUG9vbFxuICAgICAqIEdyYW50IG5lY2Vzc2FyeSBwZXJtaXNzaW9ucyBmb3IgTGFtYmRhIGZ1bmN0aW9uIHRvIGRlY3J5cHQgZW1haWxzXG4gICAgICogYW5kIGFsbG93IENvZ25pdG8gdG8gaW52b2tlIHRoZSBMYW1iZGEgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBpZiAoXG4gICAgICBwcm9wcy5zZW5kZXJzPy5lbWFpbCAmJlxuICAgICAgJ2hhbmRsZXInIGluIHByb3BzLnNlbmRlcnMuZW1haWwgJiZcbiAgICAgIHRoaXMuY3VzdG9tRW1haWxTZW5kZXJLTVNrZXlcbiAgICApIHtcbiAgICAgIHRoaXMuY3VzdG9tRW1haWxTZW5kZXJLTVNrZXkuZ3JhbnREZWNyeXB0KHByb3BzLnNlbmRlcnMuZW1haWwuaGFuZGxlcik7XG4gICAgICB0aGlzLmN1c3RvbUVtYWlsU2VuZGVyS01Ta2V5LmdyYW50RW5jcnlwdChwcm9wcy5zZW5kZXJzLmVtYWlsLmhhbmRsZXIpO1xuICAgICAgdGhpcy51c2VyUG9vbC5hZGRUcmlnZ2VyKFxuICAgICAgICBVc2VyUG9vbE9wZXJhdGlvbi5vZignY3VzdG9tRW1haWxTZW5kZXInKSxcbiAgICAgICAgcHJvcHMuc2VuZGVycy5lbWFpbC5oYW5kbGVyXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFVzZXJQb29sIC0gRXh0ZXJuYWwgUHJvdmlkZXJzIChPYXV0aCwgU0FNTCwgT0lEQykgYW5kIFVzZXIgUG9vbCBEb21haW5cbiAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQgPSB0aGlzLnNldHVwRXh0ZXJuYWxQcm92aWRlcnMoXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgcHJvcHMubG9naW5XaXRoXG4gICAgKTtcbiAgICAvLyBVc2VyUG9vbCBDbGllbnRcbiAgICBjb25zdCB1c2VyUG9vbENsaWVudCA9IG5ldyBjb2duaXRvLlVzZXJQb29sQ2xpZW50KFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1Vc2VyUG9vbEFwcENsaWVudGAsXG4gICAgICB7XG4gICAgICAgIHVzZXJQb29sOiB0aGlzLnVzZXJQb29sLFxuICAgICAgICBhdXRoRmxvd3M6IERFRkFVTFRTLkFVVEhfRkxPV1MsXG4gICAgICAgIHByZXZlbnRVc2VyRXhpc3RlbmNlRXJyb3JzOiBERUZBVUxUUy5QUkVWRU5UX1VTRVJfRVhJU1RFTkNFX0VSUk9SUyxcbiAgICAgICAgb0F1dGg6IHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdC5vQXV0aFNldHRpbmdzLFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvLyBJZGVudGl0eSBQb29sXG4gICAgY29uc3Qge1xuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICByb2xlczogeyBhdXRoLCB1bkF1dGggfSxcbiAgICB9ID0gdGhpcy5zZXR1cElkZW50aXR5UG9vbChcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdFxuICAgICk7XG5cbiAgICAvLyBTZXR1cCBVc2VyUG9vbCBncm91cHNcbiAgICB0aGlzLnNldHVwVXNlclBvb2xHcm91cHMocHJvcHMuZ3JvdXBzLCBpZGVudGl0eVBvb2wpO1xuXG4gICAgY29uc3QgY2ZuVXNlclBvb2wgPSB0aGlzLnVzZXJQb29sLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmblVzZXJQb29sO1xuICAgIGlmICghKGNmblVzZXJQb29sIGluc3RhbmNlb2YgQ2ZuVXNlclBvb2wpKSB7XG4gICAgICB0aHJvdyBFcnJvcignQ291bGQgbm90IGZpbmQgQ2ZuVXNlclBvb2wgcmVzb3VyY2UgaW4gc3RhY2suJyk7XG4gICAgfVxuICAgIGNvbnN0IGNmblVzZXJQb29sQ2xpZW50ID0gdXNlclBvb2xDbGllbnQubm9kZS5maW5kQ2hpbGQoXG4gICAgICAnUmVzb3VyY2UnXG4gICAgKSBhcyBDZm5Vc2VyUG9vbENsaWVudDtcbiAgICBpZiAoIShjZm5Vc2VyUG9vbENsaWVudCBpbnN0YW5jZW9mIENmblVzZXJQb29sQ2xpZW50KSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIENmblVzZXJQb29sQ2xpZW50IHJlc291cmNlIGluIHN0YWNrLicpO1xuICAgIH1cbiAgICAvLyBleHBvc2UgcmVzb3VyY2VzXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICB1c2VyUG9vbDogdGhpcy51c2VyUG9vbCxcbiAgICAgIHVzZXJQb29sQ2xpZW50LFxuICAgICAgYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlOiBhdXRoLFxuICAgICAgdW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IHVuQXV0aCxcbiAgICAgIGlkZW50aXR5UG9vbElkOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgICAgIGNmblVzZXJQb29sLFxuICAgICAgICBjZm5Vc2VyUG9vbENsaWVudCxcbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sOiBpZGVudGl0eVBvb2wsXG4gICAgICAgIGNmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50OiBpZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudCxcbiAgICAgIH0sXG4gICAgICBncm91cHM6IHRoaXMuZ3JvdXBzLFxuICAgIH07XG4gICAgdGhpcy5zdG9yZU91dHB1dChwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBhdXRoU3RhY2tUeXBlLFxuICAgICAgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ3BhY2thZ2UuanNvbicpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgQXV0aC9VbkF1dGggUm9sZXNcbiAgICogQHJldHVybnMgRGVmYXVsdFJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwQXV0aEFuZFVuQXV0aFJvbGVzID0gKGlkZW50aXR5UG9vbElkOiBzdHJpbmcpOiBEZWZhdWx0Um9sZXMgPT4ge1xuICAgIGNvbnN0IHJlc3VsdDogRGVmYXVsdFJvbGVzID0ge1xuICAgICAgYXV0aDogbmV3IFJvbGUodGhpcywgYCR7dGhpcy5uYW1lfWF1dGhlbnRpY2F0ZWRVc2VyUm9sZWAsIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IGlkZW50aXR5UG9vbElkLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICdGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlJzoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtcic6ICdhdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICAgIHVuQXV0aDogbmV3IFJvbGUodGhpcywgYCR7dGhpcy5uYW1lfXVuYXV0aGVudGljYXRlZFVzZXJSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ3VuYXV0aGVudGljYXRlZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ3N0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5J1xuICAgICAgICApLFxuICAgICAgfSksXG4gICAgfTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBBdXRvIGdlbmVyYXRlIHRoZSB1c2VyIHBvb2wgZ3JvdXBzIGFuZCBncm91cCByb2xlc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cFVzZXJQb29sR3JvdXBzID0gKFxuICAgIGdyb3Vwczogc3RyaW5nW10gfCB1bmRlZmluZWQsXG4gICAgaWRlbnRpdHlQb29sOiBDZm5JZGVudGl0eVBvb2xcbiAgKSA9PiB7XG4gICAgKGdyb3VwcyB8fCBbXSkuZm9yRWFjaCgoZ3JvdXBOYW1lLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgZ3JvdXBSb2xlID0gbmV3IFJvbGUodGhpcywgYCR7dGhpcy5uYW1lfSR7Z3JvdXBOYW1lfUdyb3VwUm9sZWAsIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20nLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZCc6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSdcbiAgICAgICAgKSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgY3VycmVudEdyb3VwID0gbmV3IENmblVzZXJQb29sR3JvdXAoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX0ke2dyb3VwTmFtZX1Hcm91cGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbElkOiB0aGlzLnVzZXJQb29sLnVzZXJQb29sSWQsXG4gICAgICAgICAgZ3JvdXBOYW1lOiBncm91cE5hbWUsXG4gICAgICAgICAgcm9sZUFybjogZ3JvdXBSb2xlLnJvbGVBcm4sXG4gICAgICAgICAgcHJlY2VkZW5jZTogaW5kZXgsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICB0aGlzLmdyb3Vwc1tncm91cE5hbWVdID0ge1xuICAgICAgICBjZm5Vc2VyR3JvdXA6IGN1cnJlbnRHcm91cCxcbiAgICAgICAgcm9sZTogZ3JvdXBSb2xlLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfTtcblxuICAvKipcbiAgICogU2V0dXAgSWRlbnRpdHkgUG9vbCB3aXRoIGRlZmF1bHQgcm9sZXMvcm9sZSBtYXBwaW5ncywgYW5kIHJlZ2lzdGVyIHByb3ZpZGVyc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cElkZW50aXR5UG9vbCA9IChcbiAgICB1c2VyUG9vbDogVXNlclBvb2wsXG4gICAgdXNlclBvb2xDbGllbnQ6IFVzZXJQb29sQ2xpZW50LFxuICAgIHByb3ZpZGVyU2V0dXBSZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdFxuICApID0+IHtcbiAgICAvLyBzZXR1cCBpZGVudGl0eSBwb29sXG4gICAgY29uc3QgcmVnaW9uID0gU3RhY2sub2YodGhpcykucmVnaW9uO1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbCA9IG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9SWRlbnRpdHlQb29sYCxcbiAgICAgIHtcbiAgICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICAgIERFRkFVTFRTLkFMTE9XX1VOQVVUSEVOVElDQVRFRF9JREVOVElUSUVTLFxuICAgICAgfVxuICAgICk7XG4gICAgY29uc3Qgcm9sZXMgPSB0aGlzLnNldHVwQXV0aEFuZFVuQXV0aFJvbGVzKGlkZW50aXR5UG9vbC5yZWYpO1xuICAgIGNvbnN0IGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50ID1cbiAgICAgIG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50KFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9SWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRgLFxuICAgICAgICB7XG4gICAgICAgICAgaWRlbnRpdHlQb29sSWQ6IGlkZW50aXR5UG9vbC5yZWYsXG4gICAgICAgICAgcm9sZXM6IHtcbiAgICAgICAgICAgIHVuYXV0aGVudGljYXRlZDogcm9sZXMudW5BdXRoLnJvbGVBcm4sXG4gICAgICAgICAgICBhdXRoZW50aWNhdGVkOiByb2xlcy5hdXRoLnJvbGVBcm4sXG4gICAgICAgICAgfSxcbiAgICAgICAgICByb2xlTWFwcGluZ3M6IHtcbiAgICAgICAgICAgIFVzZXJQb29sV2ViQ2xpZW50Um9sZU1hcHBpbmc6IHtcbiAgICAgICAgICAgICAgdHlwZTogJ1Rva2VuJyxcbiAgICAgICAgICAgICAgYW1iaWd1b3VzUm9sZVJlc29sdXRpb246ICdBdXRoZW50aWNhdGVkUm9sZScsXG4gICAgICAgICAgICAgIGlkZW50aXR5UHJvdmlkZXI6IGBjb2duaXRvLWlkcC4ke3JlZ2lvbn0uYW1hem9uYXdzLmNvbS8ke3VzZXJQb29sLnVzZXJQb29sSWR9OiR7dXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZH1gLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LmFkZERlcGVuZGVuY3koaWRlbnRpdHlQb29sKTtcbiAgICBpZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudC5ub2RlLmFkZERlcGVuZGVuY3kodXNlclBvb2xDbGllbnQpO1xuICAgIC8vIGFkZCBjb2duaXRvIHByb3ZpZGVyXG4gICAgaWRlbnRpdHlQb29sLmNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyA9IFtcbiAgICAgIHtcbiAgICAgICAgY2xpZW50SWQ6IHVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICAgIHByb3ZpZGVyTmFtZTogYGNvZ25pdG8taWRwLiR7cmVnaW9ufS5hbWF6b25hd3MuY29tLyR7dXNlclBvb2wudXNlclBvb2xJZH1gLFxuICAgICAgfSxcbiAgICBdO1xuICAgIC8vIGFkZCBvdGhlciBwcm92aWRlcnNcbiAgICBpZGVudGl0eVBvb2wuc3VwcG9ydGVkTG9naW5Qcm92aWRlcnMgPSBwcm92aWRlclNldHVwUmVzdWx0Lm9BdXRoTWFwcGluZ3M7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXMsXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogRGVmaW5lIGJpbmRDdXN0b21BdHRyaWJ1dGUgdG8gbWVldCByZXF1aXJlbWVudHMgb2YgdGhlIENvZ25pdG8gQVBJIHRvIGNhbGwgdGhlIGJpbmQgbWV0aG9kXG4gICAqL1xuICBwcml2YXRlIGJpbmRDdXN0b21BdHRyaWJ1dGUgPSAoXG4gICAga2V5OiBzdHJpbmcsXG4gICAgYXR0cmlidXRlOiBDdXN0b21BdHRyaWJ1dGVcbiAgKTogQ3VzdG9tQXR0cmlidXRlQ29uZmlnICYgSUN1c3RvbUF0dHJpYnV0ZSA9PiB7XG4gICAgY29uc3QgYmFzZUNvbmZpZzogQ3VzdG9tQXR0cmlidXRlQ29uZmlnID0ge1xuICAgICAgZGF0YVR5cGU6IGF0dHJpYnV0ZS5kYXRhVHlwZSxcblxuICAgICAgbXV0YWJsZTogYXR0cmlidXRlLm11dGFibGUgPz8gdHJ1ZSxcbiAgICB9O1xuXG4gICAgbGV0IGNvbnN0cmFpbnRzID0ge307XG4gICAgLy8gQ29uZGl0aW9uYWxseSBhZGQgY29uc3RyYWludCBwcm9wZXJ0aWVzIGJhc2VkIG9uIGRhdGFUeXBlLlxuICAgIGlmIChhdHRyaWJ1dGUuZGF0YVR5cGUgPT09ICdTdHJpbmcnKSB7XG4gICAgICBjb25zdHJhaW50cyA9IHtcbiAgICAgICAgc3RyaW5nQ29uc3RyYWludHM6IHtcbiAgICAgICAgICBtaW5MZW46IGF0dHJpYnV0ZS5taW5MZW4sXG5cbiAgICAgICAgICBtYXhMZW46IGF0dHJpYnV0ZS5tYXhMZW4sXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAoYXR0cmlidXRlLmRhdGFUeXBlID09PSAnTnVtYmVyJykge1xuICAgICAgY29uc3RyYWludHMgPSB7XG4gICAgICAgIG51bWJlckNvbnN0cmFpbnRzOiB7XG4gICAgICAgICAgbWluOiBhdHRyaWJ1dGUubWluLFxuXG4gICAgICAgICAgbWF4OiBhdHRyaWJ1dGUubWF4LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gICAgLy9UaGUgZmluYWwgY29uZmlnIG9iamVjdCBpbmNsdWRlcyBiYXNlQ29uZmlnIGFuZCBjb25kaXRpb25hbGx5IGFkZGVkIGNvbnN0cmFpbnQgcHJvcGVydGllcy5cbiAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAuLi5iYXNlQ29uZmlnLFxuXG4gICAgICAuLi5jb25zdHJhaW50cyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvbmZpZyxcblxuICAgICAgYmluZDogKCkgPT4gY29uZmlnLFxuICAgIH07XG4gIH07XG4gIC8qKlxuICAgKiBQcm9jZXNzIHByb3BzIGludG8gVXNlclBvb2xQcm9wcyAoc2V0IGRlZmF1bHRzIGlmIG5lZWRlZClcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xQcm9wcyA9IChwcm9wczogQXV0aFByb3BzKTogVXNlclBvb2xQcm9wcyA9PiB7XG4gICAgY29uc3QgZW1haWxFbmFibGVkID0gcHJvcHMubG9naW5XaXRoLmVtYWlsID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGNvbnN0IHBob25lRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC5waG9uZSA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCBvbmVPZkVtYWlsT3JQaG9uZSA9IGVtYWlsRW5hYmxlZCB8fCBwaG9uZUVuYWJsZWQ7XG4gICAgaWYgKCFvbmVPZkVtYWlsT3JQaG9uZSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiBlbWFpbCBvciBwaG9uZSBtdXN0IGJlIGVuYWJsZWQuJyk7XG4gICAgfVxuICAgIGxldCB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3M6IGNvZ25pdG8uVXNlclZlcmlmaWNhdGlvbkNvbmZpZyA9IHt9O1xuICAgIC8vIGV4dHJhY3QgZW1haWwgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGVtYWlsU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGguZW1haWw7XG4gICAgICAvLyB2ZXJpZnkgZW1haWwgYm9keSBhbmQgaW5qZWN0IHRoZSBhY3R1YWwgdGVtcGxhdGUgdmFsdWVzIHdoaWNoIGNvZ25pdG8gdXNlc1xuICAgICAgY29uc3QgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB0aGlzLnZlcmlmeUVtYWlsQm9keShlbWFpbFNldHRpbmdzKTtcbiAgICAgIHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgZW1haWxCb2R5OiBlbWFpbEJvZHksXG4gICAgICAgIGVtYWlsU3R5bGU6IHRoaXMuZ2V0RW1haWxWZXJpZmljYXRpb25TdHlsZShcbiAgICAgICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGVcbiAgICAgICAgKSxcbiAgICAgICAgZW1haWxTdWJqZWN0OiBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3ViamVjdCxcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGV4dHJhY3QgcGhvbmUgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5waG9uZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHBob25lU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGgucGhvbmU7XG4gICAgICBsZXQgc21zTWVzc2FnZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKFxuICAgICAgICBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UgJiZcbiAgICAgICAgdHlwZW9mIHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZSA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgKSB7XG4gICAgICAgIC8vIHZhbGlkYXRlIHNtcyBtZXNzYWdlIHN0cnVjdHVyZVxuICAgICAgICBzbXNNZXNzYWdlID0gcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlKFxuICAgICAgICAgICgpID0+IFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFzbXNNZXNzYWdlLmluY2x1ZGVzKFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgICBcIkludmFsaWQgcGhvbmUgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25NZXNzYWdlJyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MgPSB7XG4gICAgICAgIC4uLnVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyxcbiAgICAgICAgc21zTWVzc2FnZTogc21zTWVzc2FnZSxcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IG1mYVR5cGUgPSB0aGlzLmdldE1GQVR5cGUocHJvcHMubXVsdGlmYWN0b3IpO1xuICAgIGNvbnN0IG1mYU1vZGUgPSB0aGlzLmdldE1GQU1vZGUocHJvcHMubXVsdGlmYWN0b3IpO1xuXG4gICAgLy8gSWYgcGhvbmUgbG9naW4gaXMgZW5hYmxlZCBhbG9uZyB3aXRoIE1GQSwgY29nbml0byByZXF1aXJlcyB0aGF0IG1mYSBTTVMgdHlwZSB0byBiZSBlbmFibGVkLlxuICAgIGlmIChwaG9uZUVuYWJsZWQgJiYgbWZhTW9kZSAmJiBtZmFNb2RlICE9PSAnT0ZGJyAmJiAhbWZhVHlwZT8uc21zKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ0ludmFsaWQgTUZBIHNldHRpbmdzLiBTTVMgbXVzdCBiZSBlbmFibGVkIGluIG11bHRpRmFjdG9yIGlmIGxvZ2luV2l0aCBwaG9uZSBpcyBlbmFibGVkJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHN0YW5kYXJkQXR0cmlidXRlcywgY3VzdG9tQXR0cmlidXRlcyB9ID0gT2JqZWN0LmVudHJpZXMoXG4gICAgICBwcm9wcy51c2VyQXR0cmlidXRlcyA/PyB7fVxuICAgICkucmVkdWNlKFxuICAgICAgKFxuICAgICAgICBhY2M6IHtcbiAgICAgICAgICBzdGFuZGFyZEF0dHJpYnV0ZXM6IHsgW2tleTogc3RyaW5nXTogU3RhbmRhcmRBdHRyaWJ1dGUgfTtcbiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICBba2V5OiBzdHJpbmddOiBDdXN0b21BdHRyaWJ1dGVDb25maWcgJiBJQ3VzdG9tQXR0cmlidXRlO1xuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICAgIFtrZXksIHZhbHVlXVxuICAgICAgKSA9PiB7XG4gICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnY3VzdG9tOicpKSB7XG4gICAgICAgICAgY29uc3QgYXR0cmlidXRlS2V5ID0ga2V5LnJlcGxhY2UoL15jdXN0b206L2ksICcnKTtcbiAgICAgICAgICBhY2MuY3VzdG9tQXR0cmlidXRlc1thdHRyaWJ1dGVLZXldID0gdGhpcy5iaW5kQ3VzdG9tQXR0cmlidXRlKFxuICAgICAgICAgICAgYXR0cmlidXRlS2V5LFxuICAgICAgICAgICAgdmFsdWVcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFjYy5zdGFuZGFyZEF0dHJpYnV0ZXNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAgeyBzdGFuZGFyZEF0dHJpYnV0ZXM6IHt9LCBjdXN0b21BdHRyaWJ1dGVzOiB7fSB9XG4gICAgKTtcbiAgICAvKipcbiAgICAgKiBIYW5kbGUgS01TIGtleSBmb3IgY3VzdG9tIGVtYWlsIHNlbmRlclxuICAgICAqIElmIGEgY3VzdG9tIGVtYWlsIHNlbmRlciBpcyBwcm92aWRlZCwgd2UgZWl0aGVyIHVzZSB0aGUgcHJvdmlkZWQgS01TIGtleSBBUk5cbiAgICAgKiBvciBjcmVhdGUgYSBuZXcgS01TIGtleSBpZiBvbmUgaXMgbm90IHByb3ZpZGVkLlxuICAgICAqL1xuICAgIGlmIChwcm9wcy5zZW5kZXJzPy5lbWFpbCAmJiAnaGFuZGxlcicgaW4gcHJvcHMuc2VuZGVycy5lbWFpbCkge1xuICAgICAgaWYgKHByb3BzLnNlbmRlcnMuZW1haWwua21zS2V5QXJuKSB7XG4gICAgICAgIC8vIFVzZSB0aGUgcHJvdmlkZWQgS01TIGtleSBBUk5cbiAgICAgICAgdGhpcy5jdXN0b21FbWFpbFNlbmRlcktNU2tleSA9IEtleS5mcm9tS2V5QXJuKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfUN1c3RvbVNlbmRlcktleWAsXG4gICAgICAgICAgcHJvcHMuc2VuZGVycy5lbWFpbC5rbXNLZXlBcm5cbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIENyZWF0ZSBhIG5ldyBLTVMga2V5IGlmIG5vdCBwcm92aWRlZFxuICAgICAgICB0aGlzLmN1c3RvbUVtYWlsU2VuZGVyS01Ta2V5ID0gbmV3IEtleShcbiAgICAgICAgICBwcm9wcy5zZW5kZXJzLmVtYWlsLmhhbmRsZXIuc3RhY2ssXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfUN1c3RvbVNlbmRlcktleWAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZW5hYmxlS2V5Um90YXRpb246IHRydWUsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB1c2VyUG9vbFByb3BzOiBVc2VyUG9vbFByb3BzID0ge1xuICAgICAgc2lnbkluQ2FzZVNlbnNpdGl2ZTogREVGQVVMVFMuU0lHTl9JTl9DQVNFX1NFTlNJVElWRSxcbiAgICAgIHNpZ25JbkFsaWFzZXM6IHtcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBrZWVwT3JpZ2luYWw6IHtcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICBhdXRvVmVyaWZ5OiB7XG4gICAgICAgIGVtYWlsOiBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lOiBwaG9uZUVuYWJsZWQsXG4gICAgICB9LFxuICAgICAgdXNlclZlcmlmaWNhdGlvbjogdXNlclZlcmlmaWNhdGlvblNldHRpbmdzLFxuICAgICAgcGFzc3dvcmRQb2xpY3k6IERFRkFVTFRTLlBBU1NXT1JEX1BPTElDWSxcbiAgICAgIHN0YW5kYXJkQXR0cmlidXRlczoge1xuICAgICAgICBlbWFpbDogREVGQVVMVFMuSVNfUkVRVUlSRURfQVRUUklCVVRFLmVtYWlsKGVtYWlsRW5hYmxlZCksXG4gICAgICAgIHBob25lTnVtYmVyOiBERUZBVUxUUy5JU19SRVFVSVJFRF9BVFRSSUJVVEUucGhvbmVOdW1iZXIocGhvbmVFbmFibGVkKSxcbiAgICAgICAgLi4uc3RhbmRhcmRBdHRyaWJ1dGVzLFxuICAgICAgfSxcbiAgICAgIGN1c3RvbUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgLi4uY3VzdG9tQXR0cmlidXRlcyxcbiAgICAgIH0sXG4gICAgICBlbWFpbDpcbiAgICAgICAgcHJvcHMuc2VuZGVycyAmJiAnZnJvbUVtYWlsJyBpbiBwcm9wcy5zZW5kZXJzLmVtYWlsXG4gICAgICAgICAgPyBjb2duaXRvLlVzZXJQb29sRW1haWwud2l0aFNFUyh7XG4gICAgICAgICAgICAgIGZyb21FbWFpbDogcHJvcHMuc2VuZGVycy5lbWFpbC5mcm9tRW1haWwsXG4gICAgICAgICAgICAgIGZyb21OYW1lOiBwcm9wcy5zZW5kZXJzLmVtYWlsLmZyb21OYW1lLFxuICAgICAgICAgICAgICByZXBseVRvOiBwcm9wcy5zZW5kZXJzLmVtYWlsLnJlcGx5VG8sXG4gICAgICAgICAgICAgIHNlc1JlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHNlbGZTaWduVXBFbmFibGVkOiBERUZBVUxUUy5BTExPV19TRUxGX1NJR05fVVAsXG4gICAgICBtZmE6IG1mYU1vZGUsXG4gICAgICBtZmFNZXNzYWdlOiB0aGlzLmdldE1GQU1lc3NhZ2UocHJvcHMubXVsdGlmYWN0b3IpLFxuICAgICAgbWZhU2Vjb25kRmFjdG9yOiBtZmFUeXBlLFxuICAgICAgYWNjb3VudFJlY292ZXJ5OiB0aGlzLmdldEFjY291bnRSZWNvdmVyeVNldHRpbmcoXG4gICAgICAgIGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmVFbmFibGVkLFxuICAgICAgICBwcm9wcy5hY2NvdW50UmVjb3ZlcnlcbiAgICAgICksXG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICB1c2VySW52aXRhdGlvbjpcbiAgICAgICAgdHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCAhPT0gJ2Jvb2xlYW4nXG4gICAgICAgICAgPyB0aGlzLmdldFVzZXJJbnZpdGF0aW9uU2V0dGluZ3MoXG4gICAgICAgICAgICAgIHByb3BzLmxvZ2luV2l0aC5lbWFpbD8udXNlckludml0YXRpb25cbiAgICAgICAgICAgIClcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIGN1c3RvbVNlbmRlckttc0tleTogdGhpcy5jdXN0b21FbWFpbFNlbmRlcktNU2tleSxcbiAgICB9O1xuICAgIHJldHVybiB1c2VyUG9vbFByb3BzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBQYXJzZXMgdGhlIHVzZXIgaW52aXRhdGlvbiBzZXR0aW5ncyBhbmQgaW5zZXJ0cyBjb2Rlcy91c2VybmFtZXMgd2hlcmUgbmVjZXNzYXJ5LlxuICAgKiBAcGFyYW0gc2V0dGluZ3MgdGhlIGludml0YXRpb24gc2V0dGluZ3NcbiAgICogQHJldHVybnMgY29nbml0by5Vc2VySW52aXRhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VySW52aXRhdGlvblNldHRpbmdzKFxuICAgIHNldHRpbmdzOiBFbWFpbExvZ2luU2V0dGluZ3NbJ3VzZXJJbnZpdGF0aW9uJ11cbiAgKTogY29nbml0by5Vc2VySW52aXRhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFzZXR0aW5ncykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGVtYWlsU3ViamVjdDogc2V0dGluZ3MuZW1haWxTdWJqZWN0LFxuICAgICAgZW1haWxCb2R5OiBzZXR0aW5ncy5lbWFpbEJvZHlcbiAgICAgICAgPyBzZXR0aW5ncy5lbWFpbEJvZHkoXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5VU0VSTkFNRSxcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgICApXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgc21zTWVzc2FnZTogc2V0dGluZ3Muc21zTWVzc2FnZVxuICAgICAgICA/IHNldHRpbmdzLnNtc01lc3NhZ2UoXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5VU0VSTkFNRSxcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgICApXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHRoZSBlbWFpbCBib2R5IGRlcGVuZGluZyBvbiBpZiAnQ09ERScgb3IgJ0xJTksnIHN0eWxlIGlzIHVzZWQuXG4gICAqIFRoaXMgZW5zdXJlcyB0aGF0IHRoZSB0ZW1wbGF0ZSBjb250YWlucyB0aGUgbmVjZXNzYXJ5IHBsYWNlaG9sZGVycyBmb3IgQ29nbml0byB0byBpbnNlcnQgdmVyaWZpY2F0aW9uIGNvZGVzIG9yIGxpbmtzLlxuICAgKiBAcGFyYW0gZW1haWxTZXR0aW5ncyB0aGUgcHJvdmlkZWQgZW1haWwgc2V0dGluZ3NcbiAgICogQHJldHVybnMgZW1haWxCb2R5XG4gICAqL1xuICBwcml2YXRlIHZlcmlmeUVtYWlsQm9keShcbiAgICBlbWFpbFNldHRpbmdzOiBFbWFpbExvZ2luU2V0dGluZ3NcbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgaWYgKFxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkgJiZcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZSAhPT0gJ0xJTksnXG4gICAgKSB7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keShcbiAgICAgICAgKCkgPT4gVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5DT0RFXG4gICAgICApO1xuICAgICAgaWYgKCFlbWFpbEJvZHkuaW5jbHVkZXMoVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgZW1haWwgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25FbWFpbEJvZHknIG11c3QgdXRpbGl6ZSB0aGUgJ2NvZGUnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gY29kZS5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keSAmJlxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnTElOSydcbiAgICApIHtcbiAgICAgIGxldCBsaW5rVGV4dDogc3RyaW5nID0gJyc7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keSgodGV4dD86IHN0cmluZykgPT4ge1xuICAgICAgICBsaW5rVGV4dCA9IHRleHRcbiAgICAgICAgICA/IGB7IyMke3RleHR9IyN9YFxuICAgICAgICAgIDogVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5MSU5LO1xuICAgICAgICByZXR1cm4gbGlua1RleHQ7XG4gICAgICB9KTtcbiAgICAgIGlmIChsaW5rVGV4dCA9PT0gJycgfHwgIWVtYWlsQm9keS5pbmNsdWRlcyhsaW5rVGV4dCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIGVtYWlsIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uRW1haWxCb2R5JyBtdXN0IHV0aWxpemUgdGhlICdsaW5rJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGxpbmsuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGVtYWlsQm9keTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZW1haWwgdmVyaWZpY2F0aW9uIHN0eWxlIGZyb20gdXNlciBwcm9wc1xuICAgKiBAcGFyYW0gdmVyaWZpY2F0aW9uRW1haWxTdHlsZSAtIHN0cmluZyB2YWx1ZVxuICAgKiBAcmV0dXJucyB2ZXJpZmljYXRpb25FbWFpbFN0eWxlIC0gZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRFbWFpbFZlcmlmaWNhdGlvblN0eWxlID0gKFxuICAgIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGU6ICdDT0RFJyB8ICdMSU5LJyB8IHVuZGVmaW5lZFxuICApOiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmICh2ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnQ09ERScpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUuQ09ERTtcbiAgICB9IGVsc2UgaWYgKHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdMSU5LJykge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZS5MSU5LO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmUgdGhlIGFjY291bnQgcmVjb3Zlcnkgb3B0aW9uIGJhc2VkIG9uIGVuYWJsZWQgbG9naW4gbWV0aG9kcy5cbiAgICogQHBhcmFtIGVtYWlsRW5hYmxlZCAtIGlzIGVtYWlsIGVuYWJsZWRcbiAgICogQHBhcmFtIHBob25lRW5hYmxlZCAtIGlzIHBob25lIGVuYWJsZWRcbiAgICogQHBhcmFtIGFjY291bnRSZWNvdmVyeU1ldGhvZEFzU3RyaW5nIC0gdGhlIHVzZXIgcHJvdmlkZWQgYWNjb3VudCByZWNvdmVyeSBzZXR0aW5nXG4gICAqIEByZXR1cm5zIGFjY291bnQgcmVjb3Zlcnkgc2V0dGluZyBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGdldEFjY291bnRSZWNvdmVyeVNldHRpbmcgPSAoXG4gICAgZW1haWxFbmFibGVkOiBib29sZWFuLFxuICAgIHBob25lRW5hYmxlZDogYm9vbGVhbixcbiAgICBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZzogQXV0aFByb3BzWydhY2NvdW50UmVjb3ZlcnknXVxuICApOiBjb2duaXRvLkFjY291bnRSZWNvdmVyeSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgY29uc3QgYWNjb3VudFJlY292ZXJ5ID0gdGhpcy5jb252ZXJ0QWNjb3VudFJlY292ZXJ5U3RyaW5nVG9FbnVtKFxuICAgICAgYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmdcbiAgICApO1xuICAgIGlmIChhY2NvdW50UmVjb3ZlcnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGFjY291bnRSZWNvdmVyeTtcbiAgICB9XG4gICAgLy8gc2V0IGRlZmF1bHQgYmFzZWQgb24gZW5hYmxlZCBsb2dpbiBtZXRob2RzXG4gICAgaWYgKHBob25lRW5hYmxlZCAmJiBlbWFpbEVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5FTUFJTF9PTkxZO1xuICAgIH1cbiAgICBpZiAocGhvbmVFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuUEhPTkVfT05MWV9XSVRIT1VUX01GQTtcbiAgICB9XG4gICAgaWYgKGVtYWlsRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LkVNQUlMX09OTFk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBNZmEgbW9kZSB0byBjb2duaXRvIE1mYSBNb2RlLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLk1mYS5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvIE1GQSBlbmZvcmNlbWVudCBtb2RlXG4gICAqL1xuICBwcml2YXRlIGdldE1GQU1vZGUgPSAobWZhOiBBdXRoUHJvcHNbJ211bHRpZmFjdG9yJ10pOiBNZmEgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEpIHtcbiAgICAgIHN3aXRjaCAobWZhLm1vZGUpIHtcbiAgICAgICAgY2FzZSAnT0ZGJzpcbiAgICAgICAgICByZXR1cm4gTWZhLk9GRjtcbiAgICAgICAgY2FzZSAnT1BUSU9OQUwnOlxuICAgICAgICAgIHJldHVybiBNZmEuT1BUSU9OQUw7XG4gICAgICAgIGNhc2UgJ1JFUVVJUkVEJzpcbiAgICAgICAgICByZXR1cm4gTWZhLlJFUVVJUkVEO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHVzZXIgZnJpZW5kbHkgTWZhIHR5cGUgdG8gY29nbml0byBNZmEgdHlwZS5cbiAgICogVGhpcyBlbGltaW5hdGVzIHRoZSBuZWVkIGZvciB1c2VycyB0byBpbXBvcnQgY29nbml0by5NZmEuXG4gICAqIEBwYXJhbSBtZmEgLSBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgY29nbml0byBNRkEgdHlwZSAoc21zIG9yIHRvdHApXG4gICAqL1xuICBwcml2YXRlIGdldE1GQVR5cGUgPSAoXG4gICAgbWZhOiBBdXRoUHJvcHNbJ211bHRpZmFjdG9yJ11cbiAgKTogTWZhU2Vjb25kRmFjdG9yIHwgdW5kZWZpbmVkID0+IHtcbiAgICByZXR1cm4gdHlwZW9mIG1mYSA9PT0gJ29iamVjdCcgJiYgbWZhLm1vZGUgIT09ICdPRkYnXG4gICAgICA/IHtcbiAgICAgICAgICBzbXM6IG1mYS5zbXMgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgICAgb3RwOiBtZmEudG90cCA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgfVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBhY2NvdW50IHJlY292ZXJ5IG1ldGhvZCB0byBjb2duaXRvIEFjY291bnRSZWNvdmVyIGVudW0uXG4gICAqIFRoaXMgZWxpbWluYXRlcyB0aGUgbmVlZCBmb3IgdXNlcnMgdG8gaW1wb3J0IGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LlxuICAgKiBAcGFyYW0gbWV0aG9kIC0gYWNjb3VudCByZWNvdmVyeSBtZXRob2QgYXMgYSBzdHJpbmcgdmFsdWVcbiAgICogQHJldHVybnMgY29nbml0by5BY2NvdW50UmVjb3ZlcnkgZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0QWNjb3VudFJlY292ZXJ5U3RyaW5nVG9FbnVtID0gKFxuICAgIG1ldGhvZDogQXV0aFByb3BzWydhY2NvdW50UmVjb3ZlcnknXVxuICApOiBjb2duaXRvLkFjY291bnRSZWNvdmVyeSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1ldGhvZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnlbbWV0aG9kXTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogRXh0cmFjdCB0aGUgTUZBIG1lc3NhZ2Ugc2V0dGluZ3MgYW5kIHBlcmZvcm0gdmFsaWRhdGlvbi5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBtZmEgbWVzc2FnZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRNRkFNZXNzYWdlID0gKFxuICAgIG1mYTogQXV0aFByb3BzWydtdWx0aWZhY3RvciddXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKG1mYSAmJiBtZmEubW9kZSAhPT0gJ09GRicgJiYgdHlwZW9mIG1mYS5zbXMgPT09ICdvYmplY3QnKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gbWZhLnNtcy5zbXNNZXNzYWdlKCgpID0+IE1GQV9TTVNfUExBQ0VIT0xERVJTLkNPREUpO1xuICAgICAgaWYgKCFtZXNzYWdlLmluY2x1ZGVzKE1GQV9TTVNfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgIFwiSW52YWxpZCBNRkEgc2V0dGluZ3MuIFByb3BlcnR5ICdzbXNNZXNzYWdlJyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBtZXNzYWdlO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBFeHRlcm5hbCBQcm92aWRlcnMgKE9BdXRoL09JREMvU0FNTCkgYW5kIHJlbGF0ZWQgc2V0dGluZ3NcbiAgICogc3VjaCBhcyBPQXV0aCBzZXR0aW5ncyBhbmQgVXNlciBQb29sIERvbWFpbnNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBFeHRlcm5hbFByb3ZpZGVycyA9IChcbiAgICB1c2VyUG9vbDogVXNlclBvb2wsXG4gICAgbG9naW5PcHRpb25zOiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddXG4gICk6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9PiB7XG4gICAgLyoqXG4gICAgICogSWYgZW1haWwgaXMgZW5hYmxlZCwgYW5kIGlzIHRoZSBvbmx5IHJlcXVpcmVkIGF0dHJpYnV0ZSwgd2UgYXJlIGFibGUgdG9cbiAgICAgKiBhdXRvbWF0aWNhbGx5IG1hcCB0aGUgZW1haWwgYXR0cmlidXRlIGZyb20gZXh0ZXJuYWwgcHJvdmlkZXJzLCBleGNsdWRpbmcgU0FNTC5cbiAgICAgKi9cbiAgICBjb25zdCBzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXMgPSBsb2dpbk9wdGlvbnMuZW1haWwgJiYgIWxvZ2luT3B0aW9ucy5waG9uZTtcbiAgICBjb25zdCByZXN1bHQ6IElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9IHtcbiAgICAgIG9BdXRoTWFwcGluZ3M6IHt9LFxuICAgICAgb0F1dGhTZXR0aW5nczoge1xuICAgICAgICBmbG93czogREVGQVVMVFMuT0FVVEhfRkxPV1MsXG4gICAgICB9LFxuICAgIH07XG4gICAgLy8gZXh0ZXJuYWwgcHJvdmlkZXJzXG4gICAgY29uc3QgZXh0ZXJuYWwgPSBsb2dpbk9wdGlvbnMuZXh0ZXJuYWxQcm92aWRlcnM7XG4gICAgaWYgKCFleHRlcm5hbCkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgLy8gbWFrZSBzdXJlIGxvZ291dC9jYWxsYmFjayB1cmxzIGFyZSBub3QgZW1wdHlcbiAgICBpZiAoZXh0ZXJuYWwubG9nb3V0VXJscyAmJiBleHRlcm5hbC5sb2dvdXRVcmxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICdZb3UgbXVzdCBkZWZpbmUgbG9nb3V0VXJscyB3aGVuIGNvbmZpZ3VyaW5nIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycy4nXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuY2FsbGJhY2tVcmxzICYmIGV4dGVybmFsLmNhbGxiYWNrVXJscy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAnWW91IG11c3QgZGVmaW5lIGNhbGxiYWNrVXJscyB3aGVuIGNvbmZpZ3VyaW5nIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycy4nXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuZ29vZ2xlKSB7XG4gICAgICBjb25zdCBnb29nbGVQcm9wcyA9IGV4dGVybmFsLmdvb2dsZTtcbiAgICAgIHJlc3VsdC5nb29nbGUgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1Hb29nbGVJZFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgY2xpZW50SWQ6IGdvb2dsZVByb3BzLmNsaWVudElkLFxuICAgICAgICAgIGNsaWVudFNlY3JldFZhbHVlOiBnb29nbGVQcm9wcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBQcm92aWRlckF0dHJpYnV0ZS5HT09HTEVfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBnb29nbGVQcm9wcy5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2NvcGVzOiBnb29nbGVQcm9wcy5zY29wZXMsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1tvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcC5nb29nbGVdID1cbiAgICAgICAgZXh0ZXJuYWwuZ29vZ2xlLmNsaWVudElkO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuZmFjZWJvb2spIHtcbiAgICAgIHJlc3VsdC5mYWNlYm9vayA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9RmFjZWJvb2tJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwuZmFjZWJvb2ssXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBQcm92aWRlckF0dHJpYnV0ZS5GQUNFQk9PS19FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGV4dGVybmFsLmZhY2Vib29rLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmZhY2Vib29rXSA9XG4gICAgICAgIGV4dGVybmFsLmZhY2Vib29rLmNsaWVudElkO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uKSB7XG4gICAgICByZXN1bHQuYW1hem9uID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QW1hem9uSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbixcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkFNQVpPTl9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbi5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1tvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcC5hbWF6b25dID1cbiAgICAgICAgZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uLmNsaWVudElkO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlKSB7XG4gICAgICByZXN1bHQuYXBwbGUgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBcHBsZShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUFwcGxlSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLnNpZ25JbldpdGhBcHBsZSxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkFQUExFX0VNQUlMLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICAgICksXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHJlc3VsdC5vQXV0aE1hcHBpbmdzW29hdXRoUHJvdmlkZXJUb1Byb3ZpZGVyRG9tYWluTWFwLmFwcGxlXSA9XG4gICAgICAgIGV4dGVybmFsLnNpZ25JbldpdGhBcHBsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLm9pZGMgJiYgZXh0ZXJuYWwub2lkYy5sZW5ndGggPiAwKSB7XG4gICAgICByZXN1bHQub2lkYyA9IFtdO1xuICAgICAgZXh0ZXJuYWwub2lkYy5mb3JFYWNoKChwcm92aWRlciwgaW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdE1ldGhvZCA9XG4gICAgICAgICAgcHJvdmlkZXIuYXR0cmlidXRlUmVxdWVzdE1ldGhvZCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICA/ICdHRVQnIC8vIGRlZmF1bHQgaWYgbm90IGRlZmluZWRcbiAgICAgICAgICAgIDogcHJvdmlkZXIuYXR0cmlidXRlUmVxdWVzdE1ldGhvZDtcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVkUHJvdmlkZXIgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfSR7cHJvdmlkZXIubmFtZSA/PyBpbmRleH1PaWRjSURQYCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAgIGF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q6XG4gICAgICAgICAgICAgIHJlcXVlc3RNZXRob2QgPT09ICdHRVQnXG4gICAgICAgICAgICAgICAgPyBPaWRjQXR0cmlidXRlUmVxdWVzdE1ldGhvZC5HRVRcbiAgICAgICAgICAgICAgICA6IE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLlBPU1QsXG4gICAgICAgICAgICBjbGllbnRJZDogcHJvdmlkZXIuY2xpZW50SWQsXG4gICAgICAgICAgICBjbGllbnRTZWNyZXQ6IHByb3ZpZGVyLmNsaWVudFNlY3JldCxcbiAgICAgICAgICAgIGVuZHBvaW50czogcHJvdmlkZXIuZW5kcG9pbnRzLFxuICAgICAgICAgICAgaWRlbnRpZmllcnM6IHByb3ZpZGVyLmlkZW50aWZpZXJzLFxuICAgICAgICAgICAgaXNzdWVyVXJsOiBwcm92aWRlci5pc3N1ZXJVcmwsXG4gICAgICAgICAgICBuYW1lOiBwcm92aWRlci5uYW1lLFxuICAgICAgICAgICAgc2NvcGVzOiBwcm92aWRlci5zY29wZXMsXG4gICAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHtcbiAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiAnZW1haWwnLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgICBwcm92aWRlci5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgcmVzdWx0Lm9pZGM/LnB1c2goZ2VuZXJhdGVkUHJvdmlkZXIpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5zYW1sKSB7XG4gICAgICBjb25zdCBzYW1sID0gZXh0ZXJuYWwuc2FtbDtcbiAgICAgIHJlc3VsdC5zYW1sID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfVNhbWxJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzogdGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgIHNhbWwuYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICksXG4gICAgICAgICAgaWRlbnRpZmllcnM6IHNhbWwuaWRlbnRpZmllcnMsXG4gICAgICAgICAgaWRwU2lnbm91dDogc2FtbC5pZHBTaWdub3V0LFxuICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICBtZXRhZGF0YUNvbnRlbnQ6IHNhbWwubWV0YWRhdGEubWV0YWRhdGFDb250ZW50LFxuICAgICAgICAgICAgbWV0YWRhdGFUeXBlOlxuICAgICAgICAgICAgICBzYW1sLm1ldGFkYXRhLm1ldGFkYXRhVHlwZSA9PT0gJ0ZJTEUnXG4gICAgICAgICAgICAgICAgPyBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sTWV0YWRhdGFUeXBlLkZJTEVcbiAgICAgICAgICAgICAgICA6IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUuVVJMLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbmFtZTogc2FtbC5uYW1lLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEFsd2F5cyBnZW5lcmF0ZSBhIGRvbWFpbiBwcmVmaXggaWYgZXh0ZXJuYWwgcHJvdmlkZXIgaXMgY29uZmlndXJlZFxuICAgIGlmICh0aGlzLmRvbWFpblByZWZpeCkge1xuICAgICAgdGhpcy51c2VyUG9vbC5hZGREb21haW4oYCR7dGhpcy5uYW1lfVVzZXJQb29sRG9tYWluYCwge1xuICAgICAgICBjb2duaXRvRG9tYWluOiB7IGRvbWFpblByZWZpeDogdGhpcy5kb21haW5QcmVmaXggfSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdDb2duaXRvIERvbWFpbiBQcmVmaXggaXMgbWlzc2luZyB3aGVuIGV4dGVybmFsIHByb3ZpZGVycyBhcmUgY29uZmlndXJlZC4nXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIG9hdXRoIHNldHRpbmdzIGZvciB0aGUgVXNlclBvb2wgY2xpZW50XG4gICAgcmVzdWx0Lm9BdXRoU2V0dGluZ3MgPSB7XG4gICAgICBjYWxsYmFja1VybHM6IGV4dGVybmFsLmNhbGxiYWNrVXJscyxcbiAgICAgIGxvZ291dFVybHM6IGV4dGVybmFsLmxvZ291dFVybHMsXG4gICAgICBzY29wZXM6IGV4dGVybmFsLnNjb3Blc1xuICAgICAgICA/IHRoaXMuZ2V0T0F1dGhTY29wZXMoZXh0ZXJuYWwuc2NvcGVzKVxuICAgICAgICA6IERFRkFVTFRfT0FVVEhfU0NPUEVTLFxuICAgICAgZmxvd3M6IERFRkFVTFRTLk9BVVRIX0ZMT1dTLFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aGUgc2ltcGxpZmllZCBtYXBwaW5nIHR5cGUgdG8gY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nLlxuICAgKiBAcGFyYW0gbWFwcGluZyB0aGUgQXR0cmlidXRlTWFwcGluZyB0byBjb252ZXJ0IHRvIGEgY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nXG4gICAqIEByZXR1cm5zIGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZ1xuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyA9IChcbiAgICBtYXBwaW5nPzogQXR0cmlidXRlTWFwcGluZ1xuICApOiBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmcgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmICghbWFwcGluZykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICB8IFByb3ZpZGVyQXR0cmlidXRlXG4gICAgICB8IHtcbiAgICAgICAgICBba2V5OiBzdHJpbmddOiBQcm92aWRlckF0dHJpYnV0ZTtcbiAgICAgICAgfVxuICAgID4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFthdHRyTmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG1hcHBpbmcpKSB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICByZXN1bHRbYXR0ck5hbWVdID0ge1xuICAgICAgICAgIGF0dHJpYnV0ZU5hbWU6IHZhbHVlLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgYXR0ck5hbWUgPT09ICdjdXN0b20nKSB7XG4gICAgICAgIC8vIGRlYWxpbmcgd2l0aCBjdXN0b20gYXR0cmlidXRlc1xuICAgICAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVzOiBSZWNvcmQ8c3RyaW5nLCBQcm92aWRlckF0dHJpYnV0ZT4gPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCBbY3VzdG9tS2V5LCBhdHRyTmFtZV0gb2YgT2JqZWN0LmVudHJpZXModmFsdWUpKSB7XG4gICAgICAgICAgY3VzdG9tQXR0cmlidXRlc1tjdXN0b21LZXldID0ge1xuICAgICAgICAgICAgYXR0cmlidXRlTmFtZTogYXR0ck5hbWUsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHRbYXR0ck5hbWVdID0gY3VzdG9tQXR0cmlidXRlcztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcbiAgLyoqXG4gICAqIENvbnZlcnQgc2NvcGVzIGZyb20gc3RyaW5nIGxpc3QgdG8gT0F1dGhTY29wZXMuXG4gICAqIEBwYXJhbSBzY29wZXMgLSBzY29wZSBsaXN0XG4gICAqIEByZXR1cm5zIGNvZ25pdG8gT0F1dGhTY29wZXNcbiAgICovXG4gIHByaXZhdGUgZ2V0T0F1dGhTY29wZXMgPSAoXG4gICAgc2NvcGVzOiBFeHRlcm5hbFByb3ZpZGVyT3B0aW9uc1snc2NvcGVzJ11cbiAgKTogY29nbml0by5PQXV0aFNjb3BlW10gPT4ge1xuICAgIGlmIChzY29wZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQ6IGNvZ25pdG8uT0F1dGhTY29wZVtdID0gW107XG4gICAgZm9yIChjb25zdCBzY29wZSBvZiBzY29wZXMpIHtcbiAgICAgIHJlc3VsdC5wdXNoKGNvZ25pdG8uT0F1dGhTY29wZVtzY29wZV0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8qKlxuICAgKiBTdG9yZXMgYXV0aCBvdXRwdXQgdXNpbmcgdGhlIHByb3ZpZGVkIHN0cmF0ZWd5XG4gICAqL1xuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxBdXRoT3V0cHV0PiA9IG5ldyBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneShcbiAgICAgIFN0YWNrLm9mKHRoaXMpXG4gICAgKVxuICApOiB2b2lkID0+IHtcbiAgICBjb25zdCBjZm5Vc2VyUG9vbCA9IHRoaXMucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5Vc2VyUG9vbDtcbiAgICBjb25zdCBjZm5Vc2VyUG9vbENsaWVudCA9IHRoaXMucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5Vc2VyUG9vbENsaWVudDtcbiAgICBjb25zdCBjZm5JZGVudGl0eVBvb2wgPSB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuSWRlbnRpdHlQb29sO1xuICAgIC8vIHRoZXNlIHByb3BlcnRpZXMgY2Fubm90IGJlIG92ZXJ3cml0dGVuXG4gICAgY29uc3Qgb3V0cHV0OiBBdXRoT3V0cHV0WydwYXlsb2FkJ10gPSB7XG4gICAgICB1c2VyUG9vbElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgd2ViQ2xpZW50SWQ6IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICBpZGVudGl0eVBvb2xJZDogY2ZuSWRlbnRpdHlQb29sLnJlZixcbiAgICAgIGF1dGhSZWdpb246IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbixcbiAgICB9O1xuXG4gICAgLy8gdGhlIHByb3BlcnRpZXMgYmVsb3cgdGhpcyBsaW5lIGNhbiBiZSBvdmVyd3JpdHRlbiwgc28gdGhleSBhcmUgZXhwb3NlZCB2aWEgY2RrIExBWllcbiAgICBvdXRwdXQuYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT5cbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sLmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyA9PT0gdHJ1ZVxuICAgICAgICAgID8gJ3RydWUnXG4gICAgICAgICAgOiAnZmFsc2UnLFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCBzaWdudXBBdHRyaWJ1dGVzIGZyb20gVXNlclBvb2wgc2NoZW1hJ3MgcmVxdWlyZWQgYXR0cmlidXRlc1xuICAgIG91dHB1dC5zaWdudXBBdHRyaWJ1dGVzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBpZiAoIWNmblVzZXJQb29sLnNjaGVtYSkge1xuICAgICAgICAgIHJldHVybiAnW10nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAoY2ZuVXNlclBvb2wuc2NoZW1hIGFzIENmblVzZXJQb29sLlNjaGVtYUF0dHJpYnV0ZVByb3BlcnR5W10pXG4gICAgICAgICAgICAuZmlsdGVyKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5yZXF1aXJlZCAmJiBhdHRyaWJ1dGUubmFtZSlcbiAgICAgICAgICAgIC5tYXAoKGF0dHJpYnV0ZSkgPT4gYXR0cmlidXRlLm5hbWU/LnRvTG93ZXJDYXNlKCkpXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCB1c2VybmFtZUF0dHJpYnV0ZXMgZnJvbSBVc2VyUG9vbCdzIHVzZXJuYW1lQXR0cmlidXRlc1xuICAgIG91dHB1dC51c2VybmFtZUF0dHJpYnV0ZXMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICBjZm5Vc2VyUG9vbC51c2VybmFtZUF0dHJpYnV0ZXM/Lm1hcCgoYXR0cikgPT4gYXR0ci50b0xvd2VyQ2FzZSgpKSB8fFxuICAgICAgICAgICAgW11cbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgZnJvbSBVc2VyUG9vbCdzIGF1dG9WZXJpZmllZEF0dHJpYnV0ZXNcbiAgICBvdXRwdXQudmVyaWZpY2F0aW9uTWVjaGFuaXNtcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNmblVzZXJQb29sLmF1dG9WZXJpZmllZEF0dHJpYnV0ZXMgPz8gW10pO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3QgdGhlIHBhc3N3b3JkUG9saWN5IGZyb20gdGhlIFVzZXJQb29sIHBvbGljaWVzXG4gICAgb3V0cHV0LnBhc3N3b3JkUG9saWN5TWluTGVuZ3RoID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBpZiAoIWNmblVzZXJQb29sLnBvbGljaWVzKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBvbGljeSA9IChjZm5Vc2VyUG9vbC5wb2xpY2llcyBhcyBDZm5Vc2VyUG9vbC5Qb2xpY2llc1Byb3BlcnR5KVxuICAgICAgICAgIC5wYXNzd29yZFBvbGljeSBhcyBDZm5Vc2VyUG9vbC5QYXNzd29yZFBvbGljeVByb3BlcnR5O1xuICAgICAgICByZXR1cm4gcG9saWN5Lm1pbmltdW1MZW5ndGg/LnRvU3RyaW5nKCk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0LnBhc3N3b3JkUG9saWN5UmVxdWlyZW1lbnRzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBpZiAoIWNmblVzZXJQb29sLnBvbGljaWVzKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBvbGljeSA9IChjZm5Vc2VyUG9vbC5wb2xpY2llcyBhcyBDZm5Vc2VyUG9vbC5Qb2xpY2llc1Byb3BlcnR5KVxuICAgICAgICAgIC5wYXNzd29yZFBvbGljeSBhcyBDZm5Vc2VyUG9vbC5QYXNzd29yZFBvbGljeVByb3BlcnR5O1xuICAgICAgICBjb25zdCByZXF1aXJlbWVudHMgPSBbXTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVOdW1iZXJzICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19OVU1CRVJTJyk7XG4gICAgICAgIHBvbGljeS5yZXF1aXJlTG93ZXJjYXNlICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19MT1dFUkNBU0UnKTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVVcHBlcmNhc2UgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgICAgICBwb2xpY3kucmVxdWlyZVN5bWJvbHMgJiYgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1NZTUJPTFMnKTtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlcXVpcmVtZW50cyk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCB0aGUgTUZBIGNvbmZpZ3VyYXRpb24gc2V0dGluZyBmcm9tIHRoZSBVc2VyUG9vbCByZXNvdXJjZVxuICAgIG91dHB1dC5tZmFDb25maWd1cmF0aW9uID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2wubWZhQ29uZmlndXJhdGlvbiA/PyAnT0ZGJztcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgLy8gZXh0cmFjdCB0aGUgTUZBIHR5cGVzIGZyb20gdGhlIFVzZXJQb29sIHJlc291cmNlXG4gICAgb3V0cHV0Lm1mYVR5cGVzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBtZmFUeXBlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgKGNmblVzZXJQb29sLmVuYWJsZWRNZmFzID8/IFtdKS5mb3JFYWNoKCh0eXBlKSA9PiB7XG4gICAgICAgICAgaWYgKHR5cGUgPT09ICdTTVNfTUZBJykge1xuICAgICAgICAgICAgbWZhVHlwZXMucHVzaCgnU01TJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0eXBlID09PSAnU09GVFdBUkVfVE9LRU5fTUZBJykge1xuICAgICAgICAgICAgbWZhVHlwZXMucHVzaCgnVE9UUCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShtZmFUeXBlcyk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCBzb2NpYWwgcHJvdmlkZXJzIGZyb20gVXNlclBvb2wgcmVzb3VyY2VcbiAgICBvdXRwdXQuc29jaWFsUHJvdmlkZXJzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCBvdXRwdXRQcm92aWRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IHVzZXJQb29sUHJvdmlkZXJzID0gdGhpcy5yZXNvdXJjZXMudXNlclBvb2wuaWRlbnRpdHlQcm92aWRlcnM7XG4gICAgICAgIGlmICghdXNlclBvb2xQcm92aWRlcnMgfHwgdXNlclBvb2xQcm92aWRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgcHJvdmlkZXIgb2YgdXNlclBvb2xQcm92aWRlcnMpIHtcbiAgICAgICAgICBjb25zdCBwcm92aWRlclJlc291cmNlID0gcHJvdmlkZXIubm9kZS5maW5kQ2hpbGQoXG4gICAgICAgICAgICAnUmVzb3VyY2UnXG4gICAgICAgICAgKSBhcyBDZm5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXI7XG4gICAgICAgICAgaWYgKCEocHJvdmlkZXJSZXNvdXJjZSBpbnN0YW5jZW9mIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlcikpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgICAgICAnQ291bGQgbm90IGZpbmQgdGhlIENmblVzZXJQb29sSWRlbnRpdHlQcm92aWRlciByZXNvdXJjZSBpbiB0aGUgc3RhY2suJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJUeXBlID0gcHJvdmlkZXJSZXNvdXJjZS5wcm92aWRlclR5cGU7XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvdmlkZXJSZXNvdXJjZS5wcm92aWRlck5hbWU7XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0dvb2dsZScpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKCdHT09HTEUnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ0ZhY2Vib29rJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2goJ0ZBQ0VCT09LJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdTaWduSW5XaXRoQXBwbGUnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnU0lHTl9JTl9XSVRIX0FQUExFJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdMb2dpbldpdGhBbWF6b24nKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnTE9HSU5fV0lUSF9BTUFaT04nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ09JREMnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaChwcm92aWRlck5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnU0FNTCcpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvdXRwdXRQcm92aWRlcnMpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aENvZ25pdG9Eb21haW4gPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzZXJQb29sRG9tYWluID0gdGhpcy5yZXNvdXJjZXMudXNlclBvb2wubm9kZS50cnlGaW5kQ2hpbGQoXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfVVzZXJQb29sRG9tYWluYFxuICAgICAgICApO1xuICAgICAgICBpZiAoIXVzZXJQb29sRG9tYWluKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGlmICghKHVzZXJQb29sRG9tYWluIGluc3RhbmNlb2YgVXNlclBvb2xEb21haW4pKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIFVzZXJQb29sRG9tYWluIHJlc291cmNlIGluIHRoZSBzdGFjay4nKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYCR7dXNlclBvb2xEb21haW4uZG9tYWluTmFtZX0uYXV0aC4ke1xuICAgICAgICAgIFN0YWNrLm9mKHRoaXMpLnJlZ2lvblxuICAgICAgICB9LmFtYXpvbmNvZ25pdG8uY29tYDtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhTY29wZSA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNmblVzZXJQb29sQ2xpZW50LmFsbG93ZWRPQXV0aFNjb3BlcyA/PyBbXSk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoUmVkaXJlY3RTaWduSW4gPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5jYWxsYmFja1VyTHNcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmNhbGxiYWNrVXJMcy5qb2luKCcsJylcbiAgICAgICAgICA6ICcnO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aFJlZGlyZWN0U2lnbk91dCA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNmblVzZXJQb29sQ2xpZW50LmxvZ291dFVyTHNcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmxvZ291dFVyTHMuam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhSZXNwb25zZVR5cGUgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5hbGxvd2VkT0F1dGhGbG93c1xuICAgICAgICAgID8gY2ZuVXNlclBvb2xDbGllbnQuYWxsb3dlZE9BdXRoRmxvd3Muam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhDbGllbnRJZCA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNmblVzZXJQb29sQ2xpZW50LnJlZjtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyB1c2VyIGdyb3VwIHByZWNlZGVuY2UgY2FuIGJlIG92ZXJ3cml0dGVuLCBzbyB0aGV5IGFyZSBleHBvc2VkIHZpYSBjZGsgTEFaWVxuICAgIG91dHB1dC5ncm91cHMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGdyb3Vwc0FycmF5OiB7XG4gICAgICAgICAgW2tleTogc3RyaW5nXToge1xuICAgICAgICAgICAgcHJlY2VkZW5jZT86IG51bWJlcjtcbiAgICAgICAgICB9O1xuICAgICAgICB9W10gPSBbXTtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5yZXNvdXJjZXMuZ3JvdXBzKS5mb3JFYWNoKChncm91cE5hbWUpID0+IHtcbiAgICAgICAgICBjb25zdCBwcmVjZWRlbmNlID1cbiAgICAgICAgICAgIHRoaXMucmVzb3VyY2VzLmdyb3Vwc1tncm91cE5hbWVdLmNmblVzZXJHcm91cC5wcmVjZWRlbmNlO1xuICAgICAgICAgIGdyb3Vwc0FycmF5LnB1c2goe1xuICAgICAgICAgICAgW2dyb3VwTmFtZV06IHtcbiAgICAgICAgICAgICAgcHJlY2VkZW5jZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIHsgcHJlY2VkZW5jZT86IG51bWJlciB9Pik7XG5cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGdyb3Vwc0FycmF5KTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KGF1dGhPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IG91dHB1dCxcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==