import { GetObjectCommand, NoSuchKey, S3Client, S3ServiceException, } from '@aws-sdk/client-s3';
const isDataClientEnv = (env) => {
    return (env !== null &&
        typeof env === 'object' &&
        'AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME' in env &&
        'AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_KEY' in env &&
        'AWS_ACCESS_KEY_ID' in env &&
        'AWS_SECRET_ACCESS_KEY' in env &&
        'AWS_SESSION_TOKEN' in env &&
        'AWS_REGION' in env &&
        'AMPLIFY_DATA_GRAPHQL_ENDPOINT' in env &&
        typeof env.AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME ===
            'string' &&
        typeof env.AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_KEY === 'string' &&
        typeof env.AWS_ACCESS_KEY_ID === 'string' &&
        typeof env.AWS_SECRET_ACCESS_KEY === 'string' &&
        typeof env.AWS_SESSION_TOKEN === 'string' &&
        typeof env.AWS_REGION === 'string' &&
        typeof env.AMPLIFY_DATA_GRAPHQL_ENDPOINT === 'string');
};
/* eslint-enable @typescript-eslint/naming-convention */
const getResourceConfig = (env, modelIntrospectionSchema) => {
    return {
        API: {
            GraphQL: {
                endpoint: env.AMPLIFY_DATA_GRAPHQL_ENDPOINT,
                region: env.AWS_REGION,
                defaultAuthMode: 'iam',
                modelIntrospection: modelIntrospectionSchema,
            },
        },
    };
};
const getLibraryOptions = (env) => {
    return {
        Auth: {
            credentialsProvider: {
                getCredentialsAndIdentityId: async () => ({
                    credentials: {
                        accessKeyId: env.AWS_ACCESS_KEY_ID,
                        secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
                        sessionToken: env.AWS_SESSION_TOKEN,
                    },
                }),
                clearCredentialsAndIdentityId: () => {
                    /* noop */
                },
            },
        },
    };
};
/**
 * Generate the `resourceConfig` and `libraryOptions` need to configure
 * Amplify for the data client in a lambda.
 *
 * Your function needs to be granted resource access on your schema for this to work
 * `a.schema(...).authorization((allow) => [a.resource(myFunction)])`
 * @param env - The environment variables for the data client
 * @returns An object containing the `resourceConfig` and `libraryOptions`
 */
export const getAmplifyDataClientConfig = async (env, s3Client) => {
    if (!s3Client) {
        s3Client = new S3Client();
    }
    if (!isDataClientEnv(env)) {
        return { resourceConfig: {}, libraryOptions: {} };
    }
    let modelIntrospectionSchema;
    try {
        const response = await s3Client.send(new GetObjectCommand({
            Bucket: env.AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME,
            Key: env.AMPLIFY_DATA_MODEL_INTROSPECTION_SCHEMA_KEY,
        }));
        const modelIntrospectionSchemaJson = await response.Body?.transformToString();
        modelIntrospectionSchema = JSON.parse(modelIntrospectionSchemaJson ?? '{}');
    }
    catch (caught) {
        if (caught instanceof NoSuchKey) {
            throw new Error('Error retrieving the schema from S3. Please confirm that your project has a `defineData` included in the `defineBackend` definition.');
        }
        else if (caught instanceof S3ServiceException) {
            throw new Error(`Error retrieving the schema from S3. You may need to grant this function authorization on the schema. ${caught.name}: ${caught.message}.`);
        }
        else {
            throw caught;
        }
    }
    const libraryOptions = getLibraryOptions(env);
    const resourceConfig = getResourceConfig(env, modelIntrospectionSchema);
    return { resourceConfig, libraryOptions };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bnRpbWUvZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsU0FBUyxFQUNULFFBQVEsRUFDUixrQkFBa0IsR0FDbkIsTUFBTSxvQkFBb0IsQ0FBQztBQWM1QixNQUFNLGVBQWUsR0FBRyxDQUFDLEdBQVksRUFBd0IsRUFBRTtJQUM3RCxPQUFPLENBQ0wsR0FBRyxLQUFLLElBQUk7UUFDWixPQUFPLEdBQUcsS0FBSyxRQUFRO1FBQ3ZCLHFEQUFxRCxJQUFJLEdBQUc7UUFDNUQsNkNBQTZDLElBQUksR0FBRztRQUNwRCxtQkFBbUIsSUFBSSxHQUFHO1FBQzFCLHVCQUF1QixJQUFJLEdBQUc7UUFDOUIsbUJBQW1CLElBQUksR0FBRztRQUMxQixZQUFZLElBQUksR0FBRztRQUNuQiwrQkFBK0IsSUFBSSxHQUFHO1FBQ3RDLE9BQU8sR0FBRyxDQUFDLG1EQUFtRDtZQUM1RCxRQUFRO1FBQ1YsT0FBTyxHQUFHLENBQUMsMkNBQTJDLEtBQUssUUFBUTtRQUNuRSxPQUFPLEdBQUcsQ0FBQyxpQkFBaUIsS0FBSyxRQUFRO1FBQ3pDLE9BQU8sR0FBRyxDQUFDLHFCQUFxQixLQUFLLFFBQVE7UUFDN0MsT0FBTyxHQUFHLENBQUMsaUJBQWlCLEtBQUssUUFBUTtRQUN6QyxPQUFPLEdBQUcsQ0FBQyxVQUFVLEtBQUssUUFBUTtRQUNsQyxPQUFPLEdBQUcsQ0FBQyw2QkFBNkIsS0FBSyxRQUFRLENBQ3RELENBQUM7QUFDSixDQUFDLENBQUM7QUFnQkYsd0RBQXdEO0FBRXhELE1BQU0saUJBQWlCLEdBQUcsQ0FDeEIsR0FBa0IsRUFDbEIsd0JBQWdDLEVBQ2hCLEVBQUU7SUFDbEIsT0FBTztRQUNMLEdBQUcsRUFBRTtZQUNILE9BQU8sRUFBRTtnQkFDUCxRQUFRLEVBQUUsR0FBRyxDQUFDLDZCQUE2QjtnQkFDM0MsTUFBTSxFQUFFLEdBQUcsQ0FBQyxVQUFVO2dCQUN0QixlQUFlLEVBQUUsS0FBYztnQkFFL0Isa0JBQWtCLEVBQUUsd0JBQXdCO2FBQzdDO1NBQ0Y7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBa0JGLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxHQUFrQixFQUFrQixFQUFFO0lBQy9ELE9BQU87UUFDTCxJQUFJLEVBQUU7WUFDSixtQkFBbUIsRUFBRTtnQkFDbkIsMkJBQTJCLEVBQUUsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUN4QyxXQUFXLEVBQUU7d0JBQ1gsV0FBVyxFQUFFLEdBQUcsQ0FBQyxpQkFBaUI7d0JBQ2xDLGVBQWUsRUFBRSxHQUFHLENBQUMscUJBQXFCO3dCQUMxQyxZQUFZLEVBQUUsR0FBRyxDQUFDLGlCQUFpQjtxQkFDcEM7aUJBQ0YsQ0FBQztnQkFDRiw2QkFBNkIsRUFBRSxHQUFHLEVBQUU7b0JBQ2xDLFVBQVU7Z0JBQ1osQ0FBQzthQUNGO1NBQ0Y7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBb0JGOzs7Ozs7OztHQVFHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sMEJBQTBCLEdBQUcsS0FBSyxFQUM3QyxHQUFNLEVBQ04sUUFBbUIsRUFDVyxFQUFFO0lBQ2hDLElBQUksQ0FBQyxRQUFRLEVBQUU7UUFDYixRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztLQUMzQjtJQUVELElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDekIsT0FBTyxFQUFFLGNBQWMsRUFBRSxFQUFFLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBeUIsQ0FBQztLQUMxRTtJQUNELElBQUksd0JBQWdDLENBQUM7SUFFckMsSUFBSTtRQUNGLE1BQU0sUUFBUSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FDbEMsSUFBSSxnQkFBZ0IsQ0FBQztZQUNuQixNQUFNLEVBQUUsR0FBRyxDQUFDLG1EQUFtRDtZQUMvRCxHQUFHLEVBQUUsR0FBRyxDQUFDLDJDQUEyQztTQUNyRCxDQUFDLENBQ0gsQ0FBQztRQUNGLE1BQU0sNEJBQTRCLEdBQ2hDLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxDQUFDO1FBQzNDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsNEJBQTRCLElBQUksSUFBSSxDQUFDLENBQUM7S0FDN0U7SUFBQyxPQUFPLE1BQU0sRUFBRTtRQUNmLElBQUksTUFBTSxZQUFZLFNBQVMsRUFBRTtZQUMvQixNQUFNLElBQUksS0FBSyxDQUNiLHNJQUFzSSxDQUN2SSxDQUFDO1NBQ0g7YUFBTSxJQUFJLE1BQU0sWUFBWSxrQkFBa0IsRUFBRTtZQUMvQyxNQUFNLElBQUksS0FBSyxDQUNiLHlHQUF5RyxNQUFNLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FDM0ksQ0FBQztTQUNIO2FBQU07WUFDTCxNQUFNLE1BQU0sQ0FBQztTQUNkO0tBQ0Y7SUFFRCxNQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUU5QyxNQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztJQUV4RSxPQUFPLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBeUIsQ0FBQztBQUNuRSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBHZXRPYmplY3RDb21tYW5kLFxuICBOb1N1Y2hLZXksXG4gIFMzQ2xpZW50LFxuICBTM1NlcnZpY2VFeGNlcHRpb24sXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5cbmV4cG9ydCB0eXBlIERhdGFDbGllbnRFbnYgPSB7XG4gIC8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBTVBMSUZZX0RBVEFfR1JBUEhRTF9FTkRQT0lOVDogc3RyaW5nO1xuICBBTVBMSUZZX0RBVEFfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfQlVDS0VUX05BTUU6IHN0cmluZztcbiAgQU1QTElGWV9EQVRBX01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0tFWTogc3RyaW5nO1xuICBBV1NfQUNDRVNTX0tFWV9JRDogc3RyaW5nO1xuICBBV1NfU0VDUkVUX0FDQ0VTU19LRVk6IHN0cmluZztcbiAgQVdTX1NFU1NJT05fVE9LRU46IHN0cmluZztcbiAgQVdTX1JFR0lPTjogc3RyaW5nO1xuICAvKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xufTtcblxuY29uc3QgaXNEYXRhQ2xpZW50RW52ID0gKGVudjogdW5rbm93bik6IGVudiBpcyBEYXRhQ2xpZW50RW52ID0+IHtcbiAgcmV0dXJuIChcbiAgICBlbnYgIT09IG51bGwgJiZcbiAgICB0eXBlb2YgZW52ID09PSAnb2JqZWN0JyAmJlxuICAgICdBTVBMSUZZX0RBVEFfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfQlVDS0VUX05BTUUnIGluIGVudiAmJlxuICAgICdBTVBMSUZZX0RBVEFfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfS0VZJyBpbiBlbnYgJiZcbiAgICAnQVdTX0FDQ0VTU19LRVlfSUQnIGluIGVudiAmJlxuICAgICdBV1NfU0VDUkVUX0FDQ0VTU19LRVknIGluIGVudiAmJlxuICAgICdBV1NfU0VTU0lPTl9UT0tFTicgaW4gZW52ICYmXG4gICAgJ0FXU19SRUdJT04nIGluIGVudiAmJlxuICAgICdBTVBMSUZZX0RBVEFfR1JBUEhRTF9FTkRQT0lOVCcgaW4gZW52ICYmXG4gICAgdHlwZW9mIGVudi5BTVBMSUZZX0RBVEFfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfQlVDS0VUX05BTUUgPT09XG4gICAgICAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBlbnYuQU1QTElGWV9EQVRBX01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0tFWSA9PT0gJ3N0cmluZycgJiZcbiAgICB0eXBlb2YgZW52LkFXU19BQ0NFU1NfS0VZX0lEID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBlbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBlbnYuQVdTX1NFU1NJT05fVE9LRU4gPT09ICdzdHJpbmcnICYmXG4gICAgdHlwZW9mIGVudi5BV1NfUkVHSU9OID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBlbnYuQU1QTElGWV9EQVRBX0dSQVBIUUxfRU5EUE9JTlQgPT09ICdzdHJpbmcnXG4gICk7XG59O1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb24gKi9cbmV4cG9ydCB0eXBlIFJlc291cmNlQ29uZmlnID0ge1xuICBBUEk6IHtcbiAgICBHcmFwaFFMOiB7XG4gICAgICBlbmRwb2ludDogc3RyaW5nO1xuICAgICAgcmVnaW9uOiBzdHJpbmc7XG4gICAgICBkZWZhdWx0QXV0aE1vZGU6ICdpYW0nO1xuICAgICAgLy8gVXNpbmcgYGFueWAgdG8gYXZvaWQgcmVwcm9kdWNpbmcgMTAwKyBsaW5lcyBvZiB0eXBpbmcgdG8gbWF0Y2ggdGhlIGV4cGVjdGVkIHNoYXBlIGRlZmluZWQgaW4gYXdzLWFtcGxpZnk6XG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXdzLWFtcGxpZnkvYW1wbGlmeS1qcy9ibG9iL21haW4vcGFja2FnZXMvY29yZS9zcmMvc2luZ2xldG9uL0FQSS90eXBlcy50cyNMMTQzLUwxNTNcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICBtb2RlbEludHJvc3BlY3Rpb246IGFueTtcbiAgICB9O1xuICB9O1xufTtcbi8qIGVzbGludC1lbmFibGUgQHR5cGVzY3JpcHQtZXNsaW50L25hbWluZy1jb252ZW50aW9uICovXG5cbmNvbnN0IGdldFJlc291cmNlQ29uZmlnID0gKFxuICBlbnY6IERhdGFDbGllbnRFbnYsXG4gIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYTogb2JqZWN0XG4pOiBSZXNvdXJjZUNvbmZpZyA9PiB7XG4gIHJldHVybiB7XG4gICAgQVBJOiB7XG4gICAgICBHcmFwaFFMOiB7XG4gICAgICAgIGVuZHBvaW50OiBlbnYuQU1QTElGWV9EQVRBX0dSQVBIUUxfRU5EUE9JTlQsXG4gICAgICAgIHJlZ2lvbjogZW52LkFXU19SRUdJT04sXG4gICAgICAgIGRlZmF1bHRBdXRoTW9kZTogJ2lhbScgYXMgY29uc3QsXG5cbiAgICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEsXG4gICAgICB9LFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBMaWJyYXJ5T3B0aW9ucyA9IHtcbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBdXRoOiB7XG4gICAgY3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiBQcm9taXNlPHtcbiAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICBhY2Nlc3NLZXlJZDogc3RyaW5nO1xuICAgICAgICAgIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nO1xuICAgICAgICAgIHNlc3Npb25Ub2tlbjogc3RyaW5nO1xuICAgICAgICB9O1xuICAgICAgfT47XG4gICAgICBjbGVhckNyZWRlbnRpYWxzQW5kSWRlbnRpdHlJZDogKCkgPT4gdm9pZDtcbiAgICB9O1xuICB9O1xufTtcblxuY29uc3QgZ2V0TGlicmFyeU9wdGlvbnMgPSAoZW52OiBEYXRhQ2xpZW50RW52KTogTGlicmFyeU9wdGlvbnMgPT4ge1xuICByZXR1cm4ge1xuICAgIEF1dGg6IHtcbiAgICAgIGNyZWRlbnRpYWxzUHJvdmlkZXI6IHtcbiAgICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiBhc3luYyAoKSA9PiAoe1xuICAgICAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgICAgICBhY2Nlc3NLZXlJZDogZW52LkFXU19BQ0NFU1NfS0VZX0lELFxuICAgICAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBlbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZLFxuICAgICAgICAgICAgc2Vzc2lvblRva2VuOiBlbnYuQVdTX1NFU1NJT05fVE9LRU4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIGNsZWFyQ3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiB7XG4gICAgICAgICAgLyogbm9vcCAqL1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgSW52YWxpZENvbmZpZyA9IHVua25vd24gJiB7XG4gIGludmFsaWRUeXBlOiAnVGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSBncmFudGVkIGBhdXRob3JpemF0aW9uKChhbGxvdykgPT4gW2FsbG93LnJlc291cmNlKGZjbildKWAgb24gdGhlIGRhdGEgc2NoZW1hLic7XG59O1xuXG5leHBvcnQgdHlwZSBEYXRhQ2xpZW50RXJyb3IgPSB7XG4gIHJlc291cmNlQ29uZmlnOiBJbnZhbGlkQ29uZmlnO1xuICBsaWJyYXJ5T3B0aW9uczogSW52YWxpZENvbmZpZztcbn07XG5cbmV4cG9ydCB0eXBlIERhdGFDbGllbnRDb25maWcgPSB7XG4gIHJlc291cmNlQ29uZmlnOiBSZXNvdXJjZUNvbmZpZztcbiAgbGlicmFyeU9wdGlvbnM6IExpYnJhcnlPcHRpb25zO1xufTtcblxuZXhwb3J0IHR5cGUgRGF0YUNsaWVudFJldHVybjxUPiA9IFQgZXh0ZW5kcyBEYXRhQ2xpZW50RW52XG4gID8gRGF0YUNsaWVudENvbmZpZ1xuICA6IERhdGFDbGllbnRFcnJvcjtcblxuLyoqXG4gKiBHZW5lcmF0ZSB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYCBuZWVkIHRvIGNvbmZpZ3VyZVxuICogQW1wbGlmeSBmb3IgdGhlIGRhdGEgY2xpZW50IGluIGEgbGFtYmRhLlxuICpcbiAqIFlvdXIgZnVuY3Rpb24gbmVlZHMgdG8gYmUgZ3JhbnRlZCByZXNvdXJjZSBhY2Nlc3Mgb24geW91ciBzY2hlbWEgZm9yIHRoaXMgdG8gd29ya1xuICogYGEuc2NoZW1hKC4uLikuYXV0aG9yaXphdGlvbigoYWxsb3cpID0+IFthLnJlc291cmNlKG15RnVuY3Rpb24pXSlgXG4gKiBAcGFyYW0gZW52IC0gVGhlIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgdGhlIGRhdGEgY2xpZW50XG4gKiBAcmV0dXJucyBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYHJlc291cmNlQ29uZmlnYCBhbmQgYGxpYnJhcnlPcHRpb25zYFxuICovXG5leHBvcnQgY29uc3QgZ2V0QW1wbGlmeURhdGFDbGllbnRDb25maWcgPSBhc3luYyA8VD4oXG4gIGVudjogVCxcbiAgczNDbGllbnQ/OiBTM0NsaWVudFxuKTogUHJvbWlzZTxEYXRhQ2xpZW50UmV0dXJuPFQ+PiA9PiB7XG4gIGlmICghczNDbGllbnQpIHtcbiAgICBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCgpO1xuICB9XG5cbiAgaWYgKCFpc0RhdGFDbGllbnRFbnYoZW52KSkge1xuICAgIHJldHVybiB7IHJlc291cmNlQ29uZmlnOiB7fSwgbGlicmFyeU9wdGlvbnM6IHt9IH0gYXMgRGF0YUNsaWVudFJldHVybjxUPjtcbiAgfVxuICBsZXQgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hOiBvYmplY3Q7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHMzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgR2V0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgIEJ1Y2tldDogZW52LkFNUExJRllfREFUQV9NT0RFTF9JTlRST1NQRUNUSU9OX1NDSEVNQV9CVUNLRVRfTkFNRSxcbiAgICAgICAgS2V5OiBlbnYuQU1QTElGWV9EQVRBX01PREVMX0lOVFJPU1BFQ1RJT05fU0NIRU1BX0tFWSxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID1cbiAgICAgIGF3YWl0IHJlc3BvbnNlLkJvZHk/LnRyYW5zZm9ybVRvU3RyaW5nKCk7XG4gICAgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hID0gSlNPTi5wYXJzZShtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFKc29uID8/ICd7fScpO1xuICB9IGNhdGNoIChjYXVnaHQpIHtcbiAgICBpZiAoY2F1Z2h0IGluc3RhbmNlb2YgTm9TdWNoS2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdFcnJvciByZXRyaWV2aW5nIHRoZSBzY2hlbWEgZnJvbSBTMy4gUGxlYXNlIGNvbmZpcm0gdGhhdCB5b3VyIHByb2plY3QgaGFzIGEgYGRlZmluZURhdGFgIGluY2x1ZGVkIGluIHRoZSBgZGVmaW5lQmFja2VuZGAgZGVmaW5pdGlvbi4nXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoY2F1Z2h0IGluc3RhbmNlb2YgUzNTZXJ2aWNlRXhjZXB0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFcnJvciByZXRyaWV2aW5nIHRoZSBzY2hlbWEgZnJvbSBTMy4gWW91IG1heSBuZWVkIHRvIGdyYW50IHRoaXMgZnVuY3Rpb24gYXV0aG9yaXphdGlvbiBvbiB0aGUgc2NoZW1hLiAke2NhdWdodC5uYW1lfTogJHtjYXVnaHQubWVzc2FnZX0uYFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgY2F1Z2h0O1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGxpYnJhcnlPcHRpb25zID0gZ2V0TGlicmFyeU9wdGlvbnMoZW52KTtcblxuICBjb25zdCByZXNvdXJjZUNvbmZpZyA9IGdldFJlc291cmNlQ29uZmlnKGVudiwgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hKTtcblxuICByZXR1cm4geyByZXNvdXJjZUNvbmZpZywgbGlicmFyeU9wdGlvbnMgfSBhcyBEYXRhQ2xpZW50UmV0dXJuPFQ+O1xufTtcbiJdfQ==