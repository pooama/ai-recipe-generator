"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const credential_plugins_1 = require("../../../lib/api/aws-auth/credential-plugins");
const credential_provider_source_1 = require("../../../lib/api/plugin/credential-provider-source");
const plugin_1 = require("../../../lib/api/plugin/plugin");
(0, plugin_1.markTesting)();
let host;
let credentialPlugins;
beforeEach(() => {
    host = new plugin_1.PluginHost();
    credentialPlugins = new credential_plugins_1.CredentialPlugins(host);
    jest.resetModules();
    jest.useFakeTimers();
});
const THE_PLUGIN = 'the-plugin';
test('plugin can return V3 compatible credentials', async () => {
    // GIVEN
    mockCredentialFunction(() => Promise.resolve({
        accessKeyId: 'keyid',
        secretAccessKey: 'secret',
    }));
    // WHEN
    const creds = await fetchNow();
    await expect(creds).toEqual(expect.objectContaining({
        accessKeyId: 'keyid',
    }));
});
test('plugin can return V3 compatible credentials that expire', async () => {
    // GIVEN
    const mockProducer = jest.fn().mockImplementation(() => Promise.resolve({
        accessKeyId: 'keyid',
        secretAccessKey: 'secret',
        sessionToken: 'session',
        expiration: new Date(Date.now() + 300000), // 5 minutes from now
    }));
    mockCredentialFunction(mockProducer);
    // WHEN
    await fetchNow();
    await fetchNow();
    expect(mockProducer).toHaveBeenCalledTimes(1); // Caching
    jest.advanceTimersByTime(300000); // 5 minutes into the future we go
    await fetchNow();
    expect(mockProducer).toHaveBeenCalledTimes(2); // Cache busted
});
test('provider returning expiring credentials must keep returning the same object type', async () => {
    // GIVEN
    const mockProducer = jest.fn()
        .mockImplementationOnce(() => Promise.resolve({
        accessKeyId: 'keyid',
        secretAccessKey: 'secret',
        sessionToken: 'session',
        expiration: new Date(Date.now() + 300000), // 5 minutes from now
    }))
        .mockImplementationOnce(() => Promise.resolve(() => Promise.resolve({ accessKeyId: 'akid' })));
    mockCredentialFunction(mockProducer);
    // WHEN
    await fetchNow();
    jest.advanceTimersByTime(300000); // Make the credentials expire
    await expect(fetchNow()).rejects.toThrow(/Plugin initially returned static V3/);
});
test('plugin can return V3 compatible credential-provider', async () => {
    // GIVEN
    mockCredentialFunction(() => Promise.resolve(() => Promise.resolve({
        accessKeyId: 'keyid',
        secretAccessKey: 'secret',
    })));
    // WHEN
    const creds = await fetchNow();
    await expect(creds).toEqual(expect.objectContaining({
        accessKeyId: 'keyid',
    }));
});
test('plugin can return V2 compatible credential-provider', async () => {
    // GIVEN
    let getPromise = jest.fn().mockResolvedValue(undefined);
    mockCredentialFunction(() => Promise.resolve({
        accessKeyId: 'keyid',
        secretAccessKey: 'secret',
        expired: false,
        getPromise,
    }));
    // WHEN
    const creds = await fetchNow();
    await expect(creds).toEqual(expect.objectContaining({
        accessKeyId: 'keyid',
    }));
    expect(getPromise).toHaveBeenCalled();
});
test('plugin must not return something that is not a credential', async () => {
    // GIVEN
    mockCredentialFunction(() => Promise.resolve({
        nothing: 'burger',
    }));
    // THEN
    await expect(fetchNow()).rejects.toThrow(/Plugin returned a value that/);
});
function mockCredentialFunction(p) {
    mockCredentialPlugin({
        name: 'test',
        canProvideCredentials() { return Promise.resolve(true); },
        isAvailable() { return Promise.resolve(true); },
        getProvider(...args) {
            return p(...args);
        },
    });
}
function mockCredentialPlugin(p) {
    jest.mock(THE_PLUGIN, () => {
        return {
            version: '1',
            init(h) {
                h.registerCredentialProviderSource(p);
            },
        };
    }, { virtual: true });
    host.load(THE_PLUGIN);
}
async function fetchNow() {
    const prov = await credentialPlugins.fetchCredentialsFor('1111', credential_provider_source_1.Mode.ForReading);
    return prov?.credentials();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlZGVudGlhbC1wbHVnaW4udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNyZWRlbnRpYWwtcGx1Z2luLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxRkFBaUY7QUFDakYsbUdBQWdJO0FBQ2hJLDJEQUF5RTtBQUV6RSxJQUFBLG9CQUFXLEdBQUUsQ0FBQztBQUVkLElBQUksSUFBZ0IsQ0FBQztBQUNyQixJQUFJLGlCQUFvQyxDQUFDO0FBRXpDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxJQUFJLEdBQUcsSUFBSSxtQkFBVSxFQUFFLENBQUM7SUFDeEIsaUJBQWlCLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDO0FBRWhDLElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxLQUFLLElBQUksRUFBRTtJQUM3RCxRQUFRO0lBQ1Isc0JBQXNCLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUMzQyxXQUFXLEVBQUUsT0FBTztRQUNwQixlQUFlLEVBQUUsUUFBUTtLQUMxQixDQUFDLENBQUMsQ0FBQztJQUVKLE9BQU87SUFDUCxNQUFNLEtBQUssR0FBRyxNQUFNLFFBQVEsRUFBRSxDQUFDO0lBRS9CLE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7UUFDbEQsV0FBVyxFQUFFLE9BQU87S0FDckIsQ0FBQyxDQUFDLENBQUM7QUFDTixDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyx5REFBeUQsRUFBRSxLQUFLLElBQUksRUFBRTtJQUN6RSxRQUFRO0lBQ1IsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUs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SUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7UUFDekIsT0FBTztZQUNMLE9BQU8sRUFBRSxHQUFHO1lBQ1osSUFBSSxDQUFDLENBQWE7Z0JBQ2hCLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxDQUFDO1NBQ0YsQ0FBQztJQUNKLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXRCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUVELEtBQUssVUFBVSxRQUFRO0lBQ3JCLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQWlCLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLGlDQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbEYsT0FBTyxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUM7QUFDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENyZWRlbnRpYWxQbHVnaW5zIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaS9hd3MtYXV0aC9jcmVkZW50aWFsLXBsdWdpbnMnO1xuaW1wb3J0IHsgQ3JlZGVudGlhbFByb3ZpZGVyU291cmNlLCBNb2RlLCBTREt2M0NvbXBhdGlibGVDcmVkZW50aWFscyB9IGZyb20gJy4uLy4uLy4uL2xpYi9hcGkvcGx1Z2luL2NyZWRlbnRpYWwtcHJvdmlkZXItc291cmNlJztcbmltcG9ydCB7IFBsdWdpbkhvc3QsIG1hcmtUZXN0aW5nIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaS9wbHVnaW4vcGx1Z2luJztcblxubWFya1Rlc3RpbmcoKTtcblxubGV0IGhvc3Q6IFBsdWdpbkhvc3Q7XG5sZXQgY3JlZGVudGlhbFBsdWdpbnM6IENyZWRlbnRpYWxQbHVnaW5zO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgaG9zdCA9IG5ldyBQbHVnaW5Ib3N0KCk7XG4gIGNyZWRlbnRpYWxQbHVnaW5zID0gbmV3IENyZWRlbnRpYWxQbHVnaW5zKGhvc3QpO1xuICBqZXN0LnJlc2V0TW9kdWxlcygpO1xuICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcbn0pO1xuXG5jb25zdCBUSEVfUExVR0lOID0gJ3RoZS1wbHVnaW4nO1xuXG50ZXN0KCdwbHVnaW4gY2FuIHJldHVybiBWMyBjb21wYXRpYmxlIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2NrQ3JlZGVudGlhbEZ1bmN0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7XG4gICAgYWNjZXNzS2V5SWQ6ICdrZXlpZCcsXG4gICAgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0JyxcbiAgfSkpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgY3JlZHMgPSBhd2FpdCBmZXRjaE5vdygpO1xuXG4gIGF3YWl0IGV4cGVjdChjcmVkcykudG9FcXVhbChleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgYWNjZXNzS2V5SWQ6ICdrZXlpZCcsXG4gIH0pKTtcbn0pO1xuXG50ZXN0KCdwbHVnaW4gY2FuIHJldHVybiBWMyBjb21wYXRpYmxlIGNyZWRlbnRpYWxzIHRoYXQgZXhwaXJlJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBtb2NrUHJvZHVjZXIgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7XG4gICAgYWNjZXNzS2V5SWQ6ICdrZXlpZCcsXG4gICAgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0JyxcbiAgICBzZXNzaW9uVG9rZW46ICdzZXNzaW9uJyxcbiAgICBleHBpcmF0aW9uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzAwXzAwMCksIC8vIDUgbWludXRlcyBmcm9tIG5vd1xuICB9IHNhdGlzZmllcyBTREt2M0NvbXBhdGlibGVDcmVkZW50aWFscykpO1xuICBtb2NrQ3JlZGVudGlhbEZ1bmN0aW9uKG1vY2tQcm9kdWNlcik7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBmZXRjaE5vdygpO1xuICBhd2FpdCBmZXRjaE5vdygpO1xuICBleHBlY3QobW9ja1Byb2R1Y2VyKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7IC8vIENhY2hpbmdcblxuICBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWUoMzAwXzAwMCk7IC8vIDUgbWludXRlcyBpbnRvIHRoZSBmdXR1cmUgd2UgZ29cbiAgYXdhaXQgZmV0Y2hOb3coKTtcbiAgZXhwZWN0KG1vY2tQcm9kdWNlcikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDIpOyAvLyBDYWNoZSBidXN0ZWRcbn0pO1xuXG50ZXN0KCdwcm92aWRlciByZXR1cm5pbmcgZXhwaXJpbmcgY3JlZGVudGlhbHMgbXVzdCBrZWVwIHJldHVybmluZyB0aGUgc2FtZSBvYmplY3QgdHlwZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3QgbW9ja1Byb2R1Y2VyID0gamVzdC5mbigpXG4gICAgLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgIGFjY2Vzc0tleUlkOiAna2V5aWQnLFxuICAgICAgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0JyxcbiAgICAgIHNlc3Npb25Ub2tlbjogJ3Nlc3Npb24nLFxuICAgICAgZXhwaXJhdGlvbjogbmV3IERhdGUoRGF0ZS5ub3coKSArIDMwMF8wMDApLCAvLyA1IG1pbnV0ZXMgZnJvbSBub3dcbiAgICB9IHNhdGlzZmllcyBTREt2M0NvbXBhdGlibGVDcmVkZW50aWFscykpXG4gICAgLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IGFjY2Vzc0tleUlkOiAnYWtpZCcgfSkpKTtcbiAgbW9ja0NyZWRlbnRpYWxGdW5jdGlvbihtb2NrUHJvZHVjZXIpO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgZmV0Y2hOb3coKTtcbiAgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lKDMwMF8wMDApOyAvLyBNYWtlIHRoZSBjcmVkZW50aWFscyBleHBpcmVcbiAgYXdhaXQgZXhwZWN0KGZldGNoTm93KCkpLnJlamVjdHMudG9UaHJvdygvUGx1Z2luIGluaXRpYWxseSByZXR1cm5lZCBzdGF0aWMgVjMvKTtcbn0pO1xuXG50ZXN0KCdwbHVnaW4gY2FuIHJldHVybiBWMyBjb21wYXRpYmxlIGNyZWRlbnRpYWwtcHJvdmlkZXInLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tDcmVkZW50aWFsRnVuY3Rpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCgpID0+IFByb21pc2UucmVzb2x2ZSh7XG4gICAgYWNjZXNzS2V5SWQ6ICdrZXlpZCcsXG4gICAgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0JyxcbiAgfSkpKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGNyZWRzID0gYXdhaXQgZmV0Y2hOb3coKTtcblxuICBhd2FpdCBleHBlY3QoY3JlZHMpLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgIGFjY2Vzc0tleUlkOiAna2V5aWQnLFxuICB9KSk7XG59KTtcblxudGVzdCgncGx1Z2luIGNhbiByZXR1cm4gVjIgY29tcGF0aWJsZSBjcmVkZW50aWFsLXByb3ZpZGVyJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBsZXQgZ2V0UHJvbWlzZSA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gIG1vY2tDcmVkZW50aWFsRnVuY3Rpb24oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICBhY2Nlc3NLZXlJZDogJ2tleWlkJyxcbiAgICBzZWNyZXRBY2Nlc3NLZXk6ICdzZWNyZXQnLFxuICAgIGV4cGlyZWQ6IGZhbHNlLFxuICAgIGdldFByb21pc2UsXG4gIH0pKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGNyZWRzID0gYXdhaXQgZmV0Y2hOb3coKTtcblxuICBhd2FpdCBleHBlY3QoY3JlZHMpLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgIGFjY2Vzc0tleUlkOiAna2V5aWQnLFxuICB9KSk7XG4gIGV4cGVjdChnZXRQcm9taXNlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG59KTtcblxudGVzdCgncGx1Z2luIG11c3Qgbm90IHJldHVybiBzb21ldGhpbmcgdGhhdCBpcyBub3QgYSBjcmVkZW50aWFsJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2NrQ3JlZGVudGlhbEZ1bmN0aW9uKCgpID0+IFByb21pc2UucmVzb2x2ZSh7XG4gICAgbm90aGluZzogJ2J1cmdlcicsXG4gIH0gYXMgYW55KSk7XG5cbiAgLy8gVEhFTlxuICBhd2FpdCBleHBlY3QoZmV0Y2hOb3coKSkucmVqZWN0cy50b1Rocm93KC9QbHVnaW4gcmV0dXJuZWQgYSB2YWx1ZSB0aGF0Lyk7XG59KTtcblxuZnVuY3Rpb24gbW9ja0NyZWRlbnRpYWxGdW5jdGlvbihwOiBDcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VbJ2dldFByb3ZpZGVyJ10pIHtcbiAgbW9ja0NyZWRlbnRpYWxQbHVnaW4oe1xuICAgIG5hbWU6ICd0ZXN0JyxcbiAgICBjYW5Qcm92aWRlQ3JlZGVudGlhbHMoKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7IH0sXG4gICAgaXNBdmFpbGFibGUoKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7IH0sXG4gICAgZ2V0UHJvdmlkZXIoLi4uYXJnczogUGFyYW1ldGVyczxDcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VbJ2dldFByb3ZpZGVyJ10+KSB7XG4gICAgICByZXR1cm4gcCguLi5hcmdzKTtcbiAgICB9LFxuICB9KTtcbn1cblxuZnVuY3Rpb24gbW9ja0NyZWRlbnRpYWxQbHVnaW4ocDogQ3JlZGVudGlhbFByb3ZpZGVyU291cmNlKSB7XG4gIGplc3QubW9jayhUSEVfUExVR0lOLCAoKSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIGluaXQoaDogUGx1Z2luSG9zdCkge1xuICAgICAgICBoLnJlZ2lzdGVyQ3JlZGVudGlhbFByb3ZpZGVyU291cmNlKHApO1xuICAgICAgfSxcbiAgICB9O1xuICB9LCB7IHZpcnR1YWw6IHRydWUgfSk7XG5cbiAgaG9zdC5sb2FkKFRIRV9QTFVHSU4pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaE5vdygpIHtcbiAgY29uc3QgcHJvdiA9IGF3YWl0IGNyZWRlbnRpYWxQbHVnaW5zLmZldGNoQ3JlZGVudGlhbHNGb3IoJzExMTEnLCBNb2RlLkZvclJlYWRpbmcpO1xuICByZXR1cm4gcHJvdj8uY3JlZGVudGlhbHMoKTtcbn1cbiJdfQ==