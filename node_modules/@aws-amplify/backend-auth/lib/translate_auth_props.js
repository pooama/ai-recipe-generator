/**
 * Translate an Auth factory's loginWith to its Auth construct counterpart. Backend secret fields will be resolved
 * to an CFN token and map to the required construct type. Note that not all construct secret fields are of sdk
 * SecretValue type, many are (wrongly) of type string as well.
 */
export const translateToAuthConstructLoginWith = (authFactoryLoginWith, backendSecretResolver) => {
    const result = authFactoryLoginWith;
    if (!authFactoryLoginWith.externalProviders) {
        return result;
    }
    const externalProviders = authFactoryLoginWith.externalProviders;
    result.externalProviders = {
        ...externalProviders,
    };
    const amazonProps = translateAmazonProps(backendSecretResolver, externalProviders.loginWithAmazon);
    if (amazonProps) {
        result.externalProviders.loginWithAmazon = amazonProps;
    }
    const appleProps = translateAppleProps(backendSecretResolver, externalProviders.signInWithApple);
    if (appleProps) {
        result.externalProviders.signInWithApple = appleProps;
    }
    const facebookProps = translateFacebookProps(backendSecretResolver, externalProviders.facebook);
    if (facebookProps) {
        result.externalProviders.facebook = facebookProps;
    }
    const oidcProps = translateOidcProps(backendSecretResolver, externalProviders.oidc);
    if (oidcProps) {
        result.externalProviders.oidc = oidcProps;
    }
    const googleProps = translateGoogleProps(backendSecretResolver, externalProviders.google);
    if (googleProps) {
        result.externalProviders.google = googleProps;
    }
    return result;
};
/**
 * Translates the senders property from AmplifyAuthProps to AuthProps format.
 * @param senders - The senders object from AmplifyAuthProps.
 * @param getInstanceProps - Properties used to get an instance of the sender.
 * @returns The translated senders object in AuthProps format, or undefined if no valid sender is provided.
 * @description
 * This function handles the translation of the 'senders' property, specifically for email senders.
 * If no senders are provided or if there's no email sender, it returns undefined.
 * If the email sender has a 'getInstance' method, it retrieves the Lambda function and returns it.
 * Otherwise, it returns the email sender as is.
 */
export const translateToAuthConstructSenders = (senders, getInstanceProps) => {
    if (!senders || !senders.email) {
        return undefined;
    }
    // Handle CustomEmailSender type
    if ('handler' in senders.email) {
        const lambda = 'getInstance' in senders.email.handler
            ? senders.email.handler.getInstance(getInstanceProps).resources.lambda
            : senders.email.handler;
        return {
            email: {
                handler: lambda,
                kmsKeyArn: senders.email.kmsKeyArn,
            },
        };
    }
    // Handle SES configuration
    if ('fromEmail' in senders.email) {
        return {
            email: senders.email,
        };
    }
    // If none of the above, return the email configuration as-is
    return {
        email: senders.email,
    };
};
const translateAmazonProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateAppleProps = (backendSecretResolver, amazonProviderProps) => {
    if (!amazonProviderProps) {
        return undefined;
    }
    const { clientId, teamId, keyId, privateKey, ...noSecretProps } = amazonProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        teamId: backendSecretResolver.resolveSecret(teamId).unsafeUnwrap(),
        keyId: backendSecretResolver.resolveSecret(keyId).unsafeUnwrap(),
        privateKey: backendSecretResolver.resolveSecret(privateKey).unsafeUnwrap(),
    };
};
const translateFacebookProps = (backendSecretResolver, facebookProviderProps) => {
    if (!facebookProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret, ...noSecretProps } = facebookProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver
            .resolveSecret(clientSecret)
            .unsafeUnwrap(),
    };
};
const translateOidcProps = (backendSecretResolver, oidcProviderProps) => {
    if (!oidcProviderProps || oidcProviderProps.length === 0) {
        return undefined;
    }
    const result = [];
    for (const provider of oidcProviderProps) {
        const { clientId, clientSecret, ...noSecretProps } = provider;
        result.push({
            ...noSecretProps,
            clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
            clientSecret: backendSecretResolver
                .resolveSecret(clientSecret)
                .unsafeUnwrap(),
        });
    }
    return result;
};
const translateGoogleProps = (backendSecretResolver, googleProviderProps) => {
    if (!googleProviderProps) {
        return undefined;
    }
    const { clientId, clientSecret: clientSecretValue, ...noSecretProps } = googleProviderProps;
    return {
        ...noSecretProps,
        clientId: backendSecretResolver.resolveSecret(clientId).unsafeUnwrap(),
        clientSecret: backendSecretResolver.resolveSecret(clientSecretValue),
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlX2F1dGhfcHJvcHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNsYXRlX2F1dGhfcHJvcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBd0JBOzs7O0dBSUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxvQkFBK0MsRUFDL0MscUJBQTRDLEVBQ3BCLEVBQUU7SUFDMUIsTUFBTSxNQUFNLEdBQ1Ysb0JBQThDLENBQUM7SUFDakQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFO1FBQzNDLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFFRCxNQUFNLGlCQUFpQixHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDO0lBQ2pFLE1BQU0sQ0FBQyxpQkFBaUIsR0FBRztRQUN6QixHQUFJLGlCQUF5RDtLQUM5RCxDQUFDO0lBRUYsTUFBTSxXQUFXLEdBQUcsb0JBQW9CLENBQ3RDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFdBQVcsRUFBRTtRQUNmLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDO0tBQ3hEO0lBRUQsTUFBTSxVQUFVLEdBQUcsbUJBQW1CLENBQ3BDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxlQUFlLENBQ2xDLENBQUM7SUFDRixJQUFJLFVBQVUsRUFBRTtRQUNkLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsVUFBVSxDQUFDO0tBQ3ZEO0lBRUQsTUFBTSxhQUFhLEdBQUcsc0JBQXNCLENBQzFDLHFCQUFxQixFQUNyQixpQkFBaUIsQ0FBQyxRQUFRLENBQzNCLENBQUM7SUFDRixJQUFJLGFBQWEsRUFBRTtRQUNqQixNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQztLQUNuRDtJQUVELE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUNsQyxxQkFBcUIsRUFD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TUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsQ0FDM0IscUJBQTRDLEVBQzVDLG1CQUFnRCxFQUNmLEVBQUU7SUFDbkMsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1FBQ3hCLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsTUFBTSxFQUNKLFFBQVEsRUFDUixZQUFZLEVBQUUsaUJBQWlCLEVBQy9CLEdBQUcsYUFBYSxFQUNqQixHQUFHLG1CQUFtQixDQUFDO0lBQ3hCLE9BQU87UUFDTCxHQUFHLGFBQWE7UUFDaEIsUUFBUSxFQUFFLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxZQUFZLEVBQUU7UUFDdEUsWUFBWSxFQUFFLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQztLQUNyRSxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQW1hem9uUHJvdmlkZXJQcm9wcyxcbiAgQXBwbGVQcm92aWRlclByb3BzLFxuICBBdXRoUHJvcHMsXG4gIEZhY2Vib29rUHJvdmlkZXJQcm9wcyxcbiAgR29vZ2xlUHJvdmlkZXJQcm9wcyxcbiAgT2lkY1Byb3ZpZGVyUHJvcHMsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9hdXRoLWNvbnN0cnVjdCc7XG5pbXBvcnQge1xuICBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEFtYXpvblByb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBBcHBsZVByb3ZpZGVyRmFjdG9yeVByb3BzLFxuICBBdXRoTG9naW5XaXRoRmFjdG9yeVByb3BzLFxuICBFeHRlcm5hbFByb3ZpZGVyR2VuZXJhbEZhY3RvcnlQcm9wcyxcbiAgRmFjZWJvb2tQcm92aWRlckZhY3RvcnlQcm9wcyxcbiAgR29vZ2xlUHJvdmlkZXJGYWN0b3J5UHJvcHMsXG4gIE9pZGNQcm92aWRlckZhY3RvcnlQcm9wcyxcbn0gZnJvbSAnLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBJRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IEFtcGxpZnlBdXRoUHJvcHMgfSBmcm9tICcuL2ZhY3RvcnkuanMnO1xuXG4vKipcbiAqIFRyYW5zbGF0ZSBhbiBBdXRoIGZhY3RvcnkncyBsb2dpbldpdGggdG8gaXRzIEF1dGggY29uc3RydWN0IGNvdW50ZXJwYXJ0LiBCYWNrZW5kIHNlY3JldCBmaWVsZHMgd2lsbCBiZSByZXNvbHZlZFxuICogdG8gYW4gQ0ZOIHRva2VuIGFuZCBtYXAgdG8gdGhlIHJlcXVpcmVkIGNvbnN0cnVjdCB0eXBlLiBOb3RlIHRoYXQgbm90IGFsbCBjb25zdHJ1Y3Qgc2VjcmV0IGZpZWxkcyBhcmUgb2Ygc2RrXG4gKiBTZWNyZXRWYWx1ZSB0eXBlLCBtYW55IGFyZSAod3JvbmdseSkgb2YgdHlwZSBzdHJpbmcgYXMgd2VsbC5cbiAqL1xuZXhwb3J0IGNvbnN0IHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdExvZ2luV2l0aCA9IChcbiAgYXV0aEZhY3RvcnlMb2dpbldpdGg6IEF1dGhMb2dpbldpdGhGYWN0b3J5UHJvcHMsXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyXG4pOiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddID0+IHtcbiAgY29uc3QgcmVzdWx0OiBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddID1cbiAgICBhdXRoRmFjdG9yeUxvZ2luV2l0aCBhcyBBdXRoUHJvcHNbJ2xvZ2luV2l0aCddO1xuICBpZiAoIWF1dGhGYWN0b3J5TG9naW5XaXRoLmV4dGVybmFsUHJvdmlkZXJzKSB7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGNvbnN0IGV4dGVybmFsUHJvdmlkZXJzID0gYXV0aEZhY3RvcnlMb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM7XG4gIHJlc3VsdC5leHRlcm5hbFByb3ZpZGVycyA9IHtcbiAgICAuLi4oZXh0ZXJuYWxQcm92aWRlcnMgYXMgRXh0ZXJuYWxQcm92aWRlckdlbmVyYWxGYWN0b3J5UHJvcHMpLFxuICB9O1xuXG4gIGNvbnN0IGFtYXpvblByb3BzID0gdHJhbnNsYXRlQW1hem9uUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLmxvZ2luV2l0aEFtYXpvblxuICApO1xuICBpZiAoYW1hem9uUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMubG9naW5XaXRoQW1hem9uID0gYW1hem9uUHJvcHM7XG4gIH1cblxuICBjb25zdCBhcHBsZVByb3BzID0gdHJhbnNsYXRlQXBwbGVQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuc2lnbkluV2l0aEFwcGxlXG4gICk7XG4gIGlmIChhcHBsZVByb3BzKSB7XG4gICAgcmVzdWx0LmV4dGVybmFsUHJvdmlkZXJzLnNpZ25JbldpdGhBcHBsZSA9IGFwcGxlUHJvcHM7XG4gIH1cblxuICBjb25zdCBmYWNlYm9va1Byb3BzID0gdHJhbnNsYXRlRmFjZWJvb2tQcm9wcyhcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgZXh0ZXJuYWxQcm92aWRlcnMuZmFjZWJvb2tcbiAgKTtcbiAgaWYgKGZhY2Vib29rUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuZmFjZWJvb2sgPSBmYWNlYm9va1Byb3BzO1xuICB9XG5cbiAgY29uc3Qgb2lkY1Byb3BzID0gdHJhbnNsYXRlT2lkY1Byb3BzKFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBleHRlcm5hbFByb3ZpZGVycy5vaWRjXG4gICk7XG4gIGlmIChvaWRjUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMub2lkYyA9IG9pZGNQcm9wcztcbiAgfVxuXG4gIGNvbnN0IGdvb2dsZVByb3BzID0gdHJhbnNsYXRlR29vZ2xlUHJvcHMoXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIGV4dGVybmFsUHJvdmlkZXJzLmdvb2dsZVxuICApO1xuICBpZiAoZ29vZ2xlUHJvcHMpIHtcbiAgICByZXN1bHQuZXh0ZXJuYWxQcm92aWRlcnMuZ29vZ2xlID0gZ29vZ2xlUHJvcHM7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcbi8qKlxuICogVHJhbnNsYXRlcyB0aGUgc2VuZGVycyBwcm9wZXJ0eSBmcm9tIEFtcGxpZnlBdXRoUHJvcHMgdG8gQXV0aFByb3BzIGZvcm1hdC5cbiAqIEBwYXJhbSBzZW5kZXJzIC0gVGhlIHNlbmRlcnMgb2JqZWN0IGZyb20gQW1wbGlmeUF1dGhQcm9wcy5cbiAqIEBwYXJhbSBnZXRJbnN0YW5jZVByb3BzIC0gUHJvcGVydGllcyB1c2VkIHRvIGdldCBhbiBpbnN0YW5jZSBvZiB0aGUgc2VuZGVyLlxuICogQHJldHVybnMgVGhlIHRyYW5zbGF0ZWQgc2VuZGVycyBvYmplY3QgaW4gQXV0aFByb3BzIGZvcm1hdCwgb3IgdW5kZWZpbmVkIGlmIG5vIHZhbGlkIHNlbmRlciBpcyBwcm92aWRlZC5cbiAqIEBkZXNjcmlwdGlvblxuICogVGhpcyBmdW5jdGlvbiBoYW5kbGVzIHRoZSB0cmFuc2xhdGlvbiBvZiB0aGUgJ3NlbmRlcnMnIHByb3BlcnR5LCBzcGVjaWZpY2FsbHkgZm9yIGVtYWlsIHNlbmRlcnMuXG4gKiBJZiBubyBzZW5kZXJzIGFyZSBwcm92aWRlZCBvciBpZiB0aGVyZSdzIG5vIGVtYWlsIHNlbmRlciwgaXQgcmV0dXJucyB1bmRlZmluZWQuXG4gKiBJZiB0aGUgZW1haWwgc2VuZGVyIGhhcyBhICdnZXRJbnN0YW5jZScgbWV0aG9kLCBpdCByZXRyaWV2ZXMgdGhlIExhbWJkYSBmdW5jdGlvbiBhbmQgcmV0dXJucyBpdC5cbiAqIE90aGVyd2lzZSwgaXQgcmV0dXJucyB0aGUgZW1haWwgc2VuZGVyIGFzIGlzLlxuICovXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlVG9BdXRoQ29uc3RydWN0U2VuZGVycyA9IChcbiAgc2VuZGVyczogQW1wbGlmeUF1dGhQcm9wc1snc2VuZGVycyddIHwgdW5kZWZpbmVkLFxuICBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wc1xuKTogQXV0aFByb3BzWydzZW5kZXJzJ10gfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIXNlbmRlcnMgfHwgIXNlbmRlcnMuZW1haWwpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gSGFuZGxlIEN1c3RvbUVtYWlsU2VuZGVyIHR5cGVcbiAgaWYgKCdoYW5kbGVyJyBpbiBzZW5kZXJzLmVtYWlsKSB7XG4gICAgY29uc3QgbGFtYmRhOiBJRnVuY3Rpb24gPVxuICAgICAgJ2dldEluc3RhbmNlJyBpbiBzZW5kZXJzLmVtYWlsLmhhbmRsZXJcbiAgICAgICAgPyBzZW5kZXJzLmVtYWlsLmhhbmRsZXIuZ2V0SW5zdGFuY2UoZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICA6IHNlbmRlcnMuZW1haWwuaGFuZGxlcjtcblxuICAgIHJldHVybiB7XG4gICAgICBlbWFpbDoge1xuICAgICAgICBoYW5kbGVyOiBsYW1iZGEsXG4gICAgICAgIGttc0tleUFybjogc2VuZGVycy5lbWFpbC5rbXNLZXlBcm4sXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvLyBIYW5kbGUgU0VTIGNvbmZpZ3VyYXRpb25cbiAgaWYgKCdmcm9tRW1haWwnIGluIHNlbmRlcnMuZW1haWwpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZW1haWw6IHNlbmRlcnMuZW1haWwsXG4gICAgfTtcbiAgfVxuXG4gIC8vIElmIG5vbmUgb2YgdGhlIGFib3ZlLCByZXR1cm4gdGhlIGVtYWlsIGNvbmZpZ3VyYXRpb24gYXMtaXNcbiAgcmV0dXJuIHtcbiAgICBlbWFpbDogc2VuZGVycy5lbWFpbCxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFtYXpvblByb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgYW1hem9uUHJvdmlkZXJQcm9wcz86IEFtYXpvblByb3ZpZGVyRmFjdG9yeVByb3BzXG4pOiBBbWF6b25Qcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIGNsaWVudFNlY3JldCwgLi4ubm9TZWNyZXRQcm9wcyB9ID0gYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgIC5yZXNvbHZlU2VjcmV0KGNsaWVudFNlY3JldClcbiAgICAgIC51bnNhZmVVbndyYXAoKSxcbiAgfTtcbn07XG5cbmNvbnN0IHRyYW5zbGF0ZUFwcGxlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBhbWF6b25Qcm92aWRlclByb3BzPzogQXBwbGVQcm92aWRlckZhY3RvcnlQcm9wc1xuKTogQXBwbGVQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFhbWF6b25Qcm92aWRlclByb3BzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50SWQsIHRlYW1JZCwga2V5SWQsIHByaXZhdGVLZXksIC4uLm5vU2VjcmV0UHJvcHMgfSA9XG4gICAgYW1hem9uUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgdGVhbUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldCh0ZWFtSWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGtleUlkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChrZXlJZCkudW5zYWZlVW53cmFwKCksXG4gICAgcHJpdmF0ZUtleTogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQocHJpdmF0ZUtleSkudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVGYWNlYm9va1Byb3BzID0gKFxuICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgZmFjZWJvb2tQcm92aWRlclByb3BzPzogRmFjZWJvb2tQcm92aWRlckZhY3RvcnlQcm9wc1xuKTogRmFjZWJvb2tQcm92aWRlclByb3BzIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFmYWNlYm9va1Byb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgeyBjbGllbnRJZCwgY2xpZW50U2VjcmV0LCAuLi5ub1NlY3JldFByb3BzIH0gPSBmYWNlYm9va1Byb3ZpZGVyUHJvcHM7XG4gIHJldHVybiB7XG4gICAgLi4ubm9TZWNyZXRQcm9wcyxcbiAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgIGNsaWVudFNlY3JldDogYmFja2VuZFNlY3JldFJlc29sdmVyXG4gICAgICAucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXQpXG4gICAgICAudW5zYWZlVW53cmFwKCksXG4gIH07XG59O1xuXG5jb25zdCB0cmFuc2xhdGVPaWRjUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBvaWRjUHJvdmlkZXJQcm9wcz86IE9pZGNQcm92aWRlckZhY3RvcnlQcm9wc1tdXG4pOiBPaWRjUHJvdmlkZXJQcm9wc1tdIHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKCFvaWRjUHJvdmlkZXJQcm9wcyB8fCBvaWRjUHJvdmlkZXJQcm9wcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGZvciAoY29uc3QgcHJvdmlkZXIgb2Ygb2lkY1Byb3ZpZGVyUHJvcHMpIHtcbiAgICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQsIC4uLm5vU2VjcmV0UHJvcHMgfSA9IHByb3ZpZGVyO1xuICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgIC4uLm5vU2VjcmV0UHJvcHMsXG4gICAgICBjbGllbnRJZDogYmFja2VuZFNlY3JldFJlc29sdmVyLnJlc29sdmVTZWNyZXQoY2xpZW50SWQpLnVuc2FmZVVud3JhcCgpLFxuICAgICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXJcbiAgICAgICAgLnJlc29sdmVTZWNyZXQoY2xpZW50U2VjcmV0KVxuICAgICAgICAudW5zYWZlVW53cmFwKCksXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgdHJhbnNsYXRlR29vZ2xlUHJvcHMgPSAoXG4gIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICBnb29nbGVQcm92aWRlclByb3BzPzogR29vZ2xlUHJvdmlkZXJGYWN0b3J5UHJvcHNcbik6IEdvb2dsZVByb3ZpZGVyUHJvcHMgfCB1bmRlZmluZWQgPT4ge1xuICBpZiAoIWdvb2dsZVByb3ZpZGVyUHJvcHMpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGNsaWVudElkLFxuICAgIGNsaWVudFNlY3JldDogY2xpZW50U2VjcmV0VmFsdWUsXG4gICAgLi4ubm9TZWNyZXRQcm9wc1xuICB9ID0gZ29vZ2xlUHJvdmlkZXJQcm9wcztcbiAgcmV0dXJuIHtcbiAgICAuLi5ub1NlY3JldFByb3BzLFxuICAgIGNsaWVudElkOiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRJZCkudW5zYWZlVW53cmFwKCksXG4gICAgY2xpZW50U2VjcmV0OiBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIucmVzb2x2ZVNlY3JldChjbGllbnRTZWNyZXRWYWx1ZSksXG4gIH07XG59O1xuIl19