import * as path from 'path';
import { UserPoolOperation, } from 'aws-cdk-lib/aws-cognito';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { AmplifyAuth, } from '@aws-amplify/auth-construct';
import { translateToAuthConstructLoginWith, translateToAuthConstructSenders, } from './translate_auth_props.js';
import { authAccessBuilder as _authAccessBuilder } from './access_builder.js';
import { AuthAccessPolicyArbiterFactory } from './auth_access_policy_arbiter.js';
import { UserPoolAccessPolicyFactory } from './userpool_access_policy_factory.js';
import { Stack, Tags } from 'aws-cdk-lib';
/**
 * Singleton factory for AmplifyAuth that can be used in Amplify project files.
 *
 * Exported for testing purpose only & should NOT be exported out of the package.
 */
export class AmplifyAuthFactory {
    props;
    importStack;
    // publicly accessible for testing purpose only.
    static factoryCount = 0;
    provides = 'AuthResources';
    generator;
    /**
     * Set the properties that will be used to initialize AmplifyAuth
     */
    constructor(props, 
    // eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
    importStack = new Error().stack) {
        this.props = props;
        this.importStack = importStack;
        if (AmplifyAuthFactory.factoryCount > 0) {
            throw new AmplifyUserError('MultipleSingletonResourcesError', {
                message: 'Multiple `defineAuth` or `referenceAuth` calls are not allowed within an Amplify backend',
                resolution: 'Remove all but one `defineAuth` or `referenceAuth` call',
            });
        }
        AmplifyAuthFactory.factoryCount++;
    }
    /**
     * Get a singleton instance of AmplifyAuth
     */
    getInstance = (getInstanceProps) => {
        const { constructContainer, importPathVerifier, resourceNameValidator } = getInstanceProps;
        importPathVerifier?.verify(this.importStack, path.join('amplify', 'auth', 'resource'), 'Amplify Auth must be defined in amplify/auth/resource.ts');
        if (this.props.name) {
            resourceNameValidator?.validate(this.props.name);
        }
        if (!this.generator) {
            this.generator = new AmplifyAuthGenerator(this.props, getInstanceProps);
        }
        return constructContainer.getOrCompute(this.generator);
    };
}
class AmplifyAuthGenerator {
    props;
    getInstanceProps;
    authAccessBuilder;
    authAccessPolicyArbiterFactory;
    resourceGroupName = 'auth';
    name;
    constructor(props, getInstanceProps, authAccessBuilder = _authAccessBuilder, authAccessPolicyArbiterFactory = new AuthAccessPolicyArbiterFactory()) {
        this.props = props;
        this.getInstanceProps = getInstanceProps;
        this.authAccessBuilder = authAccessBuilder;
        this.authAccessPolicyArbiterFactory = authAccessPolicyArbiterFactory;
        this.name = props.name ?? 'amplifyAuth';
    }
    generateContainerEntry = ({ scope, backendSecretResolver, ssmEnvironmentEntriesGenerator, stableBackendIdentifiers, }) => {
        const authProps = {
            ...this.props,
            loginWith: translateToAuthConstructLoginWith(this.props.loginWith, backendSecretResolver),
            senders: translateToAuthConstructSenders(this.props.senders, this.getInstanceProps),
            outputStorageStrategy: this.getInstanceProps.outputStorageStrategy,
        };
        if (authProps.loginWith.externalProviders) {
            authProps.loginWith.externalProviders.domainPrefix =
                stableBackendIdentifiers.getStableBackendHash();
        }
        let authConstruct;
        try {
            authConstruct = new AmplifyAuth(scope, this.name, authProps);
        }
        catch (error) {
            throw new AmplifyUserError('AmplifyAuthConstructInitializationError', {
                message: 'Failed to instantiate auth construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(authConstruct).add(TagName.FRIENDLY_NAME, this.name);
        Object.entries(this.props.triggers || {}).forEach(([triggerEvent, handlerFactory]) => {
            authConstruct.resources.userPool.addTrigger(UserPoolOperation.of(triggerEvent), handlerFactory.getInstance(this.getInstanceProps).resources.lambda);
        });
        const authConstructMixin = {
            ...authConstruct,
            /**
             * Returns a resourceAccessAcceptor for the given role
             * @param roleIdentifier Either the auth or unauth role name or the name of a UserPool group
             */
            getResourceAccessAcceptor: (roleIdentifier) => ({
                identifier: `${roleIdentifier}ResourceAccessAcceptor`,
                acceptResourceAccess: (policy) => {
                    const role = roleNameIsAuthRoleName(roleIdentifier)
                        ? authConstruct.resources[roleIdentifier]
                        : authConstruct.resources.groups?.[roleIdentifier]?.role;
                    if (!role) {
                        throw new AmplifyUserError('InvalidResourceAccessConfigError', {
                            message: `No auth IAM role found for "${roleIdentifier}".`,
                            resolution: `If you are trying to configure UserPool group access, ensure that the group name is specified correctly.`,
                        });
                    }
                    policy.attachToRole(role);
                },
            }),
            stack: Stack.of(authConstruct),
        };
        if (!this.props.access) {
            return authConstructMixin;
        }
        // props.access is the access callback defined by the customer
        // here we inject the authAccessBuilder into the callback and run it
        // this produces the access definition that will be used to create the auth access policies
        const accessDefinition = this.props.access(this.authAccessBuilder);
        const ssmEnvironmentEntries = ssmEnvironmentEntriesGenerator.generateSsmEnvironmentEntries({
            [`${this.name}_USERPOOL_ID`]: authConstructMixin.resources.userPool.userPoolId,
        });
        const authPolicyArbiter = this.authAccessPolicyArbiterFactory.getInstance(accessDefinition, this.getInstanceProps, ssmEnvironmentEntries, new UserPoolAccessPolicyFactory(authConstruct.resources.userPool));
        authPolicyArbiter.arbitratePolicies();
        return authConstructMixin;
    };
}
const roleNameIsAuthRoleName = (roleName) => {
    return (roleName === 'authenticatedUserIamRole' ||
        roleName === 'unauthenticatedUserIamRole');
};
/**
 * Provide the settings that will be used for authentication.
 */
export const defineAuth = (props) => 
// eslint-disable-next-line amplify-backend-rules/prefer-amplify-errors
new AmplifyAuthFactory(props, new Error().stack);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBRTdCLE9BQU8sRUFFTCxpQkFBaUIsR0FFbEIsTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkUsT0FBTyxFQUNMLFdBQVcsR0FHWixNQUFNLDZCQUE2QixDQUFDO0FBZXJDLE9BQU8sRUFDTCxpQ0FBaUMsRUFDakMsK0JBQStCLEdBQ2hDLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLGlCQUFpQixJQUFJLGtCQUFrQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFPakYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUEwQzFDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBWVY7SUFFQTtJQWJuQixnREFBZ0Q7SUFDaEQsTUFBTSxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUM7SUFFZixRQUFRLEdBQUcsZUFBZSxDQUFDO0lBRTVCLFNBQVMsQ0FBbUM7SUFFcEQ7O09BRUc7SUFDSCxZQUNtQixLQUF1QjtJQUN4Qyx1RUFBdUU7SUFDdEQsY0FBYyxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUs7UUFGL0IsVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFFdkIsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBRWhELElBQUksa0JBQWtCLENBQUMsWUFBWSxHQUFHLENBQUMsRUFBRTtZQUN2QyxNQUFNLElBQUksZ0JBQWdCLENBQUMsaUNBQWlDLEVBQUU7Z0JBQzVELE9BQU8sRUFDTCwwRkFBMEY7Z0JBQzVGLFVBQVUsRUFBRSx5REFBeUQ7YUFDdEUsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXLEdBQUcsQ0FDWixnQkFBa0QsRUFDckMsRUFBRTtRQUNmLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxrQkFBa0IsRUFBRSxxQkFBcUIsRUFBRSxHQUNyRSxnQkFBZ0IsQ0FBQztRQUNuQixrQkFBa0IsRUFBRSxNQUFNLENBQ3hCLElBQUksQ0FBQyxXQUFXLEVBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLENBQUMsRUFDeEMsMERBQTBELENBQzNELENBQUM7UUFDRixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ25CLHFCQUFxQixFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUN6RTtRQUNELE9BQU8sa0JBQWtCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQWdCLENBQUM7SUFDeEUsQ0FBQyxDQUFDOztBQUdKLE1BQU0sb0JBQW9CO0lBS0w7SUFDQTtJQUNBO0lBQ0E7SUFQVixpQkFBaUIsR0FBNkIsTUFBTSxDQUFDO0lBQzdDLElBQUksQ0FBUztJQUU5QixZQUNtQixLQUF1QixFQUN2QixnQkFBa0QsRUFDbEQsb0JBQW9CLGtCQUFrQixFQUN0QyxpQ0FBaUMsSUFBSSw4QkFBOEIsRUFBRTtRQUhyRSxVQUFLLEdBQUwsS0FBSyxDQUFrQjtRQUN2QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtDO1FBQ2xELHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBcUI7UUFDdEMsbUNBQThCLEdBQTlCLDhCQUE4QixDQUF1QztRQUV0RixJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLElBQUksYUFBYSxDQUFDO0lBQzFDLENBQUM7SUFFRCxzQkFBc0IsR0FBRyxDQUFDLEVBQ3hCLEtBQUssRUFDTCxxQkFBcUIsRUFDckIsOEJBQThCLEVBQzlCLHdCQUF3QixHQUNJLEVBQUUsRUFBRTtRQUNoQyxNQUFNLFNBQVMsR0FBYztZQUMzQixHQUFHLElBQUksQ0FBQyxLQUFLO1lBQ2IsU0FBUyxFQUFFLGlDQUFpQyxDQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFDcEIscUJBQXFCLENBQ3RCO1lBQ0QsT0FBTyxFQUFFLCtCQUErQixDQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFDbEIsSUFBSSxDQUFDLGdCQUFnQixDQUN0QjtZQUNELHFCQUFxQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUI7U0FDbkUsQ0FBQztRQUNGLElBQUksU0FBUyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRTtZQUN6QyxTQUFTLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLFlBQVk7Z0JBQ2hELHdCQUF3QixDQUFDLG9CQUFvQixFQUFFLENBQUM7U0FDbkQ7UUFFRCxJQUFJLGFBQTBCLENBQUM7UUFDL0IsSUFBSTtZQUNGLGFBQWEsR0FBRyxJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztTQUM5RDtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsTUFBTSxJQUFJLGdCQUFnQixDQUN4Qix5Q0FBeUMsRUFDekM7Z0JBQ0UsT0FBTyxFQUFFLHNDQUFzQztnQkFDL0MsVUFBVSxFQUFFLG9EQUFvRDthQUNqRSxFQUNELEtBQWMsQ0FDZixDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3RCxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FDL0MsQ0FBQyxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUMsRUFBRSxFQUFFO1lBQ2hDLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBcUIsQ0FBQyxVQUFVLENBQ3ZELGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFDbEMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUNuRSxDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUM7UUFFRixNQUFNLGtCQUFrQixHQUFnQjtZQUN0QyxHQUFHLGFBQWE7WUFDaEI7OztlQUdHO1lBQ0gseUJBQXlCLEVBQUUsQ0FDekIsY0FBcUMsRUFDYixFQUFFLENBQUMsQ0FBQztnQkFDNUIsVUFBVSxFQUFFLEdBQUcsY0FBYyx3QkFBd0I7Z0JBQ3JELG9CQUFvQixFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUU7b0JBQ3ZDLE1BQU0sSUFBSSxHQUFHLHNCQUFzQixDQUFDLGNBQWMsQ0FBQzt3QkFDakQsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO3dCQUN6QyxDQUFDLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxJQUFJLENBQUM7b0JBQzNELElBQUksQ0FBQyxJQUFJLEVBQUU7d0JBQ1QsTUFBTSxJQUFJLGdCQUFnQixDQUFDLGtDQUFrQyxFQUFFOzRCQUM3RCxPQUFPLEVBQUUsK0JBQStCLGNBQWMsSUFBSTs0QkFDMUQsVUFBVSxFQUFFLDBHQUEwRzt5QkFDdkgsQ0FBQyxDQUFDO3FCQUNKO29CQUNELE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzVCLENBQUM7YUFDRixDQUFDO1lBQ0YsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDO1NBQy9CLENBQUM7UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDdEIsT0FBTyxrQkFBa0IsQ0FBQztTQUMzQjtRQUNELDhEQUE4RDtRQUM5RCxvRUFBb0U7UUFDcEUsMkZBQTJGO1FBQzNGLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFbkUsTUFBTSxxQkFBcUIsR0FDekIsOEJBQThCLENBQUMsNkJBQTZCLENBQUM7WUFDM0QsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLGNBQWMsQ0FBQyxFQUMxQixrQkFBa0IsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFVBQVU7U0FDbkQsQ0FBQyxDQUFDO1FBRUwsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsV0FBVyxDQUN2RSxnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLGdCQUFnQixFQUNyQixxQkFBcUIsRUFDckIsSUFBSSwyQkFBMkIsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUNsRSxDQUFDO1FBRUYsaUJBQWlCLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV0QyxPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLFFBQWdCLEVBQTRCLEVBQUU7SUFDNUUsT0FBTyxDQUNMLFFBQVEsS0FBSywwQkFBMEI7UUFDdkMsUUFBUSxLQUFLLDRCQUE0QixDQUMxQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUY7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsQ0FDeEIsS0FBdUIsRUFDUSxFQUFFO0FBQ2pDLHVFQUF1RTtBQUN2RSxJQUFJLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFBvbGljeSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHtcbiAgVXNlclBvb2wsXG4gIFVzZXJQb29sT3BlcmF0aW9uLFxuICBVc2VyUG9vbFNFU09wdGlvbnMsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IsIFRhZ05hbWUgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBBbXBsaWZ5QXV0aCxcbiAgQXV0aFByb3BzLFxuICBUcmlnZ2VyRXZlbnQsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9hdXRoLWNvbnN0cnVjdCc7XG5pbXBvcnQge1xuICBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUsXG4gIEF1dGhSZXNvdXJjZXMsXG4gIEF1dGhSb2xlTmFtZSxcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBGdW5jdGlvblJlc291cmNlcyxcbiAgR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSxcbiAgUmVzb3VyY2VQcm92aWRlcixcbiAgU3RhY2tQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICB0cmFuc2xhdGVUb0F1dGhDb25zdHJ1Y3RMb2dpbldpdGgsXG4gIHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdFNlbmRlcnMsXG59IGZyb20gJy4vdHJhbnNsYXRlX2F1dGhfcHJvcHMuanMnO1xuaW1wb3J0IHsgYXV0aEFjY2Vzc0J1aWxkZXIgYXMgX2F1dGhBY2Nlc3NCdWlsZGVyIH0gZnJvbSAnLi9hY2Nlc3NfYnVpbGRlci5qcyc7XG5pbXBvcnQgeyBBdXRoQWNjZXNzUG9saWN5QXJiaXRlckZhY3RvcnkgfSBmcm9tICcuL2F1dGhfYWNjZXNzX3BvbGljeV9hcmJpdGVyLmpzJztcbmltcG9ydCB7XG4gIEF1dGhBY2Nlc3NHZW5lcmF0b3IsXG4gIEF1dGhMb2dpbldpdGhGYWN0b3J5UHJvcHMsXG4gIEN1c3RvbUVtYWlsU2VuZGVyLFxuICBFeHBhbmQsXG59IGZyb20gJy4vdHlwZXMuanMnO1xuaW1wb3J0IHsgVXNlclBvb2xBY2Nlc3NQb2xpY3lGYWN0b3J5IH0gZnJvbSAnLi91c2VycG9vbF9hY2Nlc3NfcG9saWN5X2ZhY3RvcnkuanMnO1xuaW1wb3J0IHsgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5cbmV4cG9ydCB0eXBlIEJhY2tlbmRBdXRoID0gUmVzb3VyY2VQcm92aWRlcjxBdXRoUmVzb3VyY2VzPiAmXG4gIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5PEF1dGhSb2xlTmFtZSB8IHN0cmluZz4gJlxuICBTdGFja1Byb3ZpZGVyO1xuXG5leHBvcnQgdHlwZSBBbXBsaWZ5QXV0aFByb3BzID0gRXhwYW5kPFxuICBPbWl0PEF1dGhQcm9wcywgJ291dHB1dFN0b3JhZ2VTdHJhdGVneScgfCAnbG9naW5XaXRoJyB8ICdzZW5kZXJzJz4gJiB7XG4gICAgLyoqXG4gICAgICogU3BlY2lmeSBob3cgeW91IHdvdWxkIGxpa2UgdXNlcnMgdG8gbG9nIGluLiBZb3UgY2FuIGNob29zZSBmcm9tIGVtYWlsLCBwaG9uZSwgYW5kIGV2ZW4gZXh0ZXJuYWwgcHJvdmlkZXJzIHN1Y2ggYXMgTG9naW5XaXRoQW1hem9uLlxuICAgICAqL1xuICAgIGxvZ2luV2l0aDogRXhwYW5kPEF1dGhMb2dpbldpdGhGYWN0b3J5UHJvcHM+O1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBjdXN0b20gYXV0aCB0cmlnZ2Vyc1xuICAgICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmFtcGxpZnkuYXdzL3JlYWN0L2J1aWxkLWEtYmFja2VuZC9hdXRoL2N1c3RvbWl6ZS1hdXRoLWxpZmVjeWNsZS90cmlnZ2Vycy9cbiAgICAgKi9cbiAgICB0cmlnZ2Vycz86IFBhcnRpYWw8XG4gICAgICBSZWNvcmQ8XG4gICAgICAgIFRyaWdnZXJFdmVudCxcbiAgICAgICAgQ29uc3RydWN0RmFjdG9yeTxSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPj5cbiAgICAgID5cbiAgICA+O1xuICAgIC8qKlxuICAgICAqIENvbmZpZ3VyZSBhY2Nlc3MgdG8gYXV0aCBmb3Igb3RoZXIgQW1wbGlmeSByZXNvdXJjZXNcbiAgICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9yZWFjdC9idWlsZC1hLWJhY2tlbmQvYXV0aC9ncmFudC1hY2Nlc3MtdG8tYXV0aC1yZXNvdXJjZXMvXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiBhY2Nlc3M6IChhbGxvdykgPT4gW2FsbG93LnJlc291cmNlKHBvc3RDb25maXJtYXRpb24pLnRvKFtcImFkZFVzZXJUb0dyb3VwXCJdKV1cbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGFjY2VzczogKGFsbG93KSA9PiBbYWxsb3cucmVzb3VyY2UoZ3JvdXBNYW5hZ2VyKS50byhbXCJtYW5hZ2VHcm91cHNcIl0pXVxuICAgICAqL1xuICAgIGFjY2Vzcz86IEF1dGhBY2Nlc3NHZW5lcmF0b3I7XG4gICAgLyoqXG4gICAgICogQ29uZmlndXJlIGVtYWlsIHNlbmRlciBvcHRpb25zXG4gICAgICovXG4gICAgc2VuZGVycz86IHtcbiAgICAgIGVtYWlsOlxuICAgICAgICB8IFBpY2s8VXNlclBvb2xTRVNPcHRpb25zLCAnZnJvbUVtYWlsJyB8ICdmcm9tTmFtZScgfCAncmVwbHlUbyc+XG4gICAgICAgIHwgQ3VzdG9tRW1haWxTZW5kZXI7XG4gICAgfTtcbiAgfVxuPjtcblxuLyoqXG4gKiBTaW5nbGV0b24gZmFjdG9yeSBmb3IgQW1wbGlmeUF1dGggdGhhdCBjYW4gYmUgdXNlZCBpbiBBbXBsaWZ5IHByb2plY3QgZmlsZXMuXG4gKlxuICogRXhwb3J0ZWQgZm9yIHRlc3RpbmcgcHVycG9zZSBvbmx5ICYgc2hvdWxkIE5PVCBiZSBleHBvcnRlZCBvdXQgb2YgdGhlIHBhY2thZ2UuXG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QXV0aEZhY3RvcnkgaW1wbGVtZW50cyBDb25zdHJ1Y3RGYWN0b3J5PEJhY2tlbmRBdXRoPiB7XG4gIC8vIHB1YmxpY2x5IGFjY2Vzc2libGUgZm9yIHRlc3RpbmcgcHVycG9zZSBvbmx5LlxuICBzdGF0aWMgZmFjdG9yeUNvdW50ID0gMDtcblxuICByZWFkb25seSBwcm92aWRlcyA9ICdBdXRoUmVzb3VyY2VzJztcblxuICBwcml2YXRlIGdlbmVyYXRvcjogQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3I7XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgcHJvcGVydGllcyB0aGF0IHdpbGwgYmUgdXNlZCB0byBpbml0aWFsaXplIEFtcGxpZnlBdXRoXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBBbXBsaWZ5QXV0aFByb3BzLFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBhbXBsaWZ5LWJhY2tlbmQtcnVsZXMvcHJlZmVyLWFtcGxpZnktZXJyb3JzXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbXBvcnRTdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrXG4gICkge1xuICAgIGlmIChBbXBsaWZ5QXV0aEZhY3RvcnkuZmFjdG9yeUNvdW50ID4gMCkge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ011bHRpcGxlU2luZ2xldG9uUmVzb3VyY2VzRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgJ011bHRpcGxlIGBkZWZpbmVBdXRoYCBvciBgcmVmZXJlbmNlQXV0aGAgY2FsbHMgYXJlIG5vdCBhbGxvd2VkIHdpdGhpbiBhbiBBbXBsaWZ5IGJhY2tlbmQnLFxuICAgICAgICByZXNvbHV0aW9uOiAnUmVtb3ZlIGFsbCBidXQgb25lIGBkZWZpbmVBdXRoYCBvciBgcmVmZXJlbmNlQXV0aGAgY2FsbCcsXG4gICAgICB9KTtcbiAgICB9XG4gICAgQW1wbGlmeUF1dGhGYWN0b3J5LmZhY3RvcnlDb3VudCsrO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiBBbXBsaWZ5QXV0aFxuICAgKi9cbiAgZ2V0SW5zdGFuY2UgPSAoXG4gICAgZ2V0SW5zdGFuY2VQcm9wczogQ29uc3RydWN0RmFjdG9yeUdldEluc3RhbmNlUHJvcHNcbiAgKTogQmFja2VuZEF1dGggPT4ge1xuICAgIGNvbnN0IHsgY29uc3RydWN0Q29udGFpbmVyLCBpbXBvcnRQYXRoVmVyaWZpZXIsIHJlc291cmNlTmFtZVZhbGlkYXRvciB9ID1cbiAgICAgIGdldEluc3RhbmNlUHJvcHM7XG4gICAgaW1wb3J0UGF0aFZlcmlmaWVyPy52ZXJpZnkoXG4gICAgICB0aGlzLmltcG9ydFN0YWNrLFxuICAgICAgcGF0aC5qb2luKCdhbXBsaWZ5JywgJ2F1dGgnLCAncmVzb3VyY2UnKSxcbiAgICAgICdBbXBsaWZ5IEF1dGggbXVzdCBiZSBkZWZpbmVkIGluIGFtcGxpZnkvYXV0aC9yZXNvdXJjZS50cydcbiAgICApO1xuICAgIGlmICh0aGlzLnByb3BzLm5hbWUpIHtcbiAgICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcj8udmFsaWRhdGUodGhpcy5wcm9wcy5uYW1lKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgQW1wbGlmeUF1dGhHZW5lcmF0b3IodGhpcy5wcm9wcywgZ2V0SW5zdGFuY2VQcm9wcyk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBCYWNrZW5kQXV0aDtcbiAgfTtcbn1cblxuY2xhc3MgQW1wbGlmeUF1dGhHZW5lcmF0b3IgaW1wbGVtZW50cyBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvciB7XG4gIHJlYWRvbmx5IHJlc291cmNlR3JvdXBOYW1lOiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWUgPSAnYXV0aCc7XG4gIHByaXZhdGUgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEFtcGxpZnlBdXRoUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBnZXRJbnN0YW5jZVByb3BzOiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhBY2Nlc3NCdWlsZGVyID0gX2F1dGhBY2Nlc3NCdWlsZGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5ID0gbmV3IEF1dGhBY2Nlc3NQb2xpY3lBcmJpdGVyRmFjdG9yeSgpXG4gICkge1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJ2FtcGxpZnlBdXRoJztcbiAgfVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBzc21FbnZpcm9ubWVudEVudHJpZXNHZW5lcmF0b3IsXG4gICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICBjb25zdCBhdXRoUHJvcHM6IEF1dGhQcm9wcyA9IHtcbiAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICBsb2dpbldpdGg6IHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdExvZ2luV2l0aChcbiAgICAgICAgdGhpcy5wcm9wcy5sb2dpbldpdGgsXG4gICAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlclxuICAgICAgKSxcbiAgICAgIHNlbmRlcnM6IHRyYW5zbGF0ZVRvQXV0aENvbnN0cnVjdFNlbmRlcnMoXG4gICAgICAgIHRoaXMucHJvcHMuc2VuZGVycyxcbiAgICAgICAgdGhpcy5nZXRJbnN0YW5jZVByb3BzXG4gICAgICApLFxuICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiB0aGlzLmdldEluc3RhbmNlUHJvcHMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICAgIH07XG4gICAgaWYgKGF1dGhQcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMpIHtcbiAgICAgIGF1dGhQcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnMuZG9tYWluUHJlZml4ID1cbiAgICAgICAgc3RhYmxlQmFja2VuZElkZW50aWZpZXJzLmdldFN0YWJsZUJhY2tlbmRIYXNoKCk7XG4gICAgfVxuXG4gICAgbGV0IGF1dGhDb25zdHJ1Y3Q6IEFtcGxpZnlBdXRoO1xuICAgIHRyeSB7XG4gICAgICBhdXRoQ29uc3RydWN0ID0gbmV3IEFtcGxpZnlBdXRoKHNjb3BlLCB0aGlzLm5hbWUsIGF1dGhQcm9wcyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnQW1wbGlmeUF1dGhDb25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgYXV0aCBjb25zdHJ1Y3QnLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoYXV0aENvbnN0cnVjdCkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgdGhpcy5uYW1lKTtcblxuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMudHJpZ2dlcnMgfHwge30pLmZvckVhY2goXG4gICAgICAoW3RyaWdnZXJFdmVudCwgaGFuZGxlckZhY3RvcnldKSA9PiB7XG4gICAgICAgIChhdXRoQ29uc3RydWN0LnJlc291cmNlcy51c2VyUG9vbCBhcyBVc2VyUG9vbCkuYWRkVHJpZ2dlcihcbiAgICAgICAgICBVc2VyUG9vbE9wZXJhdGlvbi5vZih0cmlnZ2VyRXZlbnQpLFxuICAgICAgICAgIGhhbmRsZXJGYWN0b3J5LmdldEluc3RhbmNlKHRoaXMuZ2V0SW5zdGFuY2VQcm9wcykucmVzb3VyY2VzLmxhbWJkYVxuICAgICAgICApO1xuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBhdXRoQ29uc3RydWN0TWl4aW46IEJhY2tlbmRBdXRoID0ge1xuICAgICAgLi4uYXV0aENvbnN0cnVjdCxcbiAgICAgIC8qKlxuICAgICAgICogUmV0dXJucyBhIHJlc291cmNlQWNjZXNzQWNjZXB0b3IgZm9yIHRoZSBnaXZlbiByb2xlXG4gICAgICAgKiBAcGFyYW0gcm9sZUlkZW50aWZpZXIgRWl0aGVyIHRoZSBhdXRoIG9yIHVuYXV0aCByb2xlIG5hbWUgb3IgdGhlIG5hbWUgb2YgYSBVc2VyUG9vbCBncm91cFxuICAgICAgICovXG4gICAgICBnZXRSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yOiAoXG4gICAgICAgIHJvbGVJZGVudGlmaWVyOiBBdXRoUm9sZU5hbWUgfCBzdHJpbmdcbiAgICAgICk6IFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPT4gKHtcbiAgICAgICAgaWRlbnRpZmllcjogYCR7cm9sZUlkZW50aWZpZXJ9UmVzb3VyY2VBY2Nlc3NBY2NlcHRvcmAsXG4gICAgICAgIGFjY2VwdFJlc291cmNlQWNjZXNzOiAocG9saWN5OiBQb2xpY3kpID0+IHtcbiAgICAgICAgICBjb25zdCByb2xlID0gcm9sZU5hbWVJc0F1dGhSb2xlTmFtZShyb2xlSWRlbnRpZmllcilcbiAgICAgICAgICAgID8gYXV0aENvbnN0cnVjdC5yZXNvdXJjZXNbcm9sZUlkZW50aWZpZXJdXG4gICAgICAgICAgICA6IGF1dGhDb25zdHJ1Y3QucmVzb3VyY2VzLmdyb3Vwcz8uW3JvbGVJZGVudGlmaWVyXT8ucm9sZTtcbiAgICAgICAgICBpZiAoIXJvbGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkUmVzb3VyY2VBY2Nlc3NDb25maWdFcnJvcicsIHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYE5vIGF1dGggSUFNIHJvbGUgZm91bmQgZm9yIFwiJHtyb2xlSWRlbnRpZmllcn1cIi5gLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOiBgSWYgeW91IGFyZSB0cnlpbmcgdG8gY29uZmlndXJlIFVzZXJQb29sIGdyb3VwIGFjY2VzcywgZW5zdXJlIHRoYXQgdGhlIGdyb3VwIG5hbWUgaXMgc3BlY2lmaWVkIGNvcnJlY3RseS5gLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHBvbGljeS5hdHRhY2hUb1JvbGUocm9sZSk7XG4gICAgICAgIH0sXG4gICAgICB9KSxcbiAgICAgIHN0YWNrOiBTdGFjay5vZihhdXRoQ29uc3RydWN0KSxcbiAgICB9O1xuICAgIGlmICghdGhpcy5wcm9wcy5hY2Nlc3MpIHtcbiAgICAgIHJldHVybiBhdXRoQ29uc3RydWN0TWl4aW47XG4gICAgfVxuICAgIC8vIHByb3BzLmFjY2VzcyBpcyB0aGUgYWNjZXNzIGNhbGxiYWNrIGRlZmluZWQgYnkgdGhlIGN1c3RvbWVyXG4gICAgLy8gaGVyZSB3ZSBpbmplY3QgdGhlIGF1dGhBY2Nlc3NCdWlsZGVyIGludG8gdGhlIGNhbGxiYWNrIGFuZCBydW4gaXRcbiAgICAvLyB0aGlzIHByb2R1Y2VzIHRoZSBhY2Nlc3MgZGVmaW5pdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgdGhlIGF1dGggYWNjZXNzIHBvbGljaWVzXG4gICAgY29uc3QgYWNjZXNzRGVmaW5pdGlvbiA9IHRoaXMucHJvcHMuYWNjZXNzKHRoaXMuYXV0aEFjY2Vzc0J1aWxkZXIpO1xuXG4gICAgY29uc3Qgc3NtRW52aXJvbm1lbnRFbnRyaWVzID1cbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllc0dlbmVyYXRvci5nZW5lcmF0ZVNzbUVudmlyb25tZW50RW50cmllcyh7XG4gICAgICAgIFtgJHt0aGlzLm5hbWV9X1VTRVJQT09MX0lEYF06XG4gICAgICAgICAgYXV0aENvbnN0cnVjdE1peGluLnJlc291cmNlcy51c2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgfSk7XG5cbiAgICBjb25zdCBhdXRoUG9saWN5QXJiaXRlciA9IHRoaXMuYXV0aEFjY2Vzc1BvbGljeUFyYml0ZXJGYWN0b3J5LmdldEluc3RhbmNlKFxuICAgICAgYWNjZXNzRGVmaW5pdGlvbixcbiAgICAgIHRoaXMuZ2V0SW5zdGFuY2VQcm9wcyxcbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllcyxcbiAgICAgIG5ldyBVc2VyUG9vbEFjY2Vzc1BvbGljeUZhY3RvcnkoYXV0aENvbnN0cnVjdC5yZXNvdXJjZXMudXNlclBvb2wpXG4gICAgKTtcblxuICAgIGF1dGhQb2xpY3lBcmJpdGVyLmFyYml0cmF0ZVBvbGljaWVzKCk7XG5cbiAgICByZXR1cm4gYXV0aENvbnN0cnVjdE1peGluO1xuICB9O1xufVxuXG5jb25zdCByb2xlTmFtZUlzQXV0aFJvbGVOYW1lID0gKHJvbGVOYW1lOiBzdHJpbmcpOiByb2xlTmFtZSBpcyBBdXRoUm9sZU5hbWUgPT4ge1xuICByZXR1cm4gKFxuICAgIHJvbGVOYW1lID09PSAnYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlJyB8fFxuICAgIHJvbGVOYW1lID09PSAndW5hdXRoZW50aWNhdGVkVXNlcklhbVJvbGUnXG4gICk7XG59O1xuXG4vKipcbiAqIFByb3ZpZGUgdGhlIHNldHRpbmdzIHRoYXQgd2lsbCBiZSB1c2VkIGZvciBhdXRoZW50aWNhdGlvbi5cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmluZUF1dGggPSAoXG4gIHByb3BzOiBBbXBsaWZ5QXV0aFByb3BzXG4pOiBDb25zdHJ1Y3RGYWN0b3J5PEJhY2tlbmRBdXRoPiA9PlxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYW1wbGlmeS1iYWNrZW5kLXJ1bGVzL3ByZWZlci1hbXBsaWZ5LWVycm9yc1xuICBuZXcgQW1wbGlmeUF1dGhGYWN0b3J5KHByb3BzLCBuZXcgRXJyb3IoKS5zdGFjayk7XG4iXX0=